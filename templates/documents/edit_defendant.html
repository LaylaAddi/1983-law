{% extends 'base.html' %}

{% block title %}Edit Defendant - {{ document.title }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-pencil me-2"></i>Edit Defendant
                    </h5>
                </div>
                <div class="card-body">
                    {% if defendant.agency_inferred %}
                    <div class="alert alert-danger">
                        <h5 class="alert-heading"><i class="bi bi-exclamation-triangle-fill me-2"></i>Address Verification Required</h5>
                        <p class="mb-2">This defendant's information was suggested by AI. <strong>You must verify the address is correct</strong> before accepting.</p>
                        <hr>
                        <p class="mb-0 small">
                            <i class="bi bi-lightbulb me-1"></i>
                            <strong>Steps:</strong> 1) Use the "Lookup Address" button below to search for the correct address.
                            2) Verify it matches official records for serving legal documents.
                            3) Save changes, then return to confirm.
                        </p>
                    </div>
                    {% endif %}

                    {% if incident_overview and incident_overview.city %}
                    <div class="alert alert-info">
                        <i class="bi bi-geo-alt me-1"></i>
                        <strong>Location Context:</strong> {{ incident_overview.city }}{% if incident_overview.state %}, {{ incident_overview.state }}{% endif %}
                    </div>
                    {% endif %}

                    <form method="post" id="defendantForm">
                        {% csrf_token %}

                        {% for field in form %}
                            {% if field.name == 'address_verified' %}
                            <div class="mb-3 p-3 bg-light border rounded">
                                <div class="form-check">
                                    {{ field }}
                                    <label class="form-check-label fw-bold" for="{{ field.id_for_label }}">
                                        {{ field.label }} <span class="text-danger">*</span>
                                    </label>
                                </div>
                                <div class="form-text mt-2">
                                    <i class="bi bi-exclamation-triangle text-warning me-1"></i>
                                    This address will be used to serve legal documents. Incorrect addresses can result in case dismissal.
                                </div>
                                {% if field.errors %}
                                    <div class="text-danger small mt-1">{{ field.errors.0 }}</div>
                                {% endif %}
                            </div>
                            {% else %}
                            <div class="mb-3">
                                <label for="{{ field.id_for_label }}" class="form-label">
                                    {{ field.label }}
                                    {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {{ field }}
                                {% if field.help_text %}
                                    <div class="form-text">{{ field.help_text }}</div>
                                {% endif %}
                                {% if field.errors %}
                                    <div class="invalid-feedback d-block">{{ field.errors.0 }}</div>
                                {% endif %}
                            </div>
                            {% endif %}
                        {% endfor %}

                        <div class="d-flex gap-2 mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-lg me-1"></i>Save Changes
                            </button>
                            <button type="button" class="btn btn-outline-info" id="lookupAddressBtn" onclick="lookupInfo()">
                                <i class="bi bi-search me-1"></i>Find Agency & Address
                            </button>
                            <a href="{% url 'documents:section_edit' document.id 'defendants' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-1"></i>Cancel
                            </a>
                        </div>
                    </form>

                    <!-- Lookup result -->
                    <div id="lookupResult" class="mt-3" style="display: none;">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white py-2">
                                <i class="bi bi-check-circle-fill me-1"></i>Information Found
                            </div>
                            <div class="card-body">
                                <!-- Suggested agency (if returned) -->
                                <div id="agencyResult" style="display: none;" class="mb-3">
                                    <div class="d-flex align-items-start">
                                        <div class="flex-grow-1">
                                            <small class="text-muted d-block">Suggested Agency:</small>
                                            <strong id="foundAgency"></strong>
                                            <span class="badge bg-warning text-dark ms-2">AI Suggested</span>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-success ms-2" onclick="useAgency()">
                                            <i class="bi bi-check-lg me-1"></i>Use
                                        </button>
                                    </div>
                                </div>
                                <!-- Address result -->
                                <div id="addressResult">
                                    <div class="d-flex align-items-start">
                                        <div class="flex-grow-1">
                                            <small class="text-muted d-block">Address for Service:</small>
                                            <strong id="foundAddress"></strong>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-success ms-2" onclick="useAddress()">
                                            <i class="bi bi-check-lg me-1"></i>Use
                                        </button>
                                    </div>
                                </div>
                                <hr class="my-2">
                                <small class="text-muted" id="addressNote"></small>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-success" onclick="useBoth()">
                                        <i class="bi bi-check-lg me-1"></i>Use All Information
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let foundAddressValue = '';
let foundAgencyValue = '';

function lookupInfo() {
    const btn = document.getElementById('lookupAddressBtn');
    const resultDiv = document.getElementById('lookupResult');
    const agencyResultDiv = document.getElementById('agencyResult');
    const agencyField = document.querySelector('[name="agency_name"]');
    const nameField = document.querySelector('[name="name"]');
    const typeField = document.querySelector('[name="defendant_type"]');
    const titleField = document.querySelector('[name="title_rank"]');
    const descriptionField = document.querySelector('[name="description"]');

    // For agency defendants, use 'name' field; for individuals, use 'agency_name'
    let agencyName = '';
    let officerName = '';
    let officerTitle = '';
    let officerDescription = '';

    if (typeField && typeField.value === 'agency') {
        agencyName = nameField ? nameField.value.trim() : '';
    } else {
        // Individual officer
        agencyName = agencyField ? agencyField.value.trim() : '';
        officerName = nameField ? nameField.value.trim() : '';
        officerTitle = titleField ? titleField.value.trim() : '';
        officerDescription = descriptionField ? descriptionField.value.trim() : '';
    }

    // Disable button and show loading
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Searching...';
    resultDiv.style.display = 'none';
    agencyResultDiv.style.display = 'none';

    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch('{% url "documents:lookup_address" document.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({
            agency_name: agencyName,
            officer_name: officerName,
            officer_title: officerTitle,
            officer_description: officerDescription,
        })
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-search me-1"></i>Find Agency & Address';

        if (data.success && data.address) {
            // Update AI usage banner if info provided
            if (data.ai_usage_display) {
                const aiUsageDisplay = document.getElementById('aiUsageDisplay');
                if (aiUsageDisplay) {
                    aiUsageDisplay.textContent = data.ai_usage_display;
                }
            }

            foundAddressValue = data.address;
            foundAgencyValue = data.suggested_agency || '';

            // Show agency suggestion if returned
            if (data.suggested_agency) {
                document.getElementById('foundAgency').textContent = data.suggested_agency;
                agencyResultDiv.style.display = 'block';
            } else {
                agencyResultDiv.style.display = 'none';
            }

            document.getElementById('foundAddress').textContent = data.address;
            document.getElementById('addressNote').textContent = data.source_note || 'Found via web search. Please verify before filing.';
            resultDiv.style.display = 'block';
        } else if (data.limit_reached) {
            // Show upgrade modal for AI limit reached
            resultDiv.innerHTML = `
                <div class="alert alert-warning">
                    <div class="text-center">
                        <i class="bi bi-exclamation-triangle-fill text-warning" style="font-size: 2rem;"></i>
                        <h6 class="mt-2">AI Limit Reached</h6>
                        <p class="small mb-2">${data.error}</p>
                        <a href="/documents/{{ document.id }}/checkout/" class="btn btn-primary btn-sm">
                            <i class="bi bi-unlock me-1"></i>Upgrade Now
                        </a>
                    </div>
                </div>
            `;
            resultDiv.style.display = 'block';
        } else {
            alert(data.error || 'Could not find information. Please enter the agency name manually.');
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-search me-1"></i>Find Agency & Address';
        console.error('Error:', error);
        alert('Network error. Please try again.');
    });
}

function useAgency() {
    const typeField = document.querySelector('[name="defendant_type"]');
    let targetField;

    if (typeField && typeField.value === 'agency') {
        targetField = document.querySelector('[name="name"]');
    } else {
        targetField = document.querySelector('[name="agency_name"]');
    }

    if (targetField && foundAgencyValue) {
        targetField.value = foundAgencyValue;
        highlightField(targetField);
    }
}

function useAddress() {
    const addressField = document.querySelector('[name="address"]');
    if (addressField && foundAddressValue) {
        addressField.value = foundAddressValue;
        highlightField(addressField);
    }
}

function useBoth() {
    if (foundAgencyValue) {
        useAgency();
    }
    if (foundAddressValue) {
        useAddress();
    }
    document.getElementById('lookupResult').style.display = 'none';
}

function highlightField(field) {
    field.style.backgroundColor = '#d4edda';
    setTimeout(() => {
        field.style.backgroundColor = '';
    }, 1500);
}
</script>
{% endblock %}

{% extends 'base.html' %}
{% load static %}

{% block title %}{{ config.title }} - {{ document.title }} - {{ header_app_name }}{% endblock %}

{% block extra_css %}
{% if section.section_type == 'rights_violated' %}
<link rel="stylesheet" href="{% static 'css/rights-analyze.css' %}">
{% endif %}
{% if section.section_type in 'damages,rights_violated,evidence' %}
<link rel="stylesheet" href="{% static 'css/tell-story.css' %}">
{% endif %}
<style>
    .section-status-badge {
        font-size: 0.9rem;
    }
    .needs-work-highlight {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    /* Court district highlight box */
    .court-district-box {
        background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
        border: 2px solid #ff9800;
        border-radius: 0.5rem;
        padding: 1.25rem;
        margin: 1.5rem 0;
    }
    .court-district-box .box-header {
        color: #e65100;
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
    }
    .court-district-box .box-header i {
        font-size: 1.3rem;
        margin-right: 0.5rem;
    }
    .court-district-confirmation {
        background: #fff;
        border: 2px solid #dc3545;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-top: 1rem;
    }
    .court-district-confirmation.confirmed {
        border-color: #198754;
        background: #d1e7dd;
    }
    .court-district-confirmation label {
        font-weight: 600;
        color: #dc3545;
    }
    .court-district-confirmation.confirmed label {
        color: #198754;
    }
    .interview-card {
        border-left: 4px solid #0d6efd;
    }
    .interview-card.needs-work {
        border-left-color: #ffc107;
        background-color: #fffbf0;
    }
    .interview-card.completed {
        border-left-color: #198754;
    }
    .interview-card.not-applicable {
        border-left-color: #6c757d;
        background-color: #f8f9fa;
    }
    /* Help section styles */
    .help-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
    }
    .help-section .card-header {
        background: transparent;
        border-bottom: none;
        cursor: pointer;
    }
    .help-section .card-header:hover {
        background: rgba(0,0,0,0.02);
    }
    .help-section .help-icon {
        background: #0d6efd;
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.5rem;
    }
    .help-tips {
        background: white;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-top: 0.5rem;
    }
    .help-tips li {
        margin-bottom: 0.5rem;
    }
    .help-tips li:last-child {
        margin-bottom: 0;
    }
    .help-example {
        background: #e7f1ff;
        border-left: 3px solid #0d6efd;
        padding: 1rem;
        margin-top: 1rem;
        border-radius: 0 0.375rem 0.375rem 0;
    }
    .amendment-card {
        background: white;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 0.75rem;
    }
    .amendment-card h6 {
        color: #0d6efd;
        margin-bottom: 0.5rem;
    }
    /* Tooltip styles */
    .field-tooltip {
        color: #6c757d;
        cursor: help;
        margin-left: 0.25rem;
    }
    .field-tooltip:hover {
        color: #0d6efd;
    }
    /* Relief type cards */
    .relief-type {
        background: #f8f9fa;
        border-radius: 0.375rem;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
    }
    .relief-type strong {
        color: #0d6efd;
    }
    /* Attorney fields section */
    .attorney-section {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 1.25rem;
        margin-top: 1rem;
        margin-bottom: 1rem;
    }
    .attorney-section-header {
        color: #495057;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #dee2e6;
    }
    .attorney-section-header i {
        color: #0d6efd;
    }
    .attorney-field {
        /* Used to identify attorney fields for show/hide */
    }
</style>
{% endblock %}

{% block content %}
{% include 'documents/partials/status_banner.html' %}

<!-- Top Navigation -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <nav aria-label="breadcrumb" class="mb-0">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{% url 'documents:document_list' %}">Documents</a></li>
            <li class="breadcrumb-item"><a href="{% url 'documents:document_detail' document.id %}">{{ document.title|truncatechars:30 }}</a></li>
            <li class="breadcrumb-item active">{{ config.title }}</li>
        </ol>
    </nav>
    <a href="{% url 'documents:document_detail' document.id %}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left me-1"></i>Back to Document
    </a>
</div>

<div class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
        <!-- Help Section (Collapsible) -->
        {% if help_content %}
        <div class="card help-section">
            <div class="card-header" data-bs-toggle="collapse" data-bs-target="#helpContent" aria-expanded="false">
                <div class="d-flex justify-content-between align-items-center">
                    <span>
                        <span class="help-icon"><i class="bi bi-question-lg"></i></span>
                        <strong>Learn More About This Section</strong>
                    </span>
                    <i class="bi bi-chevron-down" id="helpChevron"></i>
                </div>
            </div>
            <div class="collapse" id="helpContent">
                <div class="card-body pt-0">
                    <!-- Overview -->
                    {% if help_content.overview %}
                    <div class="mb-3">
                        {{ help_content.overview|safe }}
                    </div>
                    {% endif %}

                    <!-- Why Important -->
                    {% if help_content.why_important %}
                    <div class="mb-3">
                        {{ help_content.why_important|safe }}
                    </div>
                    {% endif %}

                    <!-- Recommended Note (for relief_sought section) -->
                    {% if help_content.recommended_note %}
                    <div class="mb-3">
                        {{ help_content.recommended_note|safe }}
                    </div>
                    {% endif %}

                    <!-- Tips -->
                    {% if help_content.tips %}
                    <div class="help-tips">
                        <strong><i class="bi bi-lightbulb me-2"></i>Tips:</strong>
                        <ul class="mb-0 mt-2">
                            {% for tip in help_content.tips %}
                            <li>{{ tip|safe }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <!-- Simple Explanations / FAQ (for relief_sought section) -->
                    {% if help_content.simple_explanations %}
                    <div class="mt-3">
                        <strong><i class="bi bi-question-circle me-2"></i>Common Questions:</strong>
                        <div class="accordion mt-2" id="faqAccordion">
                            {% for faq in help_content.simple_explanations %}
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#faq{{ forloop.counter }}">
                                        {{ faq.question }}
                                    </button>
                                </h2>
                                <div id="faq{{ forloop.counter }}" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                    <div class="accordion-body small">
                                        {{ faq.answer|safe }}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Amendment Info (for rights_violated section) -->
                    {% if help_content.amendments %}
                    <div class="mt-3">
                        <strong><i class="bi bi-book me-2"></i>Understanding Your Rights:</strong>
                        <div class="mt-2">
                            {% for key, amendment in help_content.amendments.items %}
                            <div class="amendment-card">
                                <h6>{{ amendment.name }}</h6>
                                <p class="mb-2"><strong>Protects:</strong> {{ amendment.protects }}</p>
                                <p class="mb-1"><strong>Common Violations:</strong></p>
                                <ul class="mb-0 small">
                                    {% for violation in amendment.common_violations %}
                                    <li>{{ violation }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Relief Types (for relief_sought section) - removed, replaced by simple_explanations -->
                    {% if help_content.types_of_relief %}
                    <div class="mt-3">
                        <strong><i class="bi bi-currency-dollar me-2"></i>Types of Relief Explained:</strong>
                        <div class="mt-2">
                            {% for key, relief in help_content.types_of_relief.items %}
                            <div class="relief-type">
                                <strong>{{ relief.name }}:</strong>
                                <span class="small">{{ relief.description }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Example -->
                    {% if help_content.example %}
                    <div class="help-example">
                        {{ help_content.example|safe }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <div class="card interview-card {% if section.status == 'needs_work' %}needs-work{% elif section.status == 'completed' %}completed{% elif section.status == 'not_applicable' %}not-applicable{% endif %} shadow-sm mb-4">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">{{ config.title }}</h4>

                    {% if section.status == 'not_started' %}
                        <span class="badge bg-secondary section-status-badge">Not Started</span>
                    {% elif section.status == 'in_progress' %}
                        <span class="badge bg-info section-status-badge">In Progress</span>
                    {% elif section.status == 'needs_work' %}
                        <span class="badge bg-warning text-dark section-status-badge">
                            <i class="bi bi-exclamation-triangle me-1"></i>Needs Work
                        </span>
                    {% elif section.status == 'completed' %}
                        <span class="badge bg-success section-status-badge">
                            <i class="bi bi-check-lg me-1"></i>Completed
                        </span>
                    {% elif section.status == 'not_applicable' %}
                        <span class="badge bg-secondary section-status-badge">
                            <i class="bi bi-dash-lg me-1"></i>N/A
                        </span>
                    {% endif %}
                </div>
            </div>

            <div class="card-body">
                {% if section.status == 'needs_work' and section.notes %}
                    <div class="needs-work-highlight">
                        <strong><i class="bi bi-exclamation-triangle me-2"></i>Notes:</strong>
                        {{ section.notes }}
                    </div>
                {% endif %}

                <p class="text-muted mb-4">{{ config.description }}</p>

                {% if section.section_type == 'witnesses' or section.section_type == 'evidence' or section.section_type == 'prior_complaints' %}
                    {% if section.status != 'not_applicable' and not items %}
                    <div class="alert alert-light border mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-info-circle text-muted me-2"></i>
                                <span class="text-muted">If this section doesn't apply to your case, you can mark it as not applicable.</span>
                            </div>
                            <form method="post" action="{% url 'documents:update_section_status' document.id section.section_type %}" class="d-inline">
                                {% csrf_token %}
                                <input type="hidden" name="status" value="not_applicable">
                                <button type="submit" class="btn btn-outline-secondary btn-sm">
                                    <i class="bi bi-dash-circle me-1"></i>Mark as N/A
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endif %}
                {% endif %}

                {% if section.section_type == 'plaintiff_info' and is_profile_based %}
                <!-- Profile Data Display (Read-only) -->
                <div class="card bg-light mb-4">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-person-check-fill me-2"></i>Your Information (from Profile)</span>
                        <a href="{% url 'accounts:profile_edit' %}?next={{ request.path }}" class="btn btn-light btn-sm">
                            <i class="bi bi-pencil me-1"></i>Edit Profile
                        </a>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-muted mb-2">Name</h6>
                                <p class="mb-3">
                                    <strong>{{ user_profile.get_full_name }}</strong>
                                </p>

                                <h6 class="text-muted mb-2">Address</h6>
                                <p class="mb-3">
                                    {{ user_profile.street_address }}<br>
                                    {{ user_profile.city }}, {{ user_profile.state }} {{ user_profile.zip_code }}
                                </p>

                                {% if user_profile.use_different_mailing_address %}
                                <h6 class="text-muted mb-2">Mailing Address</h6>
                                <p class="mb-3">
                                    {{ user_profile.mailing_street_address }}<br>
                                    {{ user_profile.mailing_city }}, {{ user_profile.mailing_state }} {{ user_profile.mailing_zip_code }}
                                </p>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted mb-2">Phone</h6>
                                <p class="mb-3">{{ user_profile.phone }}</p>

                                <h6 class="text-muted mb-2">Email</h6>
                                <p class="mb-3">{{ user_profile.email }}</p>
                            </div>
                        </div>
                        <div class="alert alert-info mb-0 small">
                            <i class="bi bi-info-circle me-1"></i>
                            This information will appear on your legal documents exactly as shown. To make changes, click "Edit Profile" above.
                        </div>
                    </div>
                </div>

                <hr class="my-4">
                <h5 class="mb-3"><i class="bi bi-briefcase me-2"></i>Legal Representation</h5>
                <p class="text-muted mb-3">Are you representing yourself (pro se) or do you have an attorney?</p>
                {% endif %}


                {% if section.section_type == 'rights_violated' %}
                <!-- First-time user guide (dismissible) -->
                <div class="alert alert-light alert-dismissible mb-4" id="rightsGuide" style="display: none; border-left: 4px solid #0d6efd; background-color: #f8f9fa; border: 1px solid #dee2e6;">
                    <button type="button" class="btn-close" aria-label="Close" onclick="dismissRightsGuide()"></button>
                    <h6 class="alert-heading text-dark"><i class="bi bi-lightbulb-fill text-warning me-2"></i><strong>Please Read:</strong> How This Works</h6>
                    <ol class="mb-3" style="color: #212529; font-size: 0.95rem; line-height: 1.6;">
                        <li class="mb-2"><strong>Click "Analyze My Case"</strong> below to let AI identify which constitutional rights may have been violated based on your story.</li>
                        <li class="mb-2"><strong>Review the suggestions</strong> — AI will explain why each amendment might apply to your situation.</li>
                        <li class="mb-2"><strong>Check the boxes</strong> for rights that apply, and add details in the text fields.</li>
                        <li class="mb-2" style="background-color: #d4edda; padding: 8px 12px; border-radius: 4px; margin-left: -12px; padding-left: 24px;"><strong style="color: #155724;">Pro tip:</strong> <span style="color: #155724;">Click <strong>"Copy to Details"</strong> to automatically copy AI's explanation into the details field — then edit it to match your specific situation!</span></li>
                    </ol>
                    <hr class="my-2">
                    <p class="mb-0 small" style="color: #6c757d;"><i class="bi bi-info-circle me-1"></i>This guide won't show again after you dismiss it.</p>
                </div>
                <script>
                (function() {
                    const guideKey = 'rightsGuide_dismissed_{{ document.id }}';
                    const guide = document.getElementById('rightsGuide');
                    if (guide && !localStorage.getItem(guideKey)) {
                        guide.style.display = 'block';
                    }
                    window.dismissRightsGuide = function() {
                        localStorage.setItem(guideKey, 'true');
                        guide.style.display = 'none';
                    };
                })();
                </script>

                <!-- AI Analysis for Rights Violated -->
                {% if section.status == 'completed' or section.status == 'in_progress' %}
                <div class="alert alert-success mb-4">
                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                        <div>
                            <strong><i class="bi bi-check-circle me-2"></i>Rights analyzed based on your story</strong>
                            <p class="mb-0 small">Review the selections below and adjust if needed. You can also re-analyze for fresh suggestions.</p>
                        </div>
                        <button type="button" class="btn btn-outline-success btn-sm" id="analyzeRightsBtn" data-document-id="{{ document.id }}">
                            <i class="bi bi-arrow-repeat me-1"></i>Re-analyze
                        </button>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-primary mb-4">
                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                        <div>
                            <strong><i class="bi bi-stars me-2"></i>Not sure which rights were violated?</strong>
                            <p class="mb-0 small">Let AI analyze your incident and suggest which constitutional rights apply to your case.</p>
                        </div>
                        <button type="button" class="btn btn-primary btn-sm" id="analyzeRightsBtn" data-document-id="{{ document.id }}">
                            <i class="bi bi-search me-1"></i>Analyze My Case
                        </button>
                    </div>
                </div>
                {% endif %}
                <div id="rightsAnalysisContainer"></div>
                {% endif %}

                {% if is_multiple %}
                    <!-- Multiple items section (defendants, witnesses, evidence) -->
                    <div class="alert alert-info mb-4">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-info-circle-fill me-2 mt-1"></i>
                            <div>
                                <strong>You can add multiple entries here.</strong>
                                <p class="mb-0 small">
                                    {% if section.section_type == 'defendants' %}
                                        Add each officer and agency separately. For example, if two officers from different departments violated your rights, add all four entries: both individual officers AND both agencies.
                                    {% elif section.section_type == 'witnesses' %}
                                        Add each witness who saw or heard what happened. Include bystanders, fellow auditors, or anyone who can support your account.
                                    {% elif section.section_type == 'evidence' %}
                                        Add each piece of evidence separately - your video, body camera footage, police reports, medical records, etc.
                                        {% if can_use_video_analysis %}<br><strong class="text-danger"><i class="bi bi-youtube me-1"></i>YouTube Videos:</strong> Add as "Video Recording" then click "Link Video" to attach a YouTube URL and extract transcripts.{% endif %}
                                    {% else %}
                                        Fill out the form below and click "Add" to save each entry. You can add as many as needed.
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>

                    {% if section.section_type == 'evidence' and can_use_video_analysis %}
                    <!-- Quick Add YouTube Video Card for Subscribers -->
                    <div class="card border-danger mb-4" id="quickAddYouTubeCard">
                        <div class="card-header bg-danger text-white py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-youtube me-2"></i>Quick Add YouTube Video</span>
                                <button type="button" class="btn btn-sm btn-outline-light" id="dismissYouTubeCard" title="Dismiss">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="small text-muted mb-3">
                                Have YouTube video evidence (body cam, personal recording, news footage)?
                                Add it here to extract and analyze the transcript.
                            </p>
                            <div class="input-group">
                                <input type="url" class="form-control" id="quickYouTubeUrl" placeholder="https://www.youtube.com/watch?v=...">
                                <button type="button" class="btn btn-danger" id="quickAddYouTubeBtn">
                                    <i class="bi bi-plus-lg me-1"></i>Add Video Evidence
                                </button>
                            </div>
                            <div id="quickYouTubeError" class="alert alert-danger mt-2 d-none small"></div>
                            <div id="quickYouTubeSuccess" class="alert alert-success mt-2 d-none small">
                                <i class="bi bi-check-circle me-1"></i>Video evidence added! Redirecting...
                            </div>
                        </div>
                    </div>

                    <!-- Analyze Video Evidence Card -->
                    <div class="card border-info mb-4" id="analyzeVideoCard">
                        <div class="card-header bg-info text-white py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-robot me-2"></i>AI: Analyze Video Evidence</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="small text-muted mb-3">
                                Let AI analyze your video transcripts and suggest additions to your complaint.
                                Suggestions include timestamps and direct quotes for your legal document.
                            </p>
                            <button type="button" class="btn btn-info text-white" id="analyzeVideoBtn">
                                <i class="bi bi-play-circle me-1"></i>Analyze Video Transcripts
                            </button>
                            <div id="analyzeVideoLoading" class="mt-3 d-none">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm text-info me-2" role="status"></div>
                                    <span>Analyzing transcripts...</span>
                                </div>
                            </div>
                            <div id="analyzeVideoError" class="alert alert-danger mt-3 d-none"></div>
                        </div>
                    </div>

                    <!-- Video Analysis Suggestions Panel -->
                    <div class="card border-success mb-4 d-none" id="videoSuggestionsPanel">
                        <div class="card-header bg-success text-white py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-lightbulb me-2"></i>Video Evidence Suggestions</span>
                                <button type="button" class="btn btn-sm btn-outline-light" id="closeSuggestionsPanel">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="videoSuggestionsSummary" class="alert alert-info mb-3"></div>
                            <div id="videoSuggestionsList"></div>
                            <p class="small text-muted mt-3 mb-0">
                                <i class="bi bi-info-circle me-1"></i>Click "Apply" to add a suggestion to that section. You can edit the text after applying.
                            </p>
                        </div>
                    </div>
                    {% endif %}

                        <div class="mb-4 {% if not items %}d-none{% endif %}" id="defendantsListContainer">
                            <h5 id="defendantsListHeader">
                                {% if section.section_type == 'defendants' %}
                                <i class="bi bi-people me-2"></i>Current Defendants ({{ items|length }})
                                {% elif section.section_type == 'witnesses' %}
                                <i class="bi bi-eye me-2"></i>Current Witnesses ({{ items|length }})
                                {% else %}
                                <i class="bi bi-list me-2"></i>Added Items ({{ items|length }})
                                {% endif %}
                            </h5>
                            <div class="list-group mb-3" id="defendantsList">
                                {% for item in items %}
                                    <div class="list-group-item {% if section.section_type == 'defendants' and item.defendant_type == 'individual' and not item.agency_name %}list-group-item-danger{% elif section.section_type == 'defendants' and item.agency_inferred %}list-group-item-warning{% elif section.section_type == 'witnesses' and item.has_evidence %}list-group-item-success{% endif %}">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <strong>{{ item }}</strong>
                                                {% if section.section_type == 'defendants' and item.title_rank %}
                                                <span class="text-muted">({{ item.title_rank }})</span>
                                                {% endif %}
                                                {% if section.section_type == 'defendants' and item.defendant_type == 'individual' and not item.agency_name %}
                                                <br><small class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>Missing agency - required for proper service</small>
                                                {% elif section.section_type == 'defendants' and item.agency_inferred %}
                                                <br><small class="text-warning"><i class="bi bi-robot me-1"></i>AI-suggested - <strong>you must verify the address before accepting</strong></small>
                                                {% endif %}
                                                {% if section.section_type == 'defendants' and item.agency_name %}
                                                <br><small class="text-muted"><i class="bi bi-building me-1"></i>{{ item.agency_name }}</small>
                                                {% endif %}
                                                {% if section.section_type == 'defendants' %}
                                                    {% if item.address %}
                                                <br><small class="text-success"><i class="bi bi-geo-alt-fill me-1"></i>{{ item.address }}</small>
                                                    {% else %}
                                                <br><small class="text-danger"><i class="bi bi-geo-alt me-1"></i><strong>Address needed</strong> - Click "Edit" → "Lookup Address" to find the official address</small>
                                                    {% endif %}
                                                {% endif %}
                                                {% if section.section_type == 'witnesses' %}
                                                    {% if item.relationship %}
                                                    <br><small class="text-muted"><i class="bi bi-person-lines-fill me-1"></i>{{ item.relationship }}</small>
                                                    {% endif %}
                                                    {% if item.has_evidence %}
                                                    <br><small class="text-success"><i class="bi bi-camera-video me-1"></i>Has video/photo evidence</small>
                                                    {% endif %}
                                                    {% if item.prior_interactions %}
                                                    <br><small class="text-info"><i class="bi bi-clock-history me-1"></i>Has prior interactions with defendant(s)</small>
                                                    {% endif %}
                                                    {% if item.willing_to_testify %}
                                                    <br><small class="text-success"><i class="bi bi-check-circle me-1"></i>Willing to testify</small>
                                                    {% endif %}
                                                {% endif %}
                                                {% if section.section_type == 'evidence' %}
                                                    {% if item.date_created %}
                                                    <br><small class="text-muted"><i class="bi bi-calendar me-1"></i>{{ item.date_created }}</small>
                                                    {% endif %}
                                                    {% if item.location_obtained %}
                                                    <br><small class="text-muted"><i class="bi bi-geo-alt me-1"></i>{{ item.location_obtained }}</small>
                                                    {% else %}
                                                    <br><small class="text-muted"><i class="bi bi-geo-alt me-1"></i>No location set</small>
                                                    {% endif %}
                                                    {% if not item.is_in_possession %}
                                                    <br><small class="text-info"><i class="bi bi-hourglass me-1"></i>Not yet in possession</small>
                                                    {% endif %}

                                                    {% comment %} YouTube Video Evidence Integration {% endcomment %}
                                                    {% with video_evidence=item.video_evidence %}
                                                    {% if video_evidence %}
                                                    <div class="mt-2 pt-2 border-top">
                                                        <span class="badge bg-danger me-1"><i class="bi bi-youtube me-1"></i>YouTube</span>
                                                        {% if video_evidence.video_title %}
                                                        <small class="text-muted">{{ video_evidence.video_title|truncatechars:40 }}</small>
                                                        {% endif %}
                                                        {% with clips_count=video_evidence.captures.count %}
                                                        {% if clips_count > 0 %}
                                                        <br><small class="text-success"><i class="bi bi-chat-quote me-1"></i>{{ clips_count }} clip{{ clips_count|pluralize }} transcribed</small>
                                                        {% comment %} Expandable transcript preview {% endcomment %}
                                                        <div class="mt-2">
                                                            <a class="small text-decoration-none" data-bs-toggle="collapse" href="#transcriptPreview{{ item.id }}" role="button" aria-expanded="false">
                                                                <i class="bi bi-chevron-down me-1"></i>Show transcript preview
                                                            </a>
                                                            <div class="collapse mt-2" id="transcriptPreview{{ item.id }}">
                                                                <div class="card card-body small py-2 px-3" style="max-height: 150px; overflow-y: auto; font-size: 0.85rem;">
                                                                    {% for capture in video_evidence.captures.all %}
                                                                    {% if capture.extraction_status == 'completed' %}
                                                                    <div class="mb-2 pb-2 {% if not forloop.last %}border-bottom{% endif %}">
                                                                        <span class="badge bg-secondary me-1">{{ capture.start_time_display }} - {{ capture.end_time_display }}</span>
                                                                        <p class="mb-0 mt-1 text-muted" style="white-space: pre-wrap;">{{ capture.attributed_transcript|default:capture.raw_transcript|truncatechars:200 }}</p>
                                                                    </div>
                                                                    {% endif %}
                                                                    {% empty %}
                                                                    <p class="mb-0 text-muted">No completed transcripts yet.</p>
                                                                    {% endfor %}
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {% else %}
                                                        <br><small class="text-warning"><i class="bi bi-exclamation-circle me-1"></i>No transcripts yet</small>
                                                        {% endif %}
                                                        {% endwith %}
                                                    </div>
                                                    {% elif item.evidence_type == 'video' and can_use_video_analysis %}
                                                    <div class="mt-2 pt-2 border-top">
                                                        <small class="text-muted"><i class="bi bi-youtube me-1"></i>No YouTube video linked</small>
                                                    </div>
                                                    {% endif %}
                                                    {% endwith %}
                                                {% endif %}
                                            </div>
                                            <div class="d-flex gap-2">
                                                {% if section.section_type == 'defendants' %}
                                                {% if item.agency_inferred %}
                                                <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#verifyModal{{ item.id }}" title="Verify address and accept">
                                                    <i class="bi bi-search me-1"></i>Verify & Accept
                                                </button>
                                                <!-- Verification Modal -->
                                                <div class="modal fade" id="verifyModal{{ item.id }}" tabindex="-1" aria-labelledby="verifyModalLabel{{ item.id }}" aria-hidden="true">
                                                    <div class="modal-dialog">
                                                        <div class="modal-content">
                                                            <div class="modal-header bg-warning">
                                                                <h5 class="modal-title" id="verifyModalLabel{{ item.id }}">
                                                                    <i class="bi bi-exclamation-triangle me-2"></i>Address Verification Required
                                                                </h5>
                                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                            </div>
                                                            <div class="modal-body">
                                                                <div class="alert alert-warning mb-3">
                                                                    <i class="bi bi-info-circle me-1"></i>
                                                                    <strong>Important:</strong> For your lawsuit to be properly served, you must verify the correct official address for this defendant.
                                                                </div>

                                                                <div class="mb-3">
                                                                    <strong>Defendant:</strong> {{ item.name }}
                                                                    {% if item.agency_name %}<br><small class="text-muted">Agency: {{ item.agency_name }}</small>{% endif %}
                                                                </div>

                                                                <div class="mb-3 p-3 bg-light rounded">
                                                                    <strong><i class="bi bi-geo-alt me-1"></i>Current Address:</strong>
                                                                    <p class="mb-0 mt-1">{% if item.address %}{{ item.address }}{% else %}<em class="text-danger">No address entered</em>{% endif %}</p>
                                                                </div>

                                                                <div class="alert alert-info">
                                                                    <i class="bi bi-lightbulb me-1"></i>
                                                                    <strong>How to verify:</strong>
                                                                    <ol class="mb-0 mt-2">
                                                                        <li>Click <strong>Edit</strong> to open the defendant form</li>
                                                                        <li>Use the <strong>Lookup Address</strong> button to search</li>
                                                                        <li>Confirm the address matches official records</li>
                                                                    </ol>
                                                                </div>

                                                                <form method="post" action="{% url 'documents:accept_defendant_agency' document.id item.id %}" id="verifyForm{{ item.id }}">
                                                                    {% csrf_token %}
                                                                    <div class="form-check mt-3 p-3 border rounded bg-light">
                                                                        <input class="form-check-input" type="checkbox" id="verifyCheck{{ item.id }}" onchange="toggleAcceptBtn{{ item.id }}(this)">
                                                                        <label class="form-check-label" for="verifyCheck{{ item.id }}">
                                                                            <strong>I confirm that I have verified the address is correct for serving legal documents to this defendant.</strong>
                                                                        </label>
                                                                    </div>
                                                                </form>
                                                            </div>
                                                            <div class="modal-footer">
                                                                <a href="{% url 'documents:edit_defendant' document.id item.id %}" class="btn btn-primary">
                                                                    <i class="bi bi-pencil me-1"></i>Edit Defendant
                                                                </a>
                                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                                <button type="submit" form="verifyForm{{ item.id }}" class="btn btn-success" id="acceptBtn{{ item.id }}" disabled>
                                                                    <i class="bi bi-check-lg me-1"></i>Accept & Confirm
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <script>
                                                function toggleAcceptBtn{{ item.id }}(checkbox) {
                                                    document.getElementById('acceptBtn{{ item.id }}').disabled = !checkbox.checked;
                                                }
                                                </script>
                                                {% endif %}
                                                <a href="{% url 'documents:edit_defendant' document.id item.id %}"
                                                   class="btn btn-primary btn-sm">
                                                    <i class="bi bi-pencil me-1"></i>Edit
                                                </a>
                                                {% elif section.section_type == 'witnesses' %}
                                                <a href="{% url 'documents:edit_witness' document.id item.id %}"
                                                   class="btn btn-primary btn-sm">
                                                    <i class="bi bi-pencil me-1"></i>Edit
                                                </a>
                                                {% elif section.section_type == 'evidence' %}
                                                {% with video_evidence=item.video_evidence %}
                                                {% if video_evidence %}
                                                <a href="{% url 'documents:video_analysis' document.id %}#video-{{ video_evidence.id }}"
                                                   class="btn btn-danger btn-sm" title="View/Edit Transcript">
                                                    <i class="bi bi-youtube me-1"></i>Transcript
                                                </a>
                                                {% elif item.evidence_type == 'video' and can_use_video_analysis %}
                                                <button type="button" class="btn btn-outline-danger btn-sm link-youtube-btn"
                                                        data-evidence-id="{{ item.id }}"
                                                        data-evidence-title="{{ item.title }}"
                                                        data-bs-toggle="modal" data-bs-target="#linkYouTubeModal"
                                                        title="Link YouTube Video">
                                                    <i class="bi bi-youtube me-1"></i>Link Video
                                                </button>
                                                {% endif %}
                                                {% endwith %}
                                                <a href="{% url 'documents:edit_evidence' document.id item.id %}"
                                                   class="btn btn-primary btn-sm">
                                                    <i class="bi bi-pencil me-1"></i>Edit
                                                </a>
                                                {% endif %}
                                                <a href="{% url 'documents:delete_multiple_item' document.id section.section_type item.id %}"
                                                   class="btn btn-outline-danger btn-sm"
                                                   onclick="return confirm('Delete this {{ section.section_type|slice:':-1' }}?')">
                                                    <i class="bi bi-trash"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                    <h5><i class="bi bi-plus-circle me-2"></i>{% if section.section_type == 'defendants' %}Add New Defendant{% elif section.section_type == 'witnesses' %}Add New Witness{% else %}Add New{% endif %}</h5>
                    <form method="post" action="{% url 'documents:add_multiple_item' document.id section.section_type %}">
                        {% csrf_token %}
                        {% for field in form %}
                            <div class="mb-3">
                                <label for="{{ field.id_for_label }}" class="form-label">
                                    {{ field.label }}
                                    {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                                    {% with field_help=help_content.fields %}
                                        {% if field_help %}
                                            {% with tooltip=field_help|default_if_none:"" %}
                                                {% for fname, fdata in field_help.items %}
                                                    {% if fname == field.name and fdata.tooltip %}
                                                        <i class="bi bi-info-circle field-tooltip"
                                                           data-bs-toggle="tooltip"
                                                           data-bs-placement="top"
                                                           title="{{ fdata.tooltip }}"></i>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endwith %}
                                        {% endif %}
                                    {% endwith %}
                                </label>
                                {{ field }}
                                {% if help_content.fields %}
                                    {% for fname, fdata in help_content.fields.items %}
                                        {% if fname == field.name and fdata.help %}
                                            <div class="form-text">{{ fdata.help|safe }}</div>
                                        {% endif %}
                                    {% endfor %}
                                {% elif field.help_text %}
                                    <div class="form-text">{{ field.help_text }}</div>
                                {% endif %}
                                {% if field.errors %}
                                    <div class="invalid-feedback d-block">{{ field.errors.0 }}</div>
                                {% endif %}
                            </div>
                        {% endfor %}
                        {% if section.section_type == 'defendants' %}
                        <div class="d-flex gap-2 flex-wrap">
                            <button type="button" class="btn btn-success" id="saveDefendantBtn" onclick="saveDefendantAjax()">
                                <i class="bi bi-plus-lg me-1"></i>Save Defendant
                            </button>
                            <button type="button" class="btn btn-info text-white" id="suggestAgencyBtn" onclick="suggestAgency()">
                                <i class="bi bi-robot me-1"></i>AI Suggest Defendants
                            </button>
                        </div>
                        <div id="saveDefendantFeedback" class="mt-2" style="display: none;"></div>
                        <small class="text-muted mt-2 d-block">Fill in the form manually, or click "AI Suggest Defendants" to get suggestions for both the agency and individual officers.</small>
                        <!-- Agency suggestions container -->
                        <div id="agencySuggestions" class="mt-3" style="display: none;">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white py-2">
                                    <i class="bi bi-lightbulb me-1"></i>Agency Suggestions
                                </div>
                                <div class="card-body" id="agencySuggestionsBody">
                                    <!-- Suggestions will be populated here -->
                                </div>
                            </div>
                        </div>
                        {% elif section.section_type == 'witnesses' %}
                        <button type="submit" class="btn btn-outline-primary">
                            <i class="bi bi-plus-lg me-1"></i>Add Witness
                        </button>
                        {% elif section.section_type == 'evidence' %}
                        <div class="d-flex gap-2 flex-wrap">
                            <button type="submit" class="btn btn-outline-primary">
                                <i class="bi bi-plus-lg me-1"></i>Add Evidence
                            </button>
                            <button type="button" class="btn btn-info text-white" id="aiSuggestBtn" onclick="suggestSectionContent('{{ section.section_type }}')">
                                <i class="bi bi-robot me-1"></i>AI Suggest {{ section.section_type|title }}
                            </button>
                        </div>
                        <div id="aiSuggestionsContainer" class="mt-3" style="display: none;">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white py-2">
                                    <i class="bi bi-lightbulb me-1"></i>AI Suggestions
                                </div>
                                <div class="card-body" id="aiSuggestionsBody">
                                    <!-- Suggestions populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <button type="submit" class="btn btn-outline-primary">
                            <i class="bi bi-plus-lg me-1"></i>Add
                        </button>
                        {% endif %}
                    </form>

                {% elif section.section_type == 'relief_sought' %}
                    <!-- Custom Relief Sought Form -->
                    {% include 'documents/partials/relief_sought_form.html' %}

                {% else %}
                    <!-- Single item section -->
                    <form method="post" id="sectionForm">
                        {% csrf_token %}

                        {% if section.section_type in 'damages,rights_violated' %}
                        <!-- AI Suggest Section - At Top -->
                        <div class="card bg-light mb-4">
                            <div class="card-body">
                                <h6 class="card-title"><i class="bi bi-robot me-1"></i>AI Assistant</h6>
                                <p class="card-text small text-muted">
                                    Let AI analyze your story and suggest content for this section.
                                </p>
                                <button type="button" class="btn btn-info text-white" id="aiSuggestBtn" onclick="suggestSectionContent('{{ section.section_type }}')">
                                    <i class="bi bi-magic me-1"></i>Analyze Story & Suggest
                                </button>
                                <div id="aiSuggestionsContainer" class="mt-3" style="display: none;">
                                    <div class="card border-info">
                                        <div class="card-header bg-info text-white py-2">
                                            <i class="bi bi-lightbulb me-1"></i>AI Suggestions
                                        </div>
                                        <div class="card-body" id="aiSuggestionsBody">
                                            <!-- Suggestions populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% for field in form %}
                            {% if section.section_type == 'incident_overview' and field.name in 'federal_district_court,use_manual_court,court_district_confirmed' %}
                                {% if field.name == 'federal_district_court' %}
                                <!-- Start Court District Box -->
                                <div class="court-district-box" id="courtDistrictBox">
                                    <div class="box-header">
                                        <i class="bi bi-building"></i>
                                        <span>Federal District Court - Required</span>
                                    </div>
                                    <p class="small text-muted mb-3">
                                        <strong>Why is this important?</strong> Section 1983 cases must be filed in federal court.
                                        Filing in the wrong court can get your case dismissed. You must confirm the correct district.
                                    </p>
                                {% endif %}
                                {% if field.name == 'federal_district_court' %}
                                    <div class="mb-3">
                                        <label for="{{ field.id_for_label }}" class="form-label fw-bold">
                                            {{ field.label }} <span class="text-danger">*</span>
                                        </label>
                                        {{ field }}
                                        <div class="form-text">Enter city and state above, then click "Lookup Court" button that appears below.</div>
                                        {% if field.errors %}
                                            <div class="invalid-feedback d-block">{{ field.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                {% elif field.name == 'use_manual_court' %}
                                    <div class="form-check mb-3">
                                        {{ field }}
                                        <label class="form-check-label" for="{{ field.id_for_label }}">
                                            {{ field.label }}
                                        </label>
                                        <div class="form-text">{{ field.help_text }}</div>
                                    </div>
                                {% elif field.name == 'court_district_confirmed' %}
                                    <div class="court-district-confirmation" id="courtConfirmationBox">
                                        <div class="form-check">
                                            {{ field }}
                                            <label class="form-check-label" for="{{ field.id_for_label }}">
                                                <i class="bi bi-exclamation-triangle-fill me-1"></i>
                                                I confirm this is the correct federal district court for my case
                                            </label>
                                        </div>
                                        <div class="form-text mt-2">
                                            <strong>You must check this box to continue.</strong> By checking, you confirm you have verified the court district is correct for where your incident occurred.
                                        </div>
                                    </div>
                                </div>
                                <!-- End Court District Box -->
                                {% endif %}
                            {% else %}
                            <div class="mb-3">
                                {% if field.field.widget.input_type == 'checkbox' %}
                                    <div class="form-check">
                                        {{ field }}
                                        <label class="form-check-label" for="{{ field.id_for_label }}">
                                            {{ field.label }}
                                            {% if help_content.fields %}
                                                {% for fname, fdata in help_content.fields.items %}
                                                    {% if fname == field.name and fdata.tooltip %}
                                                        <i class="bi bi-info-circle field-tooltip"
                                                           data-bs-toggle="tooltip"
                                                           data-bs-placement="top"
                                                           title="{{ fdata.tooltip }}"></i>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        </label>
                                        {% if help_content.fields %}
                                            {% for fname, fdata in help_content.fields.items %}
                                                {% if fname == field.name and fdata.help %}
                                                    <div class="form-text">{{ fdata.help|safe }}</div>
                                                {% endif %}
                                            {% endfor %}
                                        {% elif field.help_text %}
                                            <div class="form-text">{{ field.help_text }}</div>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <label for="{{ field.id_for_label }}" class="form-label">
                                        {{ field.label }}
                                        {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                                        {% if help_content.fields %}
                                            {% for fname, fdata in help_content.fields.items %}
                                                {% if fname == field.name and fdata.tooltip %}
                                                    <i class="bi bi-info-circle field-tooltip"
                                                       data-bs-toggle="tooltip"
                                                       data-bs-placement="top"
                                                       title="{{ fdata.tooltip }}"></i>
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                    </label>
                                    {{ field }}
                                    {% if help_content.fields %}
                                        {% for fname, fdata in help_content.fields.items %}
                                            {% if fname == field.name and fdata.help %}
                                                <div class="form-text">{{ fdata.help|safe }}</div>
                                            {% endif %}
                                        {% endfor %}
                                    {% elif field.help_text %}
                                        <div class="form-text">{{ field.help_text }}</div>
                                    {% endif %}
                                {% endif %}
                                {% if field.errors %}
                                    <div class="invalid-feedback d-block">{{ field.errors.0 }}</div>
                                {% endif %}
                            </div>
                            {% endif %}
                        {% endfor %}

                        <hr class="my-4">

                        <div class="d-flex justify-content-between">
                            <button type="submit" name="save" class="btn btn-outline-primary">
                                <i class="bi bi-save me-1"></i>Save
                            </button>
                            <button type="submit" name="save_and_continue" class="btn btn-primary">
                                Save & Continue<i class="bi bi-arrow-right ms-1"></i>
                            </button>
                        </div>
                    </form>
                {% endif %}
            </div>
        </div>

        <!-- Navigation -->
        <div class="d-flex justify-content-between mb-4">
            {% if prev_section %}
                <a href="{% url 'documents:section_edit' document.id prev_section.section_type %}"
                   class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Previous
                </a>
            {% else %}
                <span></span>
            {% endif %}

            {% if next_section %}
                <a href="{% url 'documents:section_edit' document.id next_section.section_type %}"
                   class="btn btn-outline-secondary">
                    Next<i class="bi bi-arrow-right ms-1"></i>
                </a>
            {% else %}
                <a href="{% url 'documents:document_detail' document.id %}"
                   class="btn btn-success">
                    <i class="bi bi-check-lg me-1"></i>Finish
                </a>
            {% endif %}
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Section Status -->
        <div class="card mb-4 shadow {% if section.status == 'completed' or section.status == 'not_applicable' %}border-success{% else %}border-warning border-3{% endif %}">
            <div class="card-header py-3 {% if section.status == 'completed' or section.status == 'not_applicable' %}bg-success text-white{% else %}bg-warning text-dark{% endif %}">
                <h5 class="mb-0">
                    {% if section.status == 'completed' or section.status == 'not_applicable' %}
                    <i class="bi bi-check-circle me-2"></i>Section Status
                    {% else %}
                    <i class="bi bi-exclamation-triangle me-2"></i>Update Section Status
                    {% endif %}
                </h5>
            </div>
            {% if section.status != 'completed' and section.status != 'not_applicable' %}
            <div class="bg-warning bg-opacity-10 px-3 py-2 border-bottom">
                <small>
                    <i class="bi bi-info-circle me-1"></i>
                    <strong>Action needed:</strong> Mark as "Completed" or "Not Applicable" to enable PDF generation.
                </small>
            </div>
            {% endif %}
            <div class="card-body">
                <!-- Current Status Badge -->
                <div class="text-center mb-3 py-2 rounded" style="background-color: #f8f9fa;">
                    <small class="text-muted d-block mb-1">Current Status</small>
                    {% if section.status == 'completed' %}
                        <span class="badge bg-success px-3 py-2 fs-6"><i class="bi bi-check-circle me-1"></i>Completed</span>
                    {% elif section.status == 'in_progress' %}
                        <span class="badge bg-warning text-dark px-3 py-2 fs-6"><i class="bi bi-pencil me-1"></i>In Progress</span>
                    {% elif section.status == 'needs_work' %}
                        <span class="badge bg-danger px-3 py-2 fs-6"><i class="bi bi-exclamation-triangle me-1"></i>Needs Work</span>
                    {% elif section.status == 'not_applicable' %}
                        <span class="badge bg-secondary px-3 py-2 fs-6"><i class="bi bi-dash-circle me-1"></i>N/A</span>
                    {% else %}
                        <span class="badge bg-light text-dark px-3 py-2 fs-6 border"><i class="bi bi-circle me-1"></i>Not Started</span>
                    {% endif %}
                </div>

                <form method="post" action="{% url 'documents:update_section_status' document.id section.section_type %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label fw-bold text-primary"><i class="bi bi-arrow-repeat me-1"></i>Change to:</label>
                        <select name="status" class="form-select form-select-lg border-primary">
                            {% for value, label in section.STATUS_CHOICES %}
                                <option value="{{ value }}" {% if section.status == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted"><i class="bi bi-sticky me-1"></i>Notes (optional):</label>
                        <textarea name="notes" class="form-control" rows="2"
                                  placeholder="Add notes if needed...">{{ section.notes }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg w-100">
                        <i class="bi bi-check2-square me-1"></i>Update Status
                    </button>
                </form>
            </div>
        </div>

        <!-- Quick Help -->
        <div class="card mb-4 border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-question-circle me-2"></i>Quick Help</h5>
            </div>
            <div class="card-body">
                <p class="small mb-2">
                    <i class="bi bi-info-circle text-primary me-1"></i>
                    Hover over <i class="bi bi-info-circle"></i> icons for quick explanations
                </p>
                <p class="small mb-2">
                    <i class="bi bi-lightbulb text-warning me-1"></i>
                    Click "Learn More" above for detailed guidance
                </p>
                <p class="small mb-0">
                    <i class="bi bi-dash-circle text-secondary me-1"></i>
                    Mark sections as "N/A" if they don't apply to your case
                </p>
            </div>
        </div>

        <!-- Section Progress -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>All Sections</h5>
            </div>
            <div class="list-group list-group-flush">
                {% for s in document.sections.all %}
                    <a href="{% url 'documents:section_edit' document.id s.section_type %}"
                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center
                              {% if s.section_type == section.section_type %}active{% endif %}
                              {% if s.status == 'needs_work' %}list-group-item-warning{% endif %}
                              {% if s.story_relevance == 'may_not_apply' and s.status == 'not_started' %}opacity-75{% endif %}">
                        <span class="{% if s.section_type == section.section_type %}fw-bold{% elif s.story_relevance == 'may_not_apply' and s.status == 'not_started' %}text-muted{% endif %}">
                            {{ s.get_section_type_display }}
                            {% if s.story_relevance == 'may_not_apply' and s.status == 'not_started' %}
                                <small class="d-block text-muted" style="font-size: 0.7rem;">May not apply</small>
                            {% endif %}
                        </span>
                        {% if s.status == 'completed' %}
                            <i class="bi bi-check-circle-fill text-success"></i>
                        {% elif s.status == 'needs_work' %}
                            <i class="bi bi-exclamation-triangle-fill text-warning"></i>
                        {% elif s.status == 'in_progress' %}
                            <i class="bi bi-circle-half text-info"></i>
                        {% elif s.status == 'not_applicable' %}
                            <i class="bi bi-dash-circle-fill text-secondary"></i>
                        {% else %}
                            <i class="bi bi-circle text-muted"></i>
                        {% endif %}
                    </a>
                {% endfor %}
            </div>
        </div>

        <!-- Preview Button -->
        <div class="card mt-4 border-primary">
            <div class="card-body text-center">
                <i class="bi bi-file-earmark-text display-6 text-primary mb-2"></i>
                <h6 class="card-title">Ready to Preview?</h6>
                <p class="card-text small text-muted mb-3">See your complaint as a professional legal document</p>
                <a href="{% url 'documents:document_preview' document.id %}" class="btn btn-primary w-100">
                    <i class="bi bi-eye me-1"></i>Preview Document
                </a>
            </div>
        </div>

        {% if section.section_type == 'evidence' and video_evidences %}
        <!-- Video Evidence Summary -->
        <div class="card mt-4 border-danger">
            <div class="card-header bg-danger text-white py-2">
                <small><i class="bi bi-youtube me-1"></i>Video Evidence ({{ video_evidences|length }})</small>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    {% for video in video_evidences %}
                    <div class="list-group-item py-2 px-3">
                        <div class="d-flex align-items-center">
                            <img src="https://img.youtube.com/vi/{{ video.video_id }}/default.jpg"
                                 alt="" class="rounded me-2" style="width: 60px; height: 45px; object-fit: cover;">
                            <div class="flex-grow-1 min-width-0">
                                <p class="mb-0 small text-truncate" title="{{ video.video_title }}">
                                    {{ video.video_title|truncatechars:25 }}
                                </p>
                                <small class="text-muted">
                                    {% with clips=video.captures.count %}
                                    {{ clips }} clip{{ clips|pluralize }}
                                    {% endwith %}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="p-2 border-top">
                    <a href="{% url 'documents:video_analysis' document.id %}" class="btn btn-outline-danger btn-sm w-100">
                        <i class="bi bi-pencil me-1"></i>Manage Videos
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% if section.section_type == 'evidence' and can_use_video_analysis %}
<!-- Link YouTube Video Modal -->
<div class="modal fade" id="linkYouTubeModal" tabindex="-1" aria-labelledby="linkYouTubeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="linkYouTubeModalLabel">
                    <i class="bi bi-youtube me-2"></i>Link YouTube Video
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small mb-3">
                    Link a YouTube video to this evidence to extract and analyze the transcript.
                    This is useful for body camera footage, personal recordings, or news coverage of the incident.
                </p>
                <div class="mb-3">
                    <label class="form-label"><strong>Evidence:</strong></label>
                    <p id="linkYouTubeEvidenceTitle" class="mb-0"></p>
                </div>
                <div class="mb-3">
                    <label for="youtubeUrlInput" class="form-label">YouTube URL</label>
                    <input type="url" class="form-control" id="youtubeUrlInput" placeholder="https://www.youtube.com/watch?v=..." required>
                    <div class="form-text">Paste the full YouTube video URL</div>
                </div>
                <div id="linkYouTubeError" class="alert alert-danger d-none"></div>
                <div id="linkYouTubeSuccess" class="alert alert-success d-none">
                    <i class="bi bi-check-circle me-1"></i>Video linked successfully! Redirecting to video analysis...
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="linkYouTubeSubmit">
                    <i class="bi bi-link-45deg me-1"></i>Link Video
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
// Track unsaved changes
var formHasUnsavedChanges = false;

// Initialize Bootstrap tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Track form changes for unsaved warning
    var forms = document.querySelectorAll('form');
    forms.forEach(function(form) {
        // Listen for input changes
        form.addEventListener('input', function() {
            formHasUnsavedChanges = true;
        });
        form.addEventListener('change', function() {
            formHasUnsavedChanges = true;
        });
        // Clear flag on form submit
        form.addEventListener('submit', function() {
            formHasUnsavedChanges = false;
        });
    });

    // Warn before leaving if unsaved changes
    window.addEventListener('beforeunload', function(e) {
        if (formHasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = '';
            return '';
        }
    });

    // Rotate chevron on collapse toggle
    var helpContent = document.getElementById('helpContent');
    var helpChevron = document.getElementById('helpChevron');
    if (helpContent && helpChevron) {
        helpContent.addEventListener('show.bs.collapse', function () {
            helpChevron.style.transform = 'rotate(180deg)';
        });
        helpContent.addEventListener('hide.bs.collapse', function () {
            helpChevron.style.transform = 'rotate(0deg)';
        });
    }

    // Check for video suggestion from sessionStorage
    var videoSuggestionText = sessionStorage.getItem('videoSuggestionText');
    var videoSuggestionSection = sessionStorage.getItem('videoSuggestionSection');
    if (videoSuggestionText && window.location.search.includes('videoSuggestion=1')) {
        // Clear the stored suggestion
        sessionStorage.removeItem('videoSuggestionText');
        sessionStorage.removeItem('videoSuggestionSection');

        // Find the appropriate textarea based on section type
        var targetTextarea = null;
        var sectionType = '{{ section.section_type }}';

        if (videoSuggestionSection === 'narrative' && sectionType === 'incident_narrative') {
            targetTextarea = document.getElementById('id_narrative');
        } else if (videoSuggestionSection === 'damages' && sectionType === 'damages') {
            // For damages, append to the most relevant field
            targetTextarea = document.getElementById('id_emotional_distress') ||
                            document.getElementById('id_physical_injuries');
        } else if (videoSuggestionSection === 'rights_violated' && sectionType === 'rights_violated') {
            // For rights violated, find the first amendment details field
            targetTextarea = document.getElementById('id_first_amendment_details') ||
                            document.getElementById('id_fourth_amendment_details') ||
                            document.getElementById('id_fourteenth_amendment_details');
        }

        if (targetTextarea) {
            // Show a banner with the suggestion
            var banner = document.createElement('div');
            banner.className = 'alert alert-success alert-dismissible fade show mb-4';
            banner.innerHTML = `
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                <h6><i class="bi bi-youtube me-2"></i>Video Evidence Suggestion</h6>
                <p class="mb-2">${videoSuggestionText}</p>
                <button type="button" class="btn btn-success btn-sm" id="applyVideoSuggestionBtn">
                    <i class="bi bi-plus-lg me-1"></i>Append to Field Below
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="copyVideoSuggestionBtn">
                    <i class="bi bi-clipboard me-1"></i>Copy Only
                </button>
            `;

            // Insert banner at top of form
            var form = document.querySelector('form#sectionForm') || document.querySelector('form');
            if (form) {
                form.insertBefore(banner, form.firstChild);

                // Handle append button
                document.getElementById('applyVideoSuggestionBtn').addEventListener('click', function() {
                    if (targetTextarea.value.trim()) {
                        targetTextarea.value += '\n\n' + videoSuggestionText;
                    } else {
                        targetTextarea.value = videoSuggestionText;
                    }
                    targetTextarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    targetTextarea.style.backgroundColor = '#d1e7dd';
                    setTimeout(function() {
                        targetTextarea.style.backgroundColor = '';
                    }, 2000);
                    banner.remove();
                    formHasUnsavedChanges = true;
                });

                // Handle copy button
                document.getElementById('copyVideoSuggestionBtn').addEventListener('click', function() {
                    navigator.clipboard.writeText(videoSuggestionText).then(function() {
                        this.innerHTML = '<i class="bi bi-check-lg me-1"></i>Copied!';
                    }.bind(this));
                });

                banner.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
    }

    // Attorney toggle for plaintiff_info section
    var hasAttorneyCheckbox = document.getElementById('id_has_attorney');
    if (hasAttorneyCheckbox) {
        // Get all attorney field containers
        var attorneyFieldIds = [
            'id_attorney_name', 'id_attorney_bar_number', 'id_attorney_firm_name',
            'id_attorney_street_address', 'id_attorney_city', 'id_attorney_state',
            'id_attorney_zip_code', 'id_attorney_phone', 'id_attorney_fax', 'id_attorney_email'
        ];

        // Create a wrapper div for attorney fields
        var attorneySection = document.createElement('div');
        attorneySection.id = 'attorney-section';
        attorneySection.className = 'attorney-section';
        attorneySection.innerHTML = '<div class="attorney-section-header"><i class="bi bi-briefcase me-2"></i>Attorney Information</div>';

        var attorneyFieldsContainer = document.createElement('div');
        attorneyFieldsContainer.id = 'attorney-fields-container';
        attorneySection.appendChild(attorneyFieldsContainer);

        // Find and move attorney fields into the container
        var firstAttorneyField = null;
        attorneyFieldIds.forEach(function(fieldId) {
            var field = document.getElementById(fieldId);
            if (field) {
                var fieldContainer = field.closest('.mb-3');
                if (fieldContainer) {
                    if (!firstAttorneyField) {
                        firstAttorneyField = fieldContainer;
                    }
                    attorneyFieldsContainer.appendChild(fieldContainer);
                }
            }
        });

        // Insert the attorney section after the has_attorney checkbox container
        var hasAttorneyContainer = hasAttorneyCheckbox.closest('.mb-3');
        if (hasAttorneyContainer && attorneyFieldsContainer.children.length > 0) {
            hasAttorneyContainer.after(attorneySection);
        }

        // Function to toggle attorney fields visibility
        // Show when checked (has attorney), hide when unchecked (pro se)
        function toggleAttorneyFields() {
            if (hasAttorneyCheckbox.checked) {
                attorneySection.style.display = 'block';
            } else {
                attorneySection.style.display = 'none';
            }
        }

        // Initial toggle based on checkbox state
        toggleAttorneyFields();

        // Listen for changes
        hasAttorneyCheckbox.addEventListener('change', toggleAttorneyFields);
    }


    // District court lookup for incident_overview section
    var cityField = document.getElementById('id_city');
    var stateField = document.getElementById('id_state');
    var courtField = document.getElementById('id_federal_district_court');
    var manualCourtCheckbox = document.getElementById('id_use_manual_court');

    if (cityField && stateField && courtField) {
        // Add a "Lookup Court" button next to the court field
        var lookupBtn = document.createElement('button');
        lookupBtn.type = 'button';
        lookupBtn.className = 'btn btn-outline-primary mt-2';
        lookupBtn.id = 'lookupCourtBtn';
        lookupBtn.innerHTML = '<i class="bi bi-search me-1"></i>Lookup Court';

        // Add help icon with tooltip next to the button
        var helpIcon = document.createElement('span');
        helpIcon.className = 'ms-2 text-muted';
        helpIcon.setAttribute('data-bs-toggle', 'tooltip');
        helpIcon.setAttribute('data-bs-placement', 'top');
        helpIcon.setAttribute('data-bs-html', 'true');
        helpIcon.setAttribute('title', '<strong>Why do I need this?</strong><br>Section 1983 cases must be filed in federal court. This lookup finds the correct U.S. District Court based on where your incident occurred. Filing in the wrong court can get your case dismissed.');
        helpIcon.innerHTML = '<i class="bi bi-question-circle" style="cursor: help; font-size: 1.1rem;"></i>';

        var courtFieldContainer = courtField.closest('.mb-3');
        if (courtFieldContainer) {
            // Create a wrapper for button and help icon
            var btnWrapper = document.createElement('div');
            btnWrapper.className = 'd-flex align-items-center';
            btnWrapper.appendChild(lookupBtn);
            btnWrapper.appendChild(helpIcon);
            courtFieldContainer.appendChild(btnWrapper);

            // Create mini terminal for lookup status
            var lookupTerminal = document.createElement('div');
            lookupTerminal.id = 'courtLookupTerminal';
            lookupTerminal.className = 'mt-2 p-2 bg-dark text-light rounded d-none';
            lookupTerminal.style.cssText = 'font-family: monospace; font-size: 0.8rem; max-height: 80px; overflow-y: auto;';
            lookupTerminal.innerHTML = '<div id="terminalLines"></div>';
            courtFieldContainer.appendChild(lookupTerminal);

            // Initialize the tooltip
            new bootstrap.Tooltip(helpIcon);
        }

        // Mini terminal animation for court lookup
        var lookupCommands = [
            { cmd: 'lookup --city', out: 'Checking city database...' },
            { cmd: 'query --district', out: 'Searching district courts...' },
            { cmd: 'verify --jurisdiction', out: 'Verifying jurisdiction...' },
            { cmd: 'fetch --court-name', out: 'Fetching court details...' },
            { cmd: 'search --web', out: 'Searching federal records...' },
            { cmd: 'validate --result', out: 'Validating court match...' }
        ];
        var terminalInterval = null;

        function startLookupTerminal(city, state) {
            var terminal = document.getElementById('courtLookupTerminal');
            var linesDiv = document.getElementById('terminalLines');
            if (!terminal || !linesDiv) return;

            terminal.classList.remove('d-none');
            linesDiv.innerHTML = '<span style="color: #6c757d;"># Looking up federal court for ' + city + ', ' + state + '</span>';

            var cmdIndex = 0;
            terminalInterval = setInterval(function() {
                var cmd = lookupCommands[cmdIndex % lookupCommands.length];
                linesDiv.innerHTML += '<br><span style="color: #0d6efd;">❯</span> ' + cmd.cmd;
                setTimeout(function() {
                    linesDiv.innerHTML += '<br><span style="color: #6c757d;">→ ' + cmd.out + '</span>';
                    terminal.scrollTop = terminal.scrollHeight;
                }, 100);
                cmdIndex++;
                terminal.scrollTop = terminal.scrollHeight;
            }, 800);
        }

        function stopLookupTerminal(success, message) {
            if (terminalInterval) {
                clearInterval(terminalInterval);
                terminalInterval = null;
            }
            var linesDiv = document.getElementById('terminalLines');
            if (linesDiv) {
                var color = success ? '#198754' : '#dc3545';
                var icon = success ? '✓' : '✗';
                linesDiv.innerHTML += '<br><span style="color: ' + color + ';">' + icon + ' ' + message + '</span>';
            }
            // Hide terminal after 2 seconds
            setTimeout(function() {
                var terminal = document.getElementById('courtLookupTerminal');
                if (terminal) terminal.classList.add('d-none');
            }, 2000);
        }

        function lookupDistrictCourt() {
            // Don't lookup if manual override is checked
            if (manualCourtCheckbox && manualCourtCheckbox.checked) {
                return;
            }

            var city = cityField.value.trim();
            var state = stateField.value;  // Already 2-letter code from dropdown

            if (!city || !state) {
                alert('Please enter a City and select a State first.');
                return;
            }

            // Show loading
            lookupBtn.disabled = true;
            lookupBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Searching...';
            courtField.placeholder = 'Looking up district court...';

            // Start mini terminal animation
            startLookupTerminal(city, state);

            fetch('/documents/lookup-district-court/?city=' + encodeURIComponent(city) + '&state=' + encodeURIComponent(state))
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.success && data.court_name) {
                        courtField.value = data.court_name;
                        courtField.placeholder = 'Federal district court';

                        // Show confidence indicator
                        var confidenceBadge = document.getElementById('court-confidence');
                        if (!confidenceBadge) {
                            confidenceBadge = document.createElement('small');
                            confidenceBadge.id = 'court-confidence';
                            confidenceBadge.className = 'd-block mt-1';
                            courtField.parentNode.insertBefore(confidenceBadge, lookupBtn);
                        }

                        var confidenceText = data.confidence === 'high' ? 'High confidence match' : 'Best match found';
                        var confidenceClass = data.confidence === 'high' ? 'text-success' : 'text-warning';
                        var methodNote = data.method === 'gpt_web_search' ? ' (via web search)' : '';
                        confidenceBadge.innerHTML = '<i class="bi bi-check-circle me-1"></i><span class="' + confidenceClass + '">' + confidenceText + methodNote + '</span>';

                        lookupBtn.innerHTML = '<i class="bi bi-check-lg me-1"></i>Found!';
                        lookupBtn.classList.remove('btn-outline-primary');
                        lookupBtn.classList.add('btn-success');

                        // Stop terminal with success
                        stopLookupTerminal(true, 'Court found: ' + data.court_name);
                    } else {
                        courtField.placeholder = 'Could not find - check manual entry';
                        var confidenceBadge = document.getElementById('court-confidence');
                        if (!confidenceBadge) {
                            confidenceBadge = document.createElement('small');
                            confidenceBadge.id = 'court-confidence';
                            confidenceBadge.className = 'd-block mt-1';
                            courtField.parentNode.insertBefore(confidenceBadge, lookupBtn);
                        }
                        confidenceBadge.innerHTML = '<span class="text-danger"><i class="bi bi-exclamation-circle me-1"></i>Could not determine court. Enter manually or try a nearby city.</span>';
                        lookupBtn.innerHTML = '<i class="bi bi-x-lg me-1"></i>Not Found';
                        lookupBtn.classList.remove('btn-outline-primary');
                        lookupBtn.classList.add('btn-warning');

                        // Stop terminal with failure
                        stopLookupTerminal(false, 'Could not determine court');
                    }
                })
                .catch(function(error) {
                    console.error('District lookup error:', error);
                    courtField.placeholder = 'Lookup failed - enter manually';
                    lookupBtn.innerHTML = '<i class="bi bi-x-lg me-1"></i>Error';
                    lookupBtn.classList.remove('btn-outline-primary');
                    lookupBtn.classList.add('btn-danger');

                    // Stop terminal with error
                    stopLookupTerminal(false, 'Lookup error: ' + error.message);
                })
                .finally(function() {
                    lookupBtn.disabled = false;
                    // Reset button after 3 seconds
                    setTimeout(function() {
                        lookupBtn.innerHTML = '<i class="bi bi-search me-1"></i>Lookup Court';
                        lookupBtn.classList.remove('btn-success', 'btn-warning', 'btn-danger');
                        lookupBtn.classList.add('btn-outline-primary');
                    }, 3000);
                });
        }

        // Click handler for lookup button
        lookupBtn.addEventListener('click', lookupDistrictCourt);

        // Toggle court field editability based on manual checkbox
        if (manualCourtCheckbox) {
            function toggleCourtEditable() {
                if (manualCourtCheckbox.checked) {
                    courtField.readOnly = false;
                    courtField.placeholder = 'Enter federal district court name';
                    lookupBtn.style.display = 'none';
                } else {
                    courtField.readOnly = true;
                    courtField.placeholder = 'Click "Lookup Court" after entering city & state';
                    lookupBtn.style.display = '';
                }
            }

            manualCourtCheckbox.addEventListener('change', toggleCourtEditable);
            toggleCourtEditable(); // Set initial state
        }

        // Auto-lookup on page load if city and state are filled but court isn't
        if (cityField.value && stateField.value && !courtField.value) {
            lookupDistrictCourt();
        }

        // Also trigger lookup when state dropdown changes (if city is filled)
        stateField.addEventListener('change', function() {
            if (cityField.value && stateField.value && !manualCourtCheckbox.checked) {
                lookupDistrictCourt();
            }
        });

        // Court district confirmation logic
        var courtConfirmCheckbox = document.getElementById('id_court_district_confirmed');
        var courtConfirmationBox = document.getElementById('courtConfirmationBox');
        var sectionForm = document.getElementById('sectionForm');

        function updateConfirmationStyle() {
            if (!courtConfirmationBox || !courtConfirmCheckbox) return;

            if (courtConfirmCheckbox.checked) {
                courtConfirmationBox.classList.add('confirmed');
            } else {
                courtConfirmationBox.classList.remove('confirmed');
            }
        }

        // Update styling on page load and when checkbox changes
        updateConfirmationStyle();
        if (courtConfirmCheckbox) {
            courtConfirmCheckbox.addEventListener('change', updateConfirmationStyle);
        }

        // Form validation - require court district confirmation
        if (sectionForm && courtConfirmCheckbox) {
            sectionForm.addEventListener('submit', function(e) {
                var courtFilled = courtField.value.trim() !== '';
                var courtConfirmed = courtConfirmCheckbox.checked;

                if (!courtFilled) {
                    e.preventDefault();
                    alert('Please look up the Federal District Court first. Enter your city and state, then click "Lookup Court".');
                    courtField.focus();
                    return false;
                }

                if (!courtConfirmed) {
                    e.preventDefault();
                    alert('Please confirm the Federal District Court is correct by checking the confirmation box.');
                    courtConfirmCheckbox.focus();
                    // Scroll to the confirmation box
                    courtConfirmationBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return false;
                }
            });
        }
    }
});
</script>
{% if section.section_type in 'damages,rights_violated,evidence' %}
<script>
let currentWitnessSuggestions = [];
let currentEvidenceSuggestions = [];
let currentDamageSuggestions = [];

// Terminal animation commands for AI analysis
const AI_ANALYSIS_COMMANDS = [
    { cmd: 'parse-narrative --extract-facts', out: 'Extracting factual claims...' },
    { cmd: 'analyze-impact --type=' + '{{ section.section_type }}', out: 'Analyzing impact on plaintiff...' },
    { cmd: 'cross-ref --case-law --damages', out: 'Cross-referencing case law...' },
    { cmd: 'compute-categories --standard=1983', out: 'Computing damage categories...' },
    { cmd: 'validate-claims --legal-basis', out: 'Validating legal basis...' },
    { cmd: 'generate-suggestions --format=json', out: 'Generating suggestions...' }
];
let terminalAnimationInterval = null;
let terminalCommandIndex = 0;

function startAITerminalAnimation() {
    terminalCommandIndex = 0;
    const commands = [...AI_ANALYSIS_COMMANDS];

    terminalAnimationInterval = setInterval(() => {
        const terminalBody = document.getElementById('aiTerminalBody');
        const progressBar = document.getElementById('aiTerminalProgress');
        const statusText = document.getElementById('aiTerminalStatus');
        const percentText = document.getElementById('aiTerminalPercent');

        if (!terminalBody) {
            stopAITerminalAnimation();
            return;
        }

        if (terminalCommandIndex < commands.length) {
            const cmd = commands[terminalCommandIndex];
            const percent = Math.round(((terminalCommandIndex + 1) / commands.length) * 90);

            // Add command line
            const cmdLine = document.createElement('div');
            cmdLine.className = 'terminal-line';
            cmdLine.innerHTML = `<span class="terminal-prompt">❯</span> <span class="terminal-path">~/analyze</span> <span class="terminal-command">${cmd.cmd}</span>`;
            terminalBody.appendChild(cmdLine);

            // Add output after small delay
            setTimeout(() => {
                const outLine = document.createElement('div');
                outLine.className = 'terminal-line';
                outLine.innerHTML = `<span class="terminal-output">→ ${cmd.out}</span>`;
                terminalBody.appendChild(outLine);
                terminalBody.scrollTop = terminalBody.scrollHeight;
            }, 150);

            // Update progress
            if (progressBar) progressBar.style.width = percent + '%';
            if (percentText) percentText.textContent = percent + '%';
            if (statusText) statusText.textContent = cmd.out;

            terminalCommandIndex++;
        } else {
            // Keep showing waiting state
            if (statusText) statusText.textContent = 'Waiting for AI response...';
        }
    }, 600);
}

function stopAITerminalAnimation() {
    if (terminalAnimationInterval) {
        clearInterval(terminalAnimationInterval);
        terminalAnimationInterval = null;
    }

    // Show completion
    const progressBar = document.getElementById('aiTerminalProgress');
    const percentText = document.getElementById('aiTerminalPercent');
    const statusText = document.getElementById('aiTerminalStatus');
    const terminalBody = document.getElementById('aiTerminalBody');

    if (progressBar) progressBar.style.width = '100%';
    if (percentText) percentText.textContent = '100%';
    if (statusText) statusText.textContent = 'Analysis complete';

    if (terminalBody) {
        const doneLine = document.createElement('div');
        doneLine.className = 'terminal-line';
        doneLine.innerHTML = '<span class="terminal-success">✓ Analysis complete</span>';
        terminalBody.appendChild(doneLine);
    }
}

function suggestSectionContent(sectionType) {
    const btn = document.getElementById('aiSuggestBtn');
    const container = document.getElementById('aiSuggestionsContainer');
    const body = document.getElementById('aiSuggestionsBody');

    // Show terminal-style loading
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-terminal me-1"></i>Analyzing...';
    container.style.display = 'block';

    // Build terminal HTML
    body.innerHTML = `
        <div class="terminal-container">
            <div class="terminal-header">
                <div class="terminal-buttons">
                    <span class="terminal-btn close"></span>
                    <span class="terminal-btn minimize"></span>
                    <span class="terminal-btn maximize"></span>
                </div>
                <div class="terminal-title">1983law — analyzing ${sectionType}</div>
            </div>
            <div class="terminal-body" id="aiTerminalBody" style="max-height: 200px;">
                <div class="terminal-line"><span class="terminal-comment"># Analyzing your story for ${sectionType}...</span></div>
            </div>
            <div class="terminal-progress-bar">
                <div class="terminal-progress-fill" id="aiTerminalProgress" style="width: 0%"></div>
            </div>
            <div class="terminal-status">
                <span class="terminal-status-text" id="aiTerminalStatus">Initializing...</span>
                <span class="terminal-percentage" id="aiTerminalPercent">0%</span>
            </div>
        </div>
    `;

    // Start terminal animation
    startAITerminalAnimation();

    fetch(`/documents/{{ document.id }}/suggest-section/${sectionType}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        // Stop terminal animation
        stopAITerminalAnimation();

        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-magic me-1"></i>Analyze Story & Suggest';

        // Check for either old format (suggestions) or new evidence format (evidence_you_have/evidence_to_obtain)
        const hasOldSuggestions = data.suggestions && data.suggestions.length > 0;
        const hasNewEvidenceFormat = (data.evidence_you_have && data.evidence_you_have.length > 0) ||
                                     (data.evidence_to_obtain && data.evidence_to_obtain.length > 0);

        // Update AI usage banner if info provided
        if (data.ai_usage_display) {
            updateAIUsageBanner(data.ai_usage_display);
        }

        if (data.success && (hasOldSuggestions || hasNewEvidenceFormat)) {
            let html = '';

            if (sectionType === 'damages') {
                // Filter out damage types that already have content in form fields
                const filteredDamages = (data.suggestions || []).filter(s => !suggestionExists(s, 'damages'));

                if (filteredDamages.length === 0) {
                    html = '<div class="alert alert-success mb-0"><i class="bi bi-check-circle me-1"></i>All suggested damage types already have content in your form.</div>';
                } else {
                    html = '<p class="small text-muted mb-2">Click "Use" to fill in the form fields above:</p>';
                    html += '<ul class="list-group list-group-flush">';
                    currentDamageSuggestions = filteredDamages;
                    filteredDamages.forEach((s, index) => {
                        html += `<li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <strong class="text-capitalize">${escapeHtml(s.damage_type)} Damage:</strong>
                                    <span>${escapeHtml(s.description)}</span>
                                    ${s.details ? `<br><small class="text-muted">${escapeHtml(s.details)}</small>` : ''}
                                </div>
                                <div class="ms-2">
                                    <button type="button" class="btn btn-sm btn-success use-damage-btn" data-index="${index}">
                                        <i class="bi bi-arrow-up-circle me-1"></i>Use
                                    </button>
                                </div>
                            </div>
                        </li>`;
                    });
                    html += '</ul>';
                }
            } else if (sectionType === 'rights_violated') {
                html = '<p class="small text-muted mb-2">Review these potential constitutional violations and check the boxes above:</p>';
                html += '<ul class="list-group list-group-flush">';
                data.suggestions.forEach(s => {
                    const strengthClass = s.strength === 'strong' ? 'success' : s.strength === 'moderate' ? 'warning' : 'secondary';
                    html += `<li class="list-group-item">
                        <strong>${escapeHtml(s.amendment)} Amendment - ${escapeHtml(s.right)}</strong>
                        <span class="badge bg-${strengthClass} ms-2">${escapeHtml(s.strength)}</span>
                        <br><span>${escapeHtml(s.description)}</span>
                    </li>`;
                });
                html += '</ul>';
                html += '<div class="alert alert-info mt-3 mb-0 small"><i class="bi bi-info-circle me-1"></i>Check the corresponding amendment boxes above based on these suggestions.</div>';
            } else if (sectionType === 'witnesses') {
                // Filter out witnesses that already exist in the list
                const filteredWitnesses = (data.suggestions || []).filter(s => !suggestionExists(s, 'witnesses'));
                if (filteredWitnesses.length === 0) {
                    html = '<div class="alert alert-info mb-0"><i class="bi bi-check-circle me-1"></i>All suggested witnesses have already been added to your list.</div>';
                } else {
                    html = '<p class="small text-muted mb-2">Click "Add" to add each witness:</p>';
                    currentWitnessSuggestions = filteredWitnesses;
                    filteredWitnesses.forEach((s, index) => {
                    html += `<div class="mb-2 p-3 border rounded suggestion-item" data-index="${index}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <strong>${escapeHtml(s.name)}</strong>
                                <br><small class="text-muted">Role: ${escapeHtml(s.relationship)}</small>
                                <br><small>What they may know: ${escapeHtml(s.what_they_witnessed)}</small>
                            </div>
                            <div>
                                <button type="button" class="btn btn-sm btn-success add-witness-btn" data-index="${index}">
                                    <i class="bi bi-plus-lg me-1"></i>Add
                                </button>
                            </div>
                        </div>
                    </div>`;
                    });
                }
            } else if (sectionType === 'evidence') {
                // Handle both old format (suggestions) and new format (evidence_you_have/evidence_to_obtain)
                // Track original counts to detect if all were filtered out as duplicates
                const originalYouHaveCount = (data.evidence_you_have || []).length;
                const originalOldCount = (data.suggestions || []).length;

                // Filter out items that already exist in the list
                const evidenceYouHave = (data.evidence_you_have || []).filter(s => !suggestionExists(s, 'evidence'));
                const evidenceToObtain = (data.evidence_to_obtain || []).filter(s => !suggestionExists(s, 'evidence'));
                const oldSuggestions = (data.suggestions || []).filter(s => !suggestionExists(s, 'evidence'));

                // Check if all suggestions were filtered out as duplicates
                const allYouHaveFiltered = originalYouHaveCount > 0 && evidenceYouHave.length === 0;
                const allOldFiltered = originalOldCount > 0 && oldSuggestions.length === 0;

                // Check if we're using the old format (backwards compatibility)
                if (oldSuggestions.length > 0 && evidenceYouHave.length === 0 && evidenceToObtain.length === 0) {
                    // Old format - show all as addable (legacy behavior)
                    html = '<p class="small text-muted mb-2">Click "Add" to add each piece of evidence:</p>';
                    currentEvidenceSuggestions = oldSuggestions;
                    oldSuggestions.forEach((s, index) => {
                        html += `<div class="mb-2 p-3 border rounded suggestion-item" data-index="${index}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <strong class="text-capitalize">${escapeHtml(s.evidence_type)}:</strong> ${escapeHtml(s.description)}
                                    <br><small class="text-muted">How to obtain: ${escapeHtml(s.how_to_obtain || '')}</small>
                                    <br><small class="text-info">Importance: ${escapeHtml(s.importance || '')}</small>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-sm btn-success add-evidence-btn" data-index="${index}">
                                        <i class="bi bi-plus-lg me-1"></i>Add
                                    </button>
                                </div>
                            </div>
                        </div>`;
                    });
                } else {
                    // New format - separate into two sections
                    // Section 1: Evidence You Have (with Add buttons)
                    if (evidenceYouHave.length > 0) {
                        html += '<div class="mb-4">';
                        html += '<h6 class="text-success mb-2"><i class="bi bi-check-circle-fill me-1"></i>Evidence You Have</h6>';
                        html += '<p class="small text-muted mb-2">Based on your story, you already have this evidence. Click "Add" to include it in your case:</p>';
                        currentEvidenceSuggestions = evidenceYouHave;
                        evidenceYouHave.forEach((s, index) => {
                            html += `<div class="mb-2 p-3 border border-success rounded suggestion-item bg-success bg-opacity-10" data-index="${index}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <strong class="text-capitalize">${escapeHtml(s.evidence_type)}:</strong> ${escapeHtml(s.description)}
                                        <br><small class="text-muted">${escapeHtml(s.details || '')}</small>
                                    </div>
                                    <div>
                                        <button type="button" class="btn btn-sm btn-success add-evidence-btn" data-index="${index}">
                                            <i class="bi bi-plus-lg me-1"></i>Add
                                        </button>
                                    </div>
                                </div>
                            </div>`;
                        });
                        html += '</div>';
                    } else if (allYouHaveFiltered) {
                        // All suggested evidence was already in the list
                        html += '<div class="alert alert-success mb-4"><i class="bi bi-check-circle me-1"></i>All suggested evidence you have is already in your list.</div>';
                    } else {
                        html += '<div class="alert alert-secondary mb-4"><i class="bi bi-info-circle me-1"></i>No evidence was explicitly mentioned as being in your possession. If you have recordings, photos, or documents, make sure to describe them in your story.</div>';
                    }

                    // Section 2: Evidence to Obtain (informational only, no Add buttons)
                    if (evidenceToObtain.length > 0) {
                        html += '<div class="mb-3">';
                        html += '<h6 class="text-primary mb-2"><i class="bi bi-search me-1"></i>Evidence to Request/Obtain</h6>';
                        html += '<p class="small text-muted mb-2">This evidence may exist and could strengthen your case. You\'ll need to request it:</p>';
                        evidenceToObtain.forEach((s) => {
                            html += `<div class="mb-2 p-3 border rounded bg-light">
                                <div class="flex-grow-1">
                                    <strong class="text-capitalize">${escapeHtml(s.evidence_type)}:</strong> ${escapeHtml(s.description)}
                                    <br><small class="text-primary"><i class="bi bi-arrow-right me-1"></i>How to obtain: ${escapeHtml(s.how_to_obtain || 'Contact the relevant agency')}</small>
                                    <br><small class="text-muted"><i class="bi bi-lightbulb me-1"></i>Why important: ${escapeHtml(s.why_important || '')}</small>
                                </div>
                            </div>`;
                        });
                        html += '</div>';
                    }
                }
            }

            // Show tips if available
            if (data.tips) {
                html += `<div class="alert alert-info mt-3 mb-0 small"><i class="bi bi-lightbulb me-1"></i><strong>Tips:</strong> ${escapeHtml(data.tips)}</div>`;
            } else if (data.notes) {
                html += `<div class="alert alert-info mt-3 mb-0 small"><i class="bi bi-info-circle me-1"></i>${escapeHtml(data.notes)}</div>`;
            }

            body.innerHTML = html;

            // Attach click handlers for witness add buttons
            body.querySelectorAll('.add-witness-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    addWitnessSuggestion(currentWitnessSuggestions[index], this);
                });
            });

            // Attach click handlers for evidence add buttons
            body.querySelectorAll('.add-evidence-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    addEvidenceSuggestion(currentEvidenceSuggestions[index], this);
                });
            });

            // Attach click handlers for damage use buttons
            body.querySelectorAll('.use-damage-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    useDamageSuggestion(currentDamageSuggestions[index], this);
                });
            });
        } else if (data.limit_reached) {
            // AI limit reached - show upgrade message
            body.innerHTML = `
                <div class="alert alert-warning mb-0">
                    <div class="text-center">
                        <i class="bi bi-exclamation-triangle-fill text-warning" style="font-size: 2rem;"></i>
                        <h6 class="mt-2">AI Limit Reached</h6>
                        <p class="small mb-2">${escapeHtml(data.error)}</p>
                        <a href="/documents/{{ document.id }}/checkout/" class="btn btn-primary btn-sm">
                            <i class="bi bi-unlock me-1"></i>Upgrade Now
                        </a>
                    </div>
                </div>`;
        } else if (data.error) {
            body.innerHTML = `<div class="alert alert-warning mb-0"><i class="bi bi-exclamation-triangle me-1"></i>${escapeHtml(data.error)}</div>`;
        } else {
            body.innerHTML = '<div class="alert alert-info mb-0"><i class="bi bi-info-circle me-1"></i>No additional suggestions found. Your story may not contain information relevant to this section.</div>';
        }
    })
    .catch(error => {
        stopAITerminalAnimation();
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-magic me-1"></i>Analyze Story & Suggest';
        body.innerHTML = `<div class="alert alert-danger mb-0"><i class="bi bi-x-circle me-1"></i>Error: ${escapeHtml(error.message)}</div>`;
    });
}

function updateAIUsageBanner(displayText) {
    // Update the AI usage display in the status banner
    const aiUsageDisplay = document.getElementById('aiUsageDisplay');
    if (aiUsageDisplay && displayText) {
        aiUsageDisplay.textContent = displayText;
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showAddedNotification(message) {
    // Create or update the notification banner
    let notification = document.getElementById('addedNotification');
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'addedNotification';
        notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
        notification.style.cssText = 'top: 70px; left: 50%; transform: translateX(-50%); z-index: 1050; min-width: 400px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
        notification.innerHTML = `
            <i class="bi bi-check-circle-fill me-2"></i>
            <span id="addedNotificationText"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.body.appendChild(notification);
    }

    document.getElementById('addedNotificationText').textContent = message;
    notification.style.display = 'block';
    notification.classList.add('show');

    // Auto-hide after 5 seconds
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => { notification.style.display = 'none'; }, 150);
    }, 5000);
}

// Track added items to prevent duplicates
const addedItems = new Set();

// Map AI damage types to form field IDs (text fields for descriptions)
const damageTypeToFieldMap = {
    'emotional': 'id_emotional_distress_description',
    'psychological': 'id_emotional_distress_description',
    'mental': 'id_emotional_distress_description',
    'physical': 'id_physical_injury_description',
    'bodily': 'id_physical_injury_description',
    'injury': 'id_physical_injury_description',
    'property': 'id_property_damage_description',
    'reputation': 'id_reputation_harm_description',
    'reputational': 'id_reputation_harm_description',
    // These go to "other damages" field
    'financial': 'id_other_damages',
    'economic': 'id_other_damages',
    'constitutional': 'id_other_damages',
    'inconvenience': 'id_other_damages',
    'professional': 'id_other_damages',
    'civil rights': 'id_other_damages',
    'other': 'id_other_damages'
};

// Map AI damage types to checkbox fields (to auto-check the category)
const damageTypeToCheckboxMap = {
    'emotional': 'id_emotional_distress',
    'psychological': 'id_emotional_distress',
    'mental': 'id_emotional_distress',
    'physical': 'id_physical_injury',
    'bodily': 'id_physical_injury',
    'injury': 'id_physical_injury',
    'property': 'id_property_damage',
    'reputation': 'id_reputation_harm',
    'reputational': 'id_reputation_harm'
};

// Check if a damage form field already has content
function damageFieldHasContent(damageType) {
    const normalizedType = damageType.toLowerCase().trim();
    const fieldId = damageTypeToFieldMap[normalizedType];
    if (fieldId) {
        const field = document.getElementById(fieldId);
        if (field && field.value && field.value.trim().length > 0) {
            return true;
        }
    }
    return false;
}

// Use a damage suggestion to fill in the form field
function useDamageSuggestion(suggestion, buttonElement) {
    const normalizedType = suggestion.damage_type.toLowerCase().trim();
    const fieldId = damageTypeToFieldMap[normalizedType];
    const checkboxId = damageTypeToCheckboxMap[normalizedType];

    // Build the text content
    let content = `${suggestion.damage_type.charAt(0).toUpperCase() + suggestion.damage_type.slice(1)} Damage: ${suggestion.description}`;
    if (suggestion.details) {
        content += `\n${suggestion.details}`;
    }

    // Find and fill the text field
    const field = document.getElementById(fieldId);
    if (field) {
        // If field already has content, append with a separator
        if (field.value && field.value.trim()) {
            field.value = field.value.trim() + '\n\n' + content;
        } else {
            field.value = content;
        }

        // Check the corresponding checkbox if it exists
        if (checkboxId) {
            const checkbox = document.getElementById(checkboxId);
            if (checkbox && !checkbox.checked) {
                checkbox.checked = true;
            }
        }

        // Highlight the field
        field.style.transition = 'background-color 0.3s';
        field.style.backgroundColor = '#d4edda';
        setTimeout(() => {
            field.style.backgroundColor = '';
        }, 2000);

        // Scroll to the field
        field.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // Update button to show success
        buttonElement.disabled = true;
        buttonElement.innerHTML = '<i class="bi bi-check-lg me-1"></i>Added';
        buttonElement.classList.remove('btn-success');
        buttonElement.classList.add('btn-secondary');

        // Show notification
        showAddedNotification(`${suggestion.damage_type} damage added to form`);
    } else {
        alert(`Could not find the form field for ${suggestion.damage_type} damage. Please add it manually.`);
    }
}

// Get existing items from the list to filter out duplicates from suggestions
function getExistingItems() {
    const existingItems = new Set();
    const listElement = document.getElementById('defendantsList');
    if (listElement) {
        listElement.querySelectorAll('.list-group-item strong').forEach(el => {
            // Normalize: lowercase, trim, and remove extra whitespace
            const text = el.textContent.toLowerCase().trim().replace(/\s+/g, ' ');
            existingItems.add(text);
        });
    }
    // Also include items added in this session
    addedItems.forEach(key => {
        // Keys are like "evidence:Video Recording" or "witness:John Doe"
        const parts = key.split(':');
        if (parts.length > 1) {
            existingItems.add(parts.slice(1).join(':').toLowerCase().trim());
        }
    });
    return existingItems;
}

// Check if a suggestion already exists in the list or form
function suggestionExists(suggestion, sectionType) {
    if (sectionType === 'damages') {
        // For damages, check if the form field already has content
        return damageFieldHasContent(suggestion.damage_type);
    }

    const existingItems = getExistingItems();
    let checkText = '';

    if (sectionType === 'evidence') {
        // For evidence, check for exact or very similar matches
        checkText = `${suggestion.evidence_type}: ${suggestion.description}`.toLowerCase().trim();
        const descOnly = suggestion.description.toLowerCase().trim();

        // Check exact match first
        if (existingItems.has(checkText)) return true;

        // Check if description is very similar (more than 80% of words match)
        for (const item of existingItems) {
            const itemWords = item.split(/\s+/).filter(w => w.length > 3);
            const descWords = descOnly.split(/\s+/).filter(w => w.length > 3);
            if (itemWords.length === 0 || descWords.length === 0) continue;

            const matchingWords = descWords.filter(w => itemWords.includes(w));
            const matchRatio = matchingWords.length / Math.max(itemWords.length, descWords.length);

            // Only consider duplicate if more than 70% of significant words match
            if (matchRatio > 0.7) return true;
        }
        return false;
    } else if (sectionType === 'witnesses') {
        checkText = suggestion.name.toLowerCase().trim();
        return Array.from(existingItems).some(item => item.includes(checkText) || checkText.includes(item));
    }
    return false;
}

function addItemToList(itemText, sectionType, itemId) {
    // Show the container if it was hidden (d-none)
    const container = document.getElementById('defendantsListContainer');
    if (container) {
        container.classList.remove('d-none');
    }

    const list = document.getElementById('defendantsList');
    if (!list && container) {
        // Create the list element if it doesn't exist
        const newList = document.createElement('div');
        newList.className = 'list-group mb-3';
        newList.id = 'defendantsList';
        container.appendChild(newList);
    }

    const listElement = document.getElementById('defendantsList');
    if (listElement) {
        const documentId = {{ document.id }};

        // Build action buttons HTML
        let actionsHtml = '';
        if (itemId) {
            const deleteUrl = `/documents/${documentId}/section/${sectionType}/delete/${itemId}/`;
            let editUrl = '';
            if (sectionType === 'evidence') {
                editUrl = `/documents/${documentId}/evidence/${itemId}/edit/`;
            } else if (sectionType === 'witnesses') {
                editUrl = `/documents/${documentId}/witness/${itemId}/edit/`;
            } else if (sectionType === 'defendants') {
                editUrl = `/documents/${documentId}/defendant/${itemId}/edit/`;
            }

            actionsHtml = `
                <div class="d-flex gap-2">
                    ${editUrl ? `<a href="${editUrl}" class="btn btn-primary btn-sm"><i class="bi bi-pencil me-1"></i>Edit</a>` : ''}
                    <a href="${deleteUrl}" class="btn btn-outline-danger btn-sm" onclick="return confirm('Delete this item?')">
                        <i class="bi bi-trash"></i>
                    </a>
                </div>
            `;
        }

        // Create new item
        const newItem = document.createElement('div');
        newItem.className = 'list-group-item list-group-item-success';
        newItem.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <strong>${escapeHtml(itemText)}</strong>
                    <span class="badge bg-success ms-2">Just Added</span>
                </div>
                ${actionsHtml}
            </div>
        `;

        // Add to top of list
        listElement.insertBefore(newItem, listElement.firstChild);

        // Scroll to the new item
        newItem.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // Flash animation
        newItem.style.transition = 'background-color 0.5s';
        setTimeout(() => {
            newItem.style.backgroundColor = '#d4edda';
            setTimeout(() => {
                newItem.style.backgroundColor = '';
            }, 2000);
        }, 100);

        // Update counter in header
        const header = document.getElementById('defendantsListHeader');
        if (header) {
            const match = header.textContent.match(/\((\d+)\)/);
            if (match) {
                const newCount = parseInt(match[1]) + 1;
                header.textContent = header.textContent.replace(/\(\d+\)/, `(${newCount})`);
            }
        }
    }
}

function addWitnessSuggestion(suggestion, buttonElement) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const itemKey = `witness:${suggestion.name}`;

    // Check for duplicate
    if (addedItems.has(itemKey)) {
        alert('This witness has already been added.');
        return;
    }

    if (buttonElement) {
        buttonElement.disabled = true;
        buttonElement.innerHTML = '<i class="bi bi-hourglass-split"></i>';
    }

    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', csrfToken);
    formData.append('name', suggestion.name || '');
    formData.append('relationship', suggestion.relationship || '');
    formData.append('what_they_witnessed', suggestion.what_they_witnessed || '');
    formData.append('contact_info', suggestion.contact_info || '');

    fetch('/documents/{{ document.id }}/section/witnesses/add/', {
        method: 'POST',
        body: formData,
    })
    .then(response => {
        if (response.ok || response.redirected) {
            // Mark as added to prevent duplicates
            addedItems.add(itemKey);

            if (buttonElement) {
                const card = buttonElement.closest('.suggestion-item');
                if (card) {
                    card.classList.add('border-success', 'bg-success', 'bg-opacity-10');
                    buttonElement.outerHTML = '<span class="badge bg-success"><i class="bi bi-check-lg me-1"></i>Added</span>';
                }
            }

            // Add to the list dynamically
            addItemToList(suggestion.name || 'Witness', 'witnesses');
            showAddedNotification('Witness added successfully!');
        } else {
            throw new Error('Failed to add witness');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (buttonElement) {
            buttonElement.disabled = false;
            buttonElement.innerHTML = '<i class="bi bi-plus-lg me-1"></i>Add';
            buttonElement.classList.remove('btn-success');
            buttonElement.classList.add('btn-danger');
        }
        alert('Failed to add witness. Please try again.');
    });
}

function addEvidenceSuggestion(suggestion, buttonElement) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const itemKey = `evidence:${suggestion.description}`;

    // Check for duplicate
    if (addedItems.has(itemKey)) {
        alert('This evidence has already been added.');
        return;
    }

    if (buttonElement) {
        buttonElement.disabled = true;
        buttonElement.innerHTML = '<i class="bi bi-hourglass-split"></i>';
    }

    // Map AI evidence types to form evidence types
    const typeMap = {
        'video': 'video',
        'audio': 'audio',
        'document': 'document',
        'physical': 'physical',
        'digital': 'digital',
        'photo': 'photo',
        'witness_statement': 'witness_statement'
    };

    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', csrfToken);
    formData.append('evidence_type', typeMap[suggestion.evidence_type] || 'other');
    formData.append('title', suggestion.description || '');
    formData.append('description', suggestion.description || '');
    // Handle both old format (how_to_obtain/importance) and new format (details)
    let notes = '';
    if (suggestion.details) {
        notes = suggestion.details;
    } else if (suggestion.how_to_obtain || suggestion.importance) {
        notes = `How to obtain: ${suggestion.how_to_obtain || 'Unknown'}\nImportance: ${suggestion.importance || 'Unknown'}`;
    }
    formData.append('notes', notes);

    fetch('/documents/{{ document.id }}/section/evidence/add/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        } else {
            throw new Error('Failed to add evidence');
        }
    })
    .then(data => {
        if (data.success) {
            // Mark as added to prevent duplicates
            addedItems.add(itemKey);

            if (buttonElement) {
                const card = buttonElement.closest('.suggestion-item');
                if (card) {
                    card.classList.add('border-success', 'bg-success', 'bg-opacity-10');
                    buttonElement.outerHTML = '<span class="badge bg-success"><i class="bi bi-check-lg me-1"></i>Added</span>';
                }
            }

            // Add to the list dynamically with the item ID for delete button
            addItemToList(data.item_str || suggestion.description || 'Evidence', 'evidence', data.item_id);
            showAddedNotification('Evidence added successfully!');
        } else {
            throw new Error('Failed to add evidence');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (buttonElement) {
            buttonElement.disabled = false;
            buttonElement.innerHTML = '<i class="bi bi-plus-lg me-1"></i>Add';
            buttonElement.classList.remove('btn-success');
            buttonElement.classList.add('btn-danger');
        }
        alert('Failed to add evidence. Please try again.');
    });
}
</script>
{% endif %}
{% if section.section_type == 'rights_violated' %}
<script src="{% static 'js/rights-analyze.js' %}"></script>
{% endif %}
{% if section.section_type == 'defendants' %}
<script>
function saveDefendantAjax() {
    const btn = document.getElementById('saveDefendantBtn');
    const feedbackDiv = document.getElementById('saveDefendantFeedback');
    const form = btn.closest('form');

    // Get form values
    const nameField = form.querySelector('[name="name"]');
    const name = nameField ? nameField.value.trim() : '';

    // Validate - at least name is required
    if (!name) {
        feedbackDiv.innerHTML = '<div class="alert alert-warning py-2"><i class="bi bi-exclamation-triangle me-1"></i>Please enter at least the defendant\'s name.</div>';
        feedbackDiv.style.display = 'block';
        return;
    }

    // Disable button and show loading
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Saving...';
    feedbackDiv.style.display = 'none';

    // Build form data from the form fields
    const formData = new FormData(form);

    // Submit via AJAX
    fetch('{% url "documents:add_multiple_item" document.id "defendants" %}', {
        method: 'POST',
        body: formData,
    })
    .then(response => {
        if (response.ok || response.redirected) {
            // Success - show feedback and clear form
            feedbackDiv.innerHTML = '<div class="alert alert-success py-2"><i class="bi bi-check-circle me-1"></i>Defendant added successfully!</div>';
            feedbackDiv.style.display = 'block';

            // Clear form fields
            form.querySelectorAll('input[type="text"], textarea, select').forEach(field => {
                if (field.name !== 'csrfmiddlewaretoken') {
                    if (field.tagName === 'SELECT') {
                        field.selectedIndex = 0;
                    } else {
                        field.value = '';
                    }
                }
            });

            // Update the defendant list
            updateDefendantsList();

            // Hide success message after 3 seconds
            setTimeout(() => {
                feedbackDiv.style.display = 'none';
            }, 3000);
        } else {
            throw new Error('Failed to add defendant');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        feedbackDiv.innerHTML = '<div class="alert alert-danger py-2"><i class="bi bi-x-circle me-1"></i>Failed to add defendant. Please try again.</div>';
        feedbackDiv.style.display = 'block';
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-plus-lg me-1"></i>Save Defendant';
    });
}

// Store suggestions globally so we can reference them by index
let currentSuggestions = [];

function suggestAgency() {
    const btn = document.getElementById('suggestAgencyBtn');
    const suggestionsDiv = document.getElementById('agencySuggestions');
    const suggestionsBody = document.getElementById('agencySuggestionsBody');

    // Get form values
    const nameField = document.querySelector('[name="name"]');
    const titleField = document.querySelector('[name="title_rank"]');
    const agencyField = document.querySelector('[name="agency_name"]');
    const descField = document.querySelector('[name="description"]');

    // Disable button and show loading
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Searching...';
    suggestionsDiv.style.display = 'none';

    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch('{% url "documents:suggest_agency" document.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({
            defendant_name: nameField ? nameField.value : '',
            title: titleField ? titleField.value : '',
            description: descField ? descField.value : '',
        })
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-search me-1"></i>Suggest Agency';

        if (data.success && data.suggestions && data.suggestions.length > 0) {
            // Update AI usage banner if info provided
            if (data.ai_usage_display) {
                updateAIUsageBanner(data.ai_usage_display);
            }

            // Store suggestions globally
            currentSuggestions = data.suggestions;

            // Show verification warning prominently
            let html = '';
            if (data.verification_warning) {
                html += `<div class="alert alert-danger mb-3">
                    <h6 class="alert-heading"><i class="bi bi-exclamation-triangle-fill me-2"></i>VERIFICATION REQUIRED</h6>
                    <p class="mb-0 small">${escapeHtml(data.verification_warning)}</p>
                </div>`;
            }

            // Show county info if available
            if (data.has_local_police === false && data.county_name) {
                html += `<div class="alert alert-warning mb-3">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    <strong>${escapeHtml(data.county_name)} County</strong> - This location may not have its own police department.
                    Check for County Sheriff's Office.
                </div>`;
            }

            html += '<p class="small text-muted mb-3"><strong>How to add defendants:</strong> Click "Add" for each defendant. After adding, click "Edit" next to each defendant to verify and lookup their official address for serving legal documents.</p>';

            data.suggestions.forEach((suggestion, index) => {
                const confidenceColor = suggestion.confidence === 'high' ? 'success' :
                                       suggestion.confidence === 'medium' ? 'warning' : 'secondary';
                const isAgency = suggestion.defendant_type === 'agency';
                const typeIcon = isAgency ? 'bi-building' : 'bi-person';
                const typeLabel = isAgency ? 'Government Agency' : 'Individual Officer';
                const typeBadgeColor = isAgency ? 'primary' : 'info';
                const hasAddress = suggestion.address && suggestion.address.trim();

                html += `
                    <div class="mb-2 p-3 border rounded suggestion-item ${isAgency ? 'border-primary' : 'border-info'}" data-suggestion-index="${index}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <span class="badge bg-${typeBadgeColor} mb-1"><i class="${typeIcon} me-1"></i>${typeLabel}</span>
                                <br><strong>${escapeHtml(suggestion.name)}</strong>
                                ${!isAgency && suggestion.agency_name ? `<br><small class="text-muted"><i class="bi bi-building me-1"></i>Agency: ${escapeHtml(suggestion.agency_name)}</small>` : ''}
                                ${suggestion.title_rank ? `<br><small class="text-muted"><i class="bi bi-person-badge me-1"></i>Title: ${escapeHtml(suggestion.title_rank)}</small>` : ''}
                                ${hasAddress ? `<br><small class="text-primary"><i class="bi bi-geo-alt me-1"></i>${escapeHtml(suggestion.address)}</small>` : `<br><small class="text-warning"><i class="bi bi-geo-alt me-1"></i>Address needed - use "Edit" → "Lookup Address" after adding</small>`}
                                <br><small class="text-muted">${escapeHtml(suggestion.reason)}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-${confidenceColor}">${suggestion.confidence}</span>
                                <br><button type="button" class="btn btn-sm btn-success mt-1 add-suggestion-btn" data-index="${index}">
                                    <i class="bi bi-plus-lg me-1"></i>Add
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            if (data.notes) {
                html += `<div class="alert alert-warning small mt-2 mb-0"><i class="bi bi-exclamation-triangle me-1"></i>${escapeHtml(data.notes)}</div>`;
            }

            suggestionsBody.innerHTML = html;
            suggestionsDiv.style.display = 'block';

            // Attach click handlers to all add buttons
            suggestionsBody.querySelectorAll('.add-suggestion-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    acceptDefendantSuggestion(currentSuggestions[index], this);
                });
            });
        } else if (data.limit_reached) {
            // AI limit reached - show upgrade message
            suggestionsBody.innerHTML = `
                <div class="alert alert-warning mb-0">
                    <div class="text-center">
                        <i class="bi bi-exclamation-triangle-fill text-warning" style="font-size: 2rem;"></i>
                        <h6 class="mt-2">AI Limit Reached</h6>
                        <p class="small mb-2">${escapeHtml(data.error)}</p>
                        <a href="/documents/{{ document.id }}/checkout/" class="btn btn-primary btn-sm">
                            <i class="bi bi-unlock me-1"></i>Upgrade Now
                        </a>
                    </div>
                </div>`;
            suggestionsDiv.style.display = 'block';
        } else {
            suggestionsBody.innerHTML = `<div class="alert alert-warning mb-0">
                <i class="bi bi-exclamation-triangle me-1"></i>
                ${data.error || 'No suggestions found. Make sure the Incident Overview section has a city and state.'}
            </div>`;
            suggestionsDiv.style.display = 'block';
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-search me-1"></i>Suggest Agency';
        console.error('Error:', error);
        suggestionsBody.innerHTML = `<div class="alert alert-danger mb-0">
            <i class="bi bi-x-circle me-1"></i>Network error. Please try again.
        </div>`;
        suggestionsDiv.style.display = 'block';
    });
}

// Helper function to escape HTML to prevent XSS
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function acceptDefendantSuggestion(suggestion, buttonElement) {
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Disable the button and show loading
    if (buttonElement) {
        buttonElement.disabled = true;
        buttonElement.innerHTML = '<i class="bi bi-hourglass-split"></i>';
    }

    // Build form data
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', csrfToken);
    formData.append('defendant_type', suggestion.defendant_type || 'individual');
    formData.append('name', suggestion.name || '');
    formData.append('title_rank', suggestion.title_rank || '');
    formData.append('agency_name', suggestion.agency_name || '');
    formData.append('address', suggestion.address || '');
    formData.append('badge_number', '');
    formData.append('description', '');

    // Submit via AJAX
    fetch('{% url "documents:add_multiple_item" document.id "defendants" %}', {
        method: 'POST',
        body: formData,
    })
    .then(response => {
        if (response.ok || response.redirected) {
            // Success - mark this suggestion as added
            if (buttonElement) {
                const card = buttonElement.closest('.suggestion-item');
                if (card) {
                    card.classList.remove('border-primary', 'border-info');
                    card.classList.add('border-success', 'bg-success', 'bg-opacity-10');
                    buttonElement.outerHTML = '<span class="badge bg-success"><i class="bi bi-check-lg me-1"></i>Added</span>';
                }
            }
            // Update the defendant count/list by refreshing just that section
            updateDefendantsList();
        } else {
            throw new Error('Failed to add defendant');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (buttonElement) {
            buttonElement.disabled = false;
            buttonElement.innerHTML = '<i class="bi bi-plus-lg me-1"></i>Add';
            buttonElement.classList.remove('btn-success');
            buttonElement.classList.add('btn-danger');
        }
        alert('Failed to add defendant. Please try again.');
    });
}

function updateDefendantsList() {
    // Fetch the updated defendants list and refresh the display
    fetch(window.location.href)
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            // Get the new container from fetched page
            const newContainer = doc.querySelector('#defendantsListContainer');
            const currentContainer = document.querySelector('#defendantsListContainer');

            if (newContainer) {
                if (currentContainer) {
                    // Replace existing container with new one
                    currentContainer.outerHTML = newContainer.outerHTML;
                } else {
                    // No list exists yet - insert the new container before the "Add New" section
                    const addNewHeader = document.querySelector('h5 i.bi-plus-circle');
                    if (addNewHeader) {
                        addNewHeader.closest('h5').insertAdjacentHTML('beforebegin', newContainer.outerHTML);
                    }
                }
            }
        })
        .catch(err => console.log('Could not refresh list:', err));
}

// Legacy function for backwards compatibility
function acceptAgencySuggestion(agencyName, agencyAddress) {
    acceptDefendantSuggestion({
        agency_name: agencyName,
        address: agencyAddress
    }, null);
}

// Add hover effect styles
document.addEventListener('DOMContentLoaded', function() {
    const style = document.createElement('style');
    style.textContent = `
        .suggestion-item:hover {
            background-color: #f8f9fa;
            border-color: #198754 !important;
        }
    `;
    document.head.appendChild(style);
});
</script>
{% endif %}

{% if section.section_type == 'evidence' and can_use_video_analysis %}
<script>
// YouTube Video Linking Modal Handler
(function() {
    'use strict';

    let currentEvidenceId = null;
    const modal = document.getElementById('linkYouTubeModal');

    if (!modal) return;

    // When modal is shown, store the evidence ID and title
    modal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        currentEvidenceId = button.getAttribute('data-evidence-id');
        const evidenceTitle = button.getAttribute('data-evidence-title');

        document.getElementById('linkYouTubeEvidenceTitle').textContent = evidenceTitle;
        document.getElementById('youtubeUrlInput').value = '';
        document.getElementById('linkYouTubeError').classList.add('d-none');
        document.getElementById('linkYouTubeSuccess').classList.add('d-none');
        document.getElementById('linkYouTubeSubmit').disabled = false;
    });

    // Handle submit button click
    document.getElementById('linkYouTubeSubmit').addEventListener('click', function() {
        const youtubeUrl = document.getElementById('youtubeUrlInput').value.trim();
        const errorDiv = document.getElementById('linkYouTubeError');
        const successDiv = document.getElementById('linkYouTubeSuccess');
        const submitBtn = document.getElementById('linkYouTubeSubmit');

        // Basic validation
        if (!youtubeUrl) {
            errorDiv.textContent = 'Please enter a YouTube URL';
            errorDiv.classList.remove('d-none');
            return;
        }

        // Check if it looks like a YouTube URL
        if (!youtubeUrl.includes('youtube.com') && !youtubeUrl.includes('youtu.be')) {
            errorDiv.textContent = 'Please enter a valid YouTube URL (e.g., https://www.youtube.com/watch?v=...)';
            errorDiv.classList.remove('d-none');
            return;
        }

        // Disable button and show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Linking...';
        errorDiv.classList.add('d-none');

        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Make API request
        fetch(`/documents/{{ document.id }}/evidence/${currentEvidenceId}/link-youtube/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ youtube_url: youtubeUrl })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                successDiv.classList.remove('d-none');
                // Redirect to video analysis page after a short delay
                setTimeout(function() {
                    window.location.href = data.redirect_url || `/documents/{{ document.id }}/video-analysis/`;
                }, 1500);
            } else {
                errorDiv.textContent = data.error || 'Failed to link video. Please try again.';
                errorDiv.classList.remove('d-none');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-link-45deg me-1"></i>Link Video';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            errorDiv.textContent = 'Network error. Please try again.';
            errorDiv.classList.remove('d-none');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-link-45deg me-1"></i>Link Video';
        });
    });
})();

// Quick Add YouTube Video Handler
(function() {
    'use strict';

    const quickAddBtn = document.getElementById('quickAddYouTubeBtn');
    const dismissBtn = document.getElementById('dismissYouTubeCard');
    const card = document.getElementById('quickAddYouTubeCard');

    if (!quickAddBtn) return;

    // Dismiss card handler
    if (dismissBtn) {
        dismissBtn.addEventListener('click', function() {
            card.style.display = 'none';
        });
    }

    // Quick add handler
    quickAddBtn.addEventListener('click', function() {
        const youtubeUrl = document.getElementById('quickYouTubeUrl').value.trim();
        const errorDiv = document.getElementById('quickYouTubeError');
        const successDiv = document.getElementById('quickYouTubeSuccess');

        // Reset states
        errorDiv.classList.add('d-none');
        successDiv.classList.add('d-none');

        // Basic validation
        if (!youtubeUrl) {
            errorDiv.textContent = 'Please enter a YouTube URL';
            errorDiv.classList.remove('d-none');
            return;
        }

        // Check if it looks like a YouTube URL
        if (!youtubeUrl.includes('youtube.com') && !youtubeUrl.includes('youtu.be')) {
            errorDiv.textContent = 'Please enter a valid YouTube URL (e.g., https://www.youtube.com/watch?v=...)';
            errorDiv.classList.remove('d-none');
            return;
        }

        // Disable button and show loading state
        quickAddBtn.disabled = true;
        quickAddBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Adding...';

        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Make API request to quick add endpoint
        fetch('{% url "documents:quick_add_youtube_evidence" document.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ youtube_url: youtubeUrl })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                successDiv.classList.remove('d-none');
                // Redirect to video analysis page after a short delay
                setTimeout(function() {
                    window.location.href = data.redirect_url || '/documents/{{ document.id }}/video-analysis/';
                }, 1500);
            } else {
                errorDiv.textContent = data.error || 'Failed to add video. Please try again.';
                errorDiv.classList.remove('d-none');
                quickAddBtn.disabled = false;
                quickAddBtn.innerHTML = '<i class="bi bi-plus-lg me-1"></i>Add Video Evidence';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            errorDiv.textContent = 'Network error. Please try again.';
            errorDiv.classList.remove('d-none');
            quickAddBtn.disabled = false;
            quickAddBtn.innerHTML = '<i class="bi bi-plus-lg me-1"></i>Add Video Evidence';
        });
    });
})();

// Video Evidence Analysis Handler
(function() {
    'use strict';

    const analyzeBtn = document.getElementById('analyzeVideoBtn');
    const loadingDiv = document.getElementById('analyzeVideoLoading');
    const errorDiv = document.getElementById('analyzeVideoError');
    const suggestionsPanel = document.getElementById('videoSuggestionsPanel');
    const suggestionsList = document.getElementById('videoSuggestionsList');
    const summaryDiv = document.getElementById('videoSuggestionsSummary');
    const closeBtn = document.getElementById('closeSuggestionsPanel');

    if (!analyzeBtn) return;

    // Close suggestions panel
    if (closeBtn) {
        closeBtn.addEventListener('click', function() {
            suggestionsPanel.classList.add('d-none');
        });
    }

    analyzeBtn.addEventListener('click', function() {
        // Show loading, hide error
        loadingDiv.classList.remove('d-none');
        errorDiv.classList.add('d-none');
        suggestionsPanel.classList.add('d-none');
        analyzeBtn.disabled = true;

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch('{% url "documents:analyze_video_evidence" document.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            loadingDiv.classList.add('d-none');
            analyzeBtn.disabled = false;

            if (data.success) {
                displaySuggestions(data);
            } else {
                errorDiv.textContent = data.error || 'Failed to analyze video evidence.';
                errorDiv.classList.remove('d-none');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            loadingDiv.classList.add('d-none');
            analyzeBtn.disabled = false;
            errorDiv.textContent = 'Network error. Please try again.';
            errorDiv.classList.remove('d-none');
        });
    });

    function displaySuggestions(data) {
        // Show summary
        summaryDiv.innerHTML = `<i class="bi bi-info-circle me-1"></i>${data.summary || 'Analysis complete.'} <strong>(${data.transcript_count} transcript${data.transcript_count !== 1 ? 's' : ''} analyzed)</strong>`;

        // Build suggestions HTML
        const suggestions = data.suggestions || [];
        if (suggestions.length === 0) {
            suggestionsList.innerHTML = '<p class="text-muted">No specific suggestions found. Your video transcripts may not contain content relevant to a Section 1983 claim.</p>';
        } else {
            let html = '';
            suggestions.forEach((s, idx) => {
                const sectionLabel = getSectionLabel(s.section);
                const sectionBadgeClass = getSectionBadgeClass(s.section);

                html += `
                    <div class="card mb-3 video-suggestion-card" data-suggestion-idx="${idx}">
                        <div class="card-header py-2 d-flex justify-content-between align-items-center">
                            <span class="badge ${sectionBadgeClass}">${sectionLabel}</span>
                            <small class="text-muted">${escapeHtml(s.timestamp_ref || '')}</small>
                        </div>
                        <div class="card-body py-2">
                            <blockquote class="blockquote mb-2" style="font-size: 0.9rem; border-left: 3px solid #6c757d; padding-left: 1rem;">
                                "${escapeHtml(s.quote || '')}"
                            </blockquote>
                            <p class="mb-2"><strong>Suggested text:</strong></p>
                            <div class="suggested-text-preview p-2 bg-light rounded mb-2" style="font-size: 0.9rem;">
                                ${escapeHtml(s.suggested_text || '')}
                            </div>
                            ${s.youtube_link ? `<p class="mb-2"><small><a href="${escapeHtml(s.youtube_link)}" target="_blank" class="text-decoration-none"><i class="bi bi-youtube me-1"></i>Watch clip</a></small></p>` : ''}
                            <p class="text-muted small mb-2"><i class="bi bi-lightbulb me-1"></i>${escapeHtml(s.explanation || '')}</p>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-success btn-sm apply-suggestion-btn"
                                        data-section="${s.section}"
                                        data-text="${escapeHtml(s.suggested_text || '')}"
                                        data-timestamp="${escapeHtml(s.timestamp_ref || '')}">
                                    <i class="bi bi-check-lg me-1"></i>Apply to ${sectionLabel}
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm copy-suggestion-btn"
                                        data-text="${escapeHtml(s.suggested_text || '')}">
                                    <i class="bi bi-clipboard me-1"></i>Copy
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            suggestionsList.innerHTML = html;

            // Add click handlers for apply buttons
            suggestionsList.querySelectorAll('.apply-suggestion-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    applySuggestion(this);
                });
            });

            // Add click handlers for copy buttons
            suggestionsList.querySelectorAll('.copy-suggestion-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const text = this.getAttribute('data-text');
                    navigator.clipboard.writeText(text).then(() => {
                        this.innerHTML = '<i class="bi bi-check-lg me-1"></i>Copied!';
                        setTimeout(() => {
                            this.innerHTML = '<i class="bi bi-clipboard me-1"></i>Copy';
                        }, 2000);
                    });
                });
            });
        }

        suggestionsPanel.classList.remove('d-none');
        suggestionsPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function getSectionLabel(section) {
        const labels = {
            'narrative': 'Incident Narrative',
            'evidence': 'Evidence Description',
            'rights_violated': 'Rights Violated',
            'damages': 'Damages'
        };
        return labels[section] || section;
    }

    function getSectionBadgeClass(section) {
        const classes = {
            'narrative': 'bg-primary',
            'evidence': 'bg-info',
            'rights_violated': 'bg-danger',
            'damages': 'bg-warning text-dark'
        };
        return classes[section] || 'bg-secondary';
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function applySuggestion(btn) {
        const section = btn.getAttribute('data-section');
        const text = btn.getAttribute('data-text');
        const timestamp = btn.getAttribute('data-timestamp');

        // Build the text to add with timestamp reference
        const fullText = timestamp ? `${text} ${timestamp}` : text;

        // Get section label and URL for display
        const sectionLabel = getSectionLabel(section);
        const sectionUrls = {
            'narrative': '{% url "documents:section_edit" document.id "incident_narrative" %}',
            'evidence': window.location.href,
            'rights_violated': '{% url "documents:section_edit" document.id "rights_violated" %}',
            'damages': '{% url "documents:section_edit" document.id "damages" %}'
        };

        const card = btn.closest('.video-suggestion-card');

        // For evidence section, just copy (can't auto-insert to specific item)
        if (section === 'evidence') {
            navigator.clipboard.writeText(fullText).then(() => {
                btn.innerHTML = '<i class="bi bi-check-lg me-1"></i>Copied! Paste in evidence description';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-secondary');
                btn.disabled = true;
                card.style.opacity = '0.7';
            });
            return;
        }

        // Show loading state
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Adding...';

        // Call API to insert text directly
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch('{% url "documents:apply_video_suggestion" document.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ section: section, text: fullText })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success with link to view
                btn.outerHTML = `
                    <span class="text-success me-2"><i class="bi bi-check-circle-fill me-1"></i>${data.message}</span>
                    <a href="${data.section_url}" class="btn btn-outline-success btn-sm">
                        <i class="bi bi-eye me-1"></i>View
                    </a>
                `;
                card.style.opacity = '0.7';
                card.classList.add('applied-suggestion');
            } else if (data.copy_only) {
                // Fallback to copy
                navigator.clipboard.writeText(fullText);
                btn.innerHTML = '<i class="bi bi-check-lg me-1"></i>Copied! Paste manually';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-secondary');
                btn.disabled = true;
            } else {
                btn.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Failed';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-danger');
                console.error(data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            btn.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Error';
            btn.classList.remove('btn-success');
            btn.classList.add('btn-danger');
        });
    }
})();
</script>
{% endif %}

{% endblock %}

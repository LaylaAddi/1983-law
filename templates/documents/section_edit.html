{% extends 'base.html' %}
{% load static %}

{% block title %}{{ config.title }} - {{ document.title }} - {{ header_app_name }}{% endblock %}

{% block extra_css %}
{% if section.section_type == 'incident_narrative' %}
<link rel="stylesheet" href="{% static 'css/rewrite.css' %}">
{% elif section.section_type == 'rights_violated' %}
<link rel="stylesheet" href="{% static 'css/rights-analyze.css' %}">
{% endif %}
<style>
    .section-status-badge {
        font-size: 0.9rem;
    }
    .needs-work-highlight {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    .interview-card {
        border-left: 4px solid #0d6efd;
    }
    .interview-card.needs-work {
        border-left-color: #ffc107;
        background-color: #fffbf0;
    }
    .interview-card.completed {
        border-left-color: #198754;
    }
    .interview-card.not-applicable {
        border-left-color: #6c757d;
        background-color: #f8f9fa;
    }
    /* Help section styles */
    .help-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
    }
    .help-section .card-header {
        background: transparent;
        border-bottom: none;
        cursor: pointer;
    }
    .help-section .card-header:hover {
        background: rgba(0,0,0,0.02);
    }
    .help-section .help-icon {
        background: #0d6efd;
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.5rem;
    }
    .help-tips {
        background: white;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-top: 0.5rem;
    }
    .help-tips li {
        margin-bottom: 0.5rem;
    }
    .help-tips li:last-child {
        margin-bottom: 0;
    }
    .help-example {
        background: #e7f1ff;
        border-left: 3px solid #0d6efd;
        padding: 1rem;
        margin-top: 1rem;
        border-radius: 0 0.375rem 0.375rem 0;
    }
    .amendment-card {
        background: white;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 0.75rem;
    }
    .amendment-card h6 {
        color: #0d6efd;
        margin-bottom: 0.5rem;
    }
    /* Tooltip styles */
    .field-tooltip {
        color: #6c757d;
        cursor: help;
        margin-left: 0.25rem;
    }
    .field-tooltip:hover {
        color: #0d6efd;
    }
    /* Relief type cards */
    .relief-type {
        background: #f8f9fa;
        border-radius: 0.375rem;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
    }
    .relief-type strong {
        color: #0d6efd;
    }
    /* Attorney fields section */
    .attorney-section {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 1.25rem;
        margin-top: 1rem;
        margin-bottom: 1rem;
    }
    .attorney-section-header {
        color: #495057;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #dee2e6;
    }
    .attorney-section-header i {
        color: #0d6efd;
    }
    .attorney-field {
        /* Used to identify attorney fields for show/hide */
    }
</style>
{% endblock %}

{% block content %}
{% include 'documents/partials/status_banner.html' %}

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'documents:document_list' %}">Documents</a></li>
        <li class="breadcrumb-item"><a href="{% url 'documents:document_detail' document.id %}">{{ document.title|truncatechars:30 }}</a></li>
        <li class="breadcrumb-item active">{{ config.title }}</li>
    </ol>
</nav>

<div class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
        <!-- Help Section (Collapsible) -->
        {% if help_content %}
        <div class="card help-section">
            <div class="card-header" data-bs-toggle="collapse" data-bs-target="#helpContent" aria-expanded="false">
                <div class="d-flex justify-content-between align-items-center">
                    <span>
                        <span class="help-icon"><i class="bi bi-question-lg"></i></span>
                        <strong>Learn More About This Section</strong>
                    </span>
                    <i class="bi bi-chevron-down" id="helpChevron"></i>
                </div>
            </div>
            <div class="collapse" id="helpContent">
                <div class="card-body pt-0">
                    <!-- Overview -->
                    {% if help_content.overview %}
                    <div class="mb-3">
                        {{ help_content.overview|safe }}
                    </div>
                    {% endif %}

                    <!-- Why Important -->
                    {% if help_content.why_important %}
                    <div class="mb-3">
                        {{ help_content.why_important|safe }}
                    </div>
                    {% endif %}

                    <!-- Recommended Note (for relief_sought section) -->
                    {% if help_content.recommended_note %}
                    <div class="mb-3">
                        {{ help_content.recommended_note|safe }}
                    </div>
                    {% endif %}

                    <!-- Tips -->
                    {% if help_content.tips %}
                    <div class="help-tips">
                        <strong><i class="bi bi-lightbulb me-2"></i>Tips:</strong>
                        <ul class="mb-0 mt-2">
                            {% for tip in help_content.tips %}
                            <li>{{ tip|safe }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <!-- Simple Explanations / FAQ (for relief_sought section) -->
                    {% if help_content.simple_explanations %}
                    <div class="mt-3">
                        <strong><i class="bi bi-question-circle me-2"></i>Common Questions:</strong>
                        <div class="accordion mt-2" id="faqAccordion">
                            {% for faq in help_content.simple_explanations %}
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#faq{{ forloop.counter }}">
                                        {{ faq.question }}
                                    </button>
                                </h2>
                                <div id="faq{{ forloop.counter }}" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                    <div class="accordion-body small">
                                        {{ faq.answer|safe }}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Amendment Info (for rights_violated section) -->
                    {% if help_content.amendments %}
                    <div class="mt-3">
                        <strong><i class="bi bi-book me-2"></i>Understanding Your Rights:</strong>
                        <div class="mt-2">
                            {% for key, amendment in help_content.amendments.items %}
                            <div class="amendment-card">
                                <h6>{{ amendment.name }}</h6>
                                <p class="mb-2"><strong>Protects:</strong> {{ amendment.protects }}</p>
                                <p class="mb-1"><strong>Common Violations:</strong></p>
                                <ul class="mb-0 small">
                                    {% for violation in amendment.common_violations %}
                                    <li>{{ violation }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Relief Types (for relief_sought section) - removed, replaced by simple_explanations -->
                    {% if help_content.types_of_relief %}
                    <div class="mt-3">
                        <strong><i class="bi bi-currency-dollar me-2"></i>Types of Relief Explained:</strong>
                        <div class="mt-2">
                            {% for key, relief in help_content.types_of_relief.items %}
                            <div class="relief-type">
                                <strong>{{ relief.name }}:</strong>
                                <span class="small">{{ relief.description }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Example -->
                    {% if help_content.example %}
                    <div class="help-example">
                        {{ help_content.example|safe }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <div class="card interview-card {% if section.status == 'needs_work' %}needs-work{% elif section.status == 'completed' %}completed{% elif section.status == 'not_applicable' %}not-applicable{% endif %} shadow-sm mb-4">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">{{ config.title }}</h4>

                    {% if section.status == 'not_started' %}
                        <span class="badge bg-secondary section-status-badge">Not Started</span>
                    {% elif section.status == 'in_progress' %}
                        <span class="badge bg-info section-status-badge">In Progress</span>
                    {% elif section.status == 'needs_work' %}
                        <span class="badge bg-warning text-dark section-status-badge">
                            <i class="bi bi-exclamation-triangle me-1"></i>Needs Work
                        </span>
                    {% elif section.status == 'completed' %}
                        <span class="badge bg-success section-status-badge">
                            <i class="bi bi-check-lg me-1"></i>Completed
                        </span>
                    {% elif section.status == 'not_applicable' %}
                        <span class="badge bg-secondary section-status-badge">
                            <i class="bi bi-dash-lg me-1"></i>N/A
                        </span>
                    {% endif %}
                </div>
            </div>

            <div class="card-body">
                {% if section.status == 'needs_work' and section.notes %}
                    <div class="needs-work-highlight">
                        <strong><i class="bi bi-exclamation-triangle me-2"></i>Notes:</strong>
                        {{ section.notes }}
                    </div>
                {% endif %}

                <p class="text-muted mb-4">{{ config.description }}</p>

                {% if section.section_type == 'plaintiff_info' and is_profile_based %}
                <!-- Profile Data Display (Read-only) -->
                <div class="card bg-light mb-4">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-person-check-fill me-2"></i>Your Information (from Profile)</span>
                        <a href="{% url 'accounts:profile_edit' %}?next={{ request.path }}" class="btn btn-light btn-sm">
                            <i class="bi bi-pencil me-1"></i>Edit Profile
                        </a>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-muted mb-2">Name</h6>
                                <p class="mb-3">
                                    <strong>{{ user_profile.get_full_name }}</strong>
                                </p>

                                <h6 class="text-muted mb-2">Address</h6>
                                <p class="mb-3">
                                    {{ user_profile.street_address }}<br>
                                    {{ user_profile.city }}, {{ user_profile.state }} {{ user_profile.zip_code }}
                                </p>

                                {% if user_profile.use_different_mailing_address %}
                                <h6 class="text-muted mb-2">Mailing Address</h6>
                                <p class="mb-3">
                                    {{ user_profile.mailing_street_address }}<br>
                                    {{ user_profile.mailing_city }}, {{ user_profile.mailing_state }} {{ user_profile.mailing_zip_code }}
                                </p>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted mb-2">Phone</h6>
                                <p class="mb-3">{{ user_profile.phone }}</p>

                                <h6 class="text-muted mb-2">Email</h6>
                                <p class="mb-3">{{ user_profile.email }}</p>
                            </div>
                        </div>
                        <div class="alert alert-info mb-0 small">
                            <i class="bi bi-info-circle me-1"></i>
                            This information will appear on your legal documents exactly as shown. To make changes, click "Edit Profile" above.
                        </div>
                    </div>
                </div>

                <hr class="my-4">
                <h5 class="mb-3"><i class="bi bi-briefcase me-2"></i>Legal Representation</h5>
                <p class="text-muted mb-3">Are you representing yourself (pro se) or do you have an attorney?</p>
                {% endif %}


                {% if section.section_type == 'rights_violated' %}
                <!-- AI Analysis for Rights Violated -->
                <div class="alert alert-primary mb-4">
                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                        <div>
                            <strong><i class="bi bi-stars me-2"></i>Not sure which rights were violated?</strong>
                            <p class="mb-0 small">Let AI analyze your incident and suggest which constitutional rights apply to your case.</p>
                        </div>
                        <button type="button" class="btn btn-primary btn-sm" id="analyzeRightsBtn" data-document-id="{{ document.id }}">
                            <i class="bi bi-search me-1"></i>Analyze My Case
                        </button>
                    </div>
                </div>
                <div id="rightsAnalysisContainer"></div>
                {% endif %}

                {% if is_multiple %}
                    <!-- Multiple items section (defendants, witnesses, evidence) -->
                    <div class="alert alert-info mb-4">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-info-circle-fill me-2 mt-1"></i>
                            <div>
                                <strong>You can add multiple entries here.</strong>
                                <p class="mb-0 small">
                                    {% if section.section_type == 'defendants' %}
                                        Add each officer and agency separately. For example, if two officers from different departments violated your rights, add all four entries: both individual officers AND both agencies.
                                    {% elif section.section_type == 'witnesses' %}
                                        Add each witness who saw or heard what happened. Include bystanders, fellow auditors, or anyone who can support your account.
                                    {% elif section.section_type == 'evidence' %}
                                        Add each piece of evidence separately - your video, body camera footage, police reports, medical records, etc.
                                    {% else %}
                                        Fill out the form below and click "Add" to save each entry. You can add as many as needed.
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>

                    {% if items %}
                        <div class="mb-4">
                            <h5>Added Items</h5>
                            <div class="list-group mb-3">
                                {% for item in items %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>{{ item }}</span>
                                        <a href="{% url 'documents:delete_multiple_item' document.id section.section_type item.id %}"
                                           class="btn btn-outline-danger btn-sm"
                                           onclick="return confirm('Delete this item?')">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}

                    <h5>Add New</h5>
                    <form method="post" action="{% url 'documents:add_multiple_item' document.id section.section_type %}">
                        {% csrf_token %}
                        {% for field in form %}
                            <div class="mb-3">
                                <label for="{{ field.id_for_label }}" class="form-label">
                                    {{ field.label }}
                                    {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                                    {% with field_help=help_content.fields %}
                                        {% if field_help %}
                                            {% with tooltip=field_help|default_if_none:"" %}
                                                {% for fname, fdata in field_help.items %}
                                                    {% if fname == field.name and fdata.tooltip %}
                                                        <i class="bi bi-info-circle field-tooltip"
                                                           data-bs-toggle="tooltip"
                                                           data-bs-placement="top"
                                                           title="{{ fdata.tooltip }}"></i>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endwith %}
                                        {% endif %}
                                    {% endwith %}
                                </label>
                                {{ field }}
                                {% if help_content.fields %}
                                    {% for fname, fdata in help_content.fields.items %}
                                        {% if fname == field.name and fdata.help %}
                                            <div class="form-text">{{ fdata.help|safe }}</div>
                                        {% endif %}
                                    {% endfor %}
                                {% elif field.help_text %}
                                    <div class="form-text">{{ field.help_text }}</div>
                                {% endif %}
                                {% if field.errors %}
                                    <div class="invalid-feedback d-block">{{ field.errors.0 }}</div>
                                {% endif %}
                            </div>
                        {% endfor %}
                        <button type="submit" class="btn btn-outline-primary">
                            <i class="bi bi-plus-lg me-1"></i>Add
                        </button>
                    </form>

                {% elif section.section_type == 'relief_sought' %}
                    <!-- Custom Relief Sought Form -->
                    {% include 'documents/partials/relief_sought_form.html' %}

                {% else %}
                    <!-- Single item section -->
                    <form method="post">
                        {% csrf_token %}
                        {% for field in form %}
                            <div class="mb-3">
                                {% if field.field.widget.input_type == 'checkbox' %}
                                    <div class="form-check">
                                        {{ field }}
                                        <label class="form-check-label" for="{{ field.id_for_label }}">
                                            {{ field.label }}
                                            {% if help_content.fields %}
                                                {% for fname, fdata in help_content.fields.items %}
                                                    {% if fname == field.name and fdata.tooltip %}
                                                        <i class="bi bi-info-circle field-tooltip"
                                                           data-bs-toggle="tooltip"
                                                           data-bs-placement="top"
                                                           title="{{ fdata.tooltip }}"></i>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        </label>
                                        {% if help_content.fields %}
                                            {% for fname, fdata in help_content.fields.items %}
                                                {% if fname == field.name and fdata.help %}
                                                    <div class="form-text">{{ fdata.help|safe }}</div>
                                                {% endif %}
                                            {% endfor %}
                                        {% elif field.help_text %}
                                            <div class="form-text">{{ field.help_text }}</div>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <label for="{{ field.id_for_label }}" class="form-label">
                                        {{ field.label }}
                                        {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                                        {% if help_content.fields %}
                                            {% for fname, fdata in help_content.fields.items %}
                                                {% if fname == field.name and fdata.tooltip %}
                                                    <i class="bi bi-info-circle field-tooltip"
                                                       data-bs-toggle="tooltip"
                                                       data-bs-placement="top"
                                                       title="{{ fdata.tooltip }}"></i>
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                    </label>
                                    {{ field }}
                                    {% if help_content.fields %}
                                        {% for fname, fdata in help_content.fields.items %}
                                            {% if fname == field.name and fdata.help %}
                                                <div class="form-text">{{ fdata.help|safe }}</div>
                                            {% endif %}
                                        {% endfor %}
                                    {% elif field.help_text %}
                                        <div class="form-text">{{ field.help_text }}</div>
                                    {% endif %}
                                {% endif %}
                                {% if field.errors %}
                                    <div class="invalid-feedback d-block">{{ field.errors.0 }}</div>
                                {% endif %}
                            </div>
                        {% endfor %}

                        <hr class="my-4">

                        <div class="d-flex justify-content-between">
                            <button type="submit" name="save" class="btn btn-outline-primary">
                                <i class="bi bi-save me-1"></i>Save
                            </button>
                            <button type="submit" name="save_and_continue" class="btn btn-primary">
                                Save & Continue<i class="bi bi-arrow-right ms-1"></i>
                            </button>
                        </div>
                    </form>
                {% endif %}
            </div>
        </div>

        <!-- Navigation -->
        <div class="d-flex justify-content-between mb-4">
            {% if prev_section %}
                <a href="{% url 'documents:section_edit' document.id prev_section.section_type %}"
                   class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Previous
                </a>
            {% else %}
                <span></span>
            {% endif %}

            {% if next_section %}
                <a href="{% url 'documents:section_edit' document.id next_section.section_type %}"
                   class="btn btn-outline-secondary">
                    Next<i class="bi bi-arrow-right ms-1"></i>
                </a>
            {% else %}
                <a href="{% url 'documents:document_detail' document.id %}"
                   class="btn btn-success">
                    <i class="bi bi-check-lg me-1"></i>Finish
                </a>
            {% endif %}
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Section Status -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-flag me-2"></i>Section Status</h5>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'documents:update_section_status' document.id section.section_type %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Mark this section as:</label>
                        <select name="status" class="form-select">
                            {% for value, label in section.STATUS_CHOICES %}
                                <option value="{{ value }}" {% if section.status == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes (if needs work):</label>
                        <textarea name="notes" class="form-control" rows="2"
                                  placeholder="What needs to be fixed?">{{ section.notes }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-outline-primary btn-sm w-100">
                        Update Status
                    </button>
                </form>
            </div>
        </div>

        <!-- Quick Help -->
        <div class="card mb-4 border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-question-circle me-2"></i>Quick Help</h5>
            </div>
            <div class="card-body">
                <p class="small mb-2">
                    <i class="bi bi-info-circle text-primary me-1"></i>
                    Hover over <i class="bi bi-info-circle"></i> icons for quick explanations
                </p>
                <p class="small mb-2">
                    <i class="bi bi-lightbulb text-warning me-1"></i>
                    Click "Learn More" above for detailed guidance
                </p>
                <p class="small mb-0">
                    <i class="bi bi-dash-circle text-secondary me-1"></i>
                    Mark sections as "N/A" if they don't apply to your case
                </p>
            </div>
        </div>

        <!-- Section Progress -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>All Sections</h5>
            </div>
            <div class="list-group list-group-flush">
                {% for s in document.sections.all %}
                    <a href="{% url 'documents:section_edit' document.id s.section_type %}"
                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center
                              {% if s.section_type == section.section_type %}active{% endif %}
                              {% if s.status == 'needs_work' %}list-group-item-warning{% endif %}
                              {% if s.story_relevance == 'may_not_apply' and s.status == 'not_started' %}opacity-75{% endif %}">
                        <span class="{% if s.section_type == section.section_type %}fw-bold{% elif s.story_relevance == 'may_not_apply' and s.status == 'not_started' %}text-muted{% endif %}">
                            {{ s.get_section_type_display }}
                            {% if s.story_relevance == 'may_not_apply' and s.status == 'not_started' %}
                                <small class="d-block text-muted" style="font-size: 0.7rem;">May not apply</small>
                            {% endif %}
                        </span>
                        {% if s.status == 'completed' %}
                            <i class="bi bi-check-circle-fill text-success"></i>
                        {% elif s.status == 'needs_work' %}
                            <i class="bi bi-exclamation-triangle-fill text-warning"></i>
                        {% elif s.status == 'in_progress' %}
                            <i class="bi bi-circle-half text-info"></i>
                        {% elif s.status == 'not_applicable' %}
                            <i class="bi bi-dash-circle-fill text-secondary"></i>
                        {% else %}
                            <i class="bi bi-circle text-muted"></i>
                        {% endif %}
                    </a>
                {% endfor %}
            </div>
        </div>

        <!-- Preview Button -->
        <div class="card mt-4 border-primary">
            <div class="card-body text-center">
                <i class="bi bi-file-earmark-text display-6 text-primary mb-2"></i>
                <h6 class="card-title">Ready to Preview?</h6>
                <p class="card-text small text-muted mb-3">See your complaint as a professional legal document</p>
                <a href="{% url 'documents:document_preview' document.id %}" class="btn btn-primary w-100">
                    <i class="bi bi-eye me-1"></i>Preview Document
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize Bootstrap tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Rotate chevron on collapse toggle
    var helpContent = document.getElementById('helpContent');
    var helpChevron = document.getElementById('helpChevron');
    if (helpContent && helpChevron) {
        helpContent.addEventListener('show.bs.collapse', function () {
            helpChevron.style.transform = 'rotate(180deg)';
        });
        helpContent.addEventListener('hide.bs.collapse', function () {
            helpChevron.style.transform = 'rotate(0deg)';
        });
    }

    // Attorney toggle for plaintiff_info section
    var hasAttorneyCheckbox = document.getElementById('id_has_attorney');
    if (hasAttorneyCheckbox) {
        // Get all attorney field containers
        var attorneyFieldIds = [
            'id_attorney_name', 'id_attorney_bar_number', 'id_attorney_firm_name',
            'id_attorney_street_address', 'id_attorney_city', 'id_attorney_state',
            'id_attorney_zip_code', 'id_attorney_phone', 'id_attorney_fax', 'id_attorney_email'
        ];

        // Create a wrapper div for attorney fields
        var attorneySection = document.createElement('div');
        attorneySection.id = 'attorney-section';
        attorneySection.className = 'attorney-section';
        attorneySection.innerHTML = '<div class="attorney-section-header"><i class="bi bi-briefcase me-2"></i>Attorney Information</div>';

        var attorneyFieldsContainer = document.createElement('div');
        attorneyFieldsContainer.id = 'attorney-fields-container';
        attorneySection.appendChild(attorneyFieldsContainer);

        // Find and move attorney fields into the container
        var firstAttorneyField = null;
        attorneyFieldIds.forEach(function(fieldId) {
            var field = document.getElementById(fieldId);
            if (field) {
                var fieldContainer = field.closest('.mb-3');
                if (fieldContainer) {
                    if (!firstAttorneyField) {
                        firstAttorneyField = fieldContainer;
                    }
                    attorneyFieldsContainer.appendChild(fieldContainer);
                }
            }
        });

        // Insert the attorney section after the has_attorney checkbox container
        var hasAttorneyContainer = hasAttorneyCheckbox.closest('.mb-3');
        if (hasAttorneyContainer && attorneyFieldsContainer.children.length > 0) {
            hasAttorneyContainer.after(attorneySection);
        }

        // Function to toggle attorney fields visibility
        // Show when checked (has attorney), hide when unchecked (pro se)
        function toggleAttorneyFields() {
            if (hasAttorneyCheckbox.checked) {
                attorneySection.style.display = 'block';
            } else {
                attorneySection.style.display = 'none';
            }
        }

        // Initial toggle based on checkbox state
        toggleAttorneyFields();

        // Listen for changes
        hasAttorneyCheckbox.addEventListener('change', toggleAttorneyFields);
    }


    // District court lookup for incident_overview section
    var cityField = document.getElementById('id_city');
    var stateField = document.getElementById('id_state');
    var courtField = document.getElementById('id_federal_district_court');
    var manualCourtCheckbox = document.getElementById('id_use_manual_court');

    if (cityField && stateField && courtField) {
        // Add a "Lookup Court" button next to the court field
        var lookupBtn = document.createElement('button');
        lookupBtn.type = 'button';
        lookupBtn.className = 'btn btn-outline-primary mt-2';
        lookupBtn.id = 'lookupCourtBtn';
        lookupBtn.innerHTML = '<i class="bi bi-search me-1"></i>Lookup Court';

        // Add help icon with tooltip next to the button
        var helpIcon = document.createElement('span');
        helpIcon.className = 'ms-2 text-muted';
        helpIcon.setAttribute('data-bs-toggle', 'tooltip');
        helpIcon.setAttribute('data-bs-placement', 'top');
        helpIcon.setAttribute('data-bs-html', 'true');
        helpIcon.setAttribute('title', '<strong>Why do I need this?</strong><br>Section 1983 cases must be filed in federal court. This lookup finds the correct U.S. District Court based on where your incident occurred. Filing in the wrong court can get your case dismissed.');
        helpIcon.innerHTML = '<i class="bi bi-question-circle" style="cursor: help; font-size: 1.1rem;"></i>';

        var courtFieldContainer = courtField.closest('.mb-3');
        if (courtFieldContainer) {
            // Create a wrapper for button and help icon
            var btnWrapper = document.createElement('div');
            btnWrapper.className = 'd-flex align-items-center';
            btnWrapper.appendChild(lookupBtn);
            btnWrapper.appendChild(helpIcon);
            courtFieldContainer.appendChild(btnWrapper);

            // Initialize the tooltip
            new bootstrap.Tooltip(helpIcon);
        }

        function lookupDistrictCourt() {
            // Don't lookup if manual override is checked
            if (manualCourtCheckbox && manualCourtCheckbox.checked) {
                return;
            }

            var city = cityField.value.trim();
            var state = stateField.value;  // Already 2-letter code from dropdown

            if (!city || !state) {
                alert('Please enter a City and select a State first.');
                return;
            }

            // Show loading
            lookupBtn.disabled = true;
            lookupBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Looking up...';
            courtField.placeholder = 'Looking up district court...';

            fetch('/documents/lookup-district-court/?city=' + encodeURIComponent(city) + '&state=' + encodeURIComponent(state))
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.success && data.court_name) {
                        courtField.value = data.court_name;
                        courtField.placeholder = 'Federal district court';

                        // Show confidence indicator
                        var confidenceBadge = document.getElementById('court-confidence');
                        if (!confidenceBadge) {
                            confidenceBadge = document.createElement('small');
                            confidenceBadge.id = 'court-confidence';
                            confidenceBadge.className = 'd-block mt-1';
                            courtField.parentNode.insertBefore(confidenceBadge, lookupBtn);
                        }

                        var confidenceText = data.confidence === 'high' ? 'High confidence match' : 'Best match found';
                        var confidenceClass = data.confidence === 'high' ? 'text-success' : 'text-warning';
                        confidenceBadge.innerHTML = '<i class="bi bi-check-circle me-1"></i><span class="' + confidenceClass + '">' + confidenceText + '</span>';

                        lookupBtn.innerHTML = '<i class="bi bi-check-lg me-1"></i>Found!';
                        lookupBtn.classList.remove('btn-outline-primary');
                        lookupBtn.classList.add('btn-success');
                    } else {
                        courtField.placeholder = 'Could not find - check manual entry';
                        var confidenceBadge = document.getElementById('court-confidence');
                        if (!confidenceBadge) {
                            confidenceBadge = document.createElement('small');
                            confidenceBadge.id = 'court-confidence';
                            confidenceBadge.className = 'd-block mt-1';
                            courtField.parentNode.insertBefore(confidenceBadge, lookupBtn);
                        }
                        confidenceBadge.innerHTML = '<span class="text-danger"><i class="bi bi-exclamation-circle me-1"></i>City not in database. Try a nearby major city or enter manually.</span>';
                        lookupBtn.innerHTML = '<i class="bi bi-x-lg me-1"></i>Not Found';
                        lookupBtn.classList.remove('btn-outline-primary');
                        lookupBtn.classList.add('btn-warning');
                    }
                })
                .catch(function(error) {
                    console.error('District lookup error:', error);
                    courtField.placeholder = 'Lookup failed - enter manually';
                    lookupBtn.innerHTML = '<i class="bi bi-x-lg me-1"></i>Error';
                    lookupBtn.classList.remove('btn-outline-primary');
                    lookupBtn.classList.add('btn-danger');
                })
                .finally(function() {
                    lookupBtn.disabled = false;
                    // Reset button after 3 seconds
                    setTimeout(function() {
                        lookupBtn.innerHTML = '<i class="bi bi-search me-1"></i>Lookup Court';
                        lookupBtn.classList.remove('btn-success', 'btn-warning', 'btn-danger');
                        lookupBtn.classList.add('btn-outline-primary');
                    }, 3000);
                });
        }

        // Click handler for lookup button
        lookupBtn.addEventListener('click', lookupDistrictCourt);

        // Toggle court field editability based on manual checkbox
        if (manualCourtCheckbox) {
            function toggleCourtEditable() {
                if (manualCourtCheckbox.checked) {
                    courtField.readOnly = false;
                    courtField.placeholder = 'Enter federal district court name';
                    lookupBtn.style.display = 'none';
                } else {
                    courtField.readOnly = true;
                    courtField.placeholder = 'Click "Lookup Court" after entering city & state';
                    lookupBtn.style.display = '';
                }
            }

            manualCourtCheckbox.addEventListener('change', toggleCourtEditable);
            toggleCourtEditable(); // Set initial state
        }

        // Auto-lookup on page load if city and state are filled but court isn't
        if (cityField.value && stateField.value && !courtField.value) {
            lookupDistrictCourt();
        }

        // Also trigger lookup when state dropdown changes (if city is filled)
        stateField.addEventListener('change', function() {
            if (cityField.value && stateField.value && !manualCourtCheckbox.checked) {
                lookupDistrictCourt();
            }
        });
    }
});
</script>
{% if section.section_type == 'incident_narrative' %}
<script src="{% static 'js/rewrite.js' %}"></script>
{% elif section.section_type == 'rights_violated' %}
<script src="{% static 'js/rights-analyze.js' %}"></script>
{% endif %}
{% endblock %}

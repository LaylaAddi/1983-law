{% extends 'base.html' %}

{% block title %}Review & Edit: {{ document.title }} - {{ header_app_name }}{% endblock %}

{% block extra_css %}
<style>
    /* Review page layout */
    .review-container {
        display: flex;
        gap: 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    .document-panel {
        flex: 1;
        max-width: 850px;
    }

    .edit-panel {
        width: 400px;
        position: sticky;
        top: 80px;
        height: fit-content;
        max-height: calc(100vh - 100px);
        overflow-y: auto;
    }

    /* Legal document styling */
    .legal-document {
        font-family: 'Times New Roman', Times, serif;
        font-size: 14px;
        line-height: 1.8;
        background: white;
        padding: 40px 50px;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
        border-radius: 4px;
    }

    .legal-document .caption {
        text-align: center;
        margin-bottom: 2rem;
        line-height: 1.6;
    }

    .legal-document .caption-court {
        font-weight: bold;
        text-transform: uppercase;
        margin-bottom: 1rem;
    }

    .legal-document .caption-box {
        border: 1px solid #000;
        padding: 1rem 2rem;
        display: inline-block;
        text-align: left;
    }

    .legal-document .caption-vs {
        text-align: center;
        margin: 0.5rem 0;
        font-weight: bold;
    }

    .legal-document .section-header {
        text-align: center;
        font-weight: bold;
        text-decoration: underline;
        margin: 1.5rem 0 1rem 0;
    }

    .legal-document p {
        text-indent: 0.5in;
        margin-bottom: 0.5rem;
        text-align: justify;
    }

    .legal-document .no-indent {
        text-indent: 0;
    }

    /* Editable section styling */
    .editable-section {
        position: relative;
        padding: 0.5rem;
        margin: -0.5rem;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .editable-section:hover {
        background: rgba(13, 110, 253, 0.05);
    }

    .editable-section .edit-btn {
        position: absolute;
        top: 0;
        right: 0;
        opacity: 0;
        transition: opacity 0.2s ease;
        z-index: 10;
    }

    .editable-section:hover .edit-btn {
        opacity: 1;
    }

    /* Edit panel styling */
    .edit-panel-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .edit-panel-header {
        background: #f8f9fa;
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
        border-radius: 8px 8px 0 0;
    }

    .edit-panel-body {
        padding: 1rem;
    }

    .edit-panel .form-label {
        font-weight: 500;
        font-size: 0.875rem;
    }

    .edit-panel .form-control,
    .edit-panel .form-select {
        font-size: 0.875rem;
    }

    /* Section indicator */
    .section-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 0.5rem;
    }

    .section-indicator.active {
        background: #0d6efd;
    }

    .section-indicator.inactive {
        background: #dee2e6;
    }

    /* Review controls */
    .review-controls {
        position: sticky;
        top: 0;
        background: #f8f9fa;
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
        z-index: 100;
        margin-bottom: 1.5rem;
    }

    /* Highlight currently editing */
    .editable-section.editing {
        background: rgba(13, 110, 253, 0.1);
        outline: 2px solid #0d6efd;
    }

    /* AI Review highlighting */
    .editable-section.ai-issue-critical {
        background: rgba(220, 53, 69, 0.15);
        border-left: 4px solid #dc3545;
        padding-left: calc(0.5rem + 4px);
        margin-left: -4px;
    }

    .editable-section.ai-issue-warning {
        background: rgba(255, 193, 7, 0.15);
        border-left: 4px solid #ffc107;
        padding-left: calc(0.5rem + 4px);
        margin-left: -4px;
    }

    .editable-section.ai-issue-suggestion {
        background: rgba(13, 202, 240, 0.1);
        border-left: 4px solid #0dcaf0;
        padding-left: calc(0.5rem + 4px);
        margin-left: -4px;
    }

    .ai-issue-badge {
        position: absolute;
        top: 0.25rem;
        left: 0.25rem;
        font-size: 0.7rem;
        cursor: pointer;
        z-index: 5;
    }

    .ai-review-panel {
        border: 2px solid #6f42c1;
    }

    .ai-review-panel .card-header {
        background: #6f42c1;
        color: white;
    }

    .ai-issue-item {
        padding: 0.75rem;
        border-radius: 0.375rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: transform 0.1s ease;
    }

    .ai-issue-item:hover {
        transform: translateX(3px);
    }

    .ai-issue-item.critical {
        background: rgba(220, 53, 69, 0.1);
        border-left: 3px solid #dc3545;
    }

    .ai-issue-item.warning {
        background: rgba(255, 193, 7, 0.1);
        border-left: 3px solid #ffc107;
    }

    .ai-issue-item.suggestion {
        background: rgba(13, 202, 240, 0.1);
        border-left: 3px solid #0dcaf0;
    }

    .ai-strength-badge {
        font-size: 0.8rem;
        padding: 0.25rem 0.75rem;
    }

    /* Step-through fix mode */
    .fix-mode-header {
        background: linear-gradient(135deg, #6f42c1 0%, #9b59b6 100%);
        color: white;
        padding: 0.75rem;
        border-radius: 0.5rem 0.5rem 0 0;
        margin: -1rem -1rem 1rem -1rem;
    }

    .fix-progress {
        height: 4px;
        background: rgba(255,255,255,0.3);
        border-radius: 2px;
        margin-top: 0.5rem;
    }

    .fix-progress-bar {
        height: 100%;
        background: white;
        border-radius: 2px;
        transition: width 0.3s ease;
    }

    /* Diff view styling */
    .diff-container {
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        line-height: 1.6;
        background: #f8f9fa;
        border-radius: 0.375rem;
        padding: 1rem;
        max-height: 300px;
        overflow-y: auto;
    }

    .diff-word-removed {
        background: #fecaca;
        color: #991b1b;
        text-decoration: line-through;
        padding: 0 2px;
        border-radius: 2px;
    }

    .diff-word-added {
        background: #bbf7d0;
        color: #166534;
        padding: 0 2px;
        border-radius: 2px;
    }

    .diff-word-unchanged {
        color: #6b7280;
    }

    /* Changes applied summary */
    .changes-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .change-item {
        border-left: 3px solid #10b981;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background: rgba(16, 185, 129, 0.05);
        border-radius: 0 0.375rem 0.375rem 0;
    }

    .change-item.skipped {
        border-left-color: #9ca3af;
        background: rgba(156, 163, 175, 0.05);
    }

    .change-item .before-after {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .change-item .before, .change-item .after {
        font-size: 0.75rem;
        padding: 0.5rem;
        border-radius: 0.25rem;
    }

    .change-item .before {
        background: #fef2f2;
        border: 1px solid #fecaca;
    }

    .change-item .after {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
    }

    /* Current section being fixed - prominent indicator */
    .editable-section.fixing-now {
        outline: 3px solid #6f42c1 !important;
        outline-offset: 2px;
        box-shadow: 0 0 20px rgba(111, 66, 193, 0.4);
        animation: pulse-fix 1.5s ease-in-out infinite;
        position: relative;
    }

    .editable-section.fixing-now::before {
        content: 'EDITING THIS SECTION';
        position: absolute;
        top: -28px;
        left: 50%;
        transform: translateX(-50%);
        background: #6f42c1;
        color: white;
        font-size: 0.7rem;
        font-weight: bold;
        padding: 4px 12px;
        border-radius: 4px;
        white-space: nowrap;
        z-index: 100;
        font-family: system-ui, -apple-system, sans-serif;
    }

    @keyframes pulse-fix {
        0%, 100% {
            box-shadow: 0 0 20px rgba(111, 66, 193, 0.4);
        }
        50% {
            box-shadow: 0 0 30px rgba(111, 66, 193, 0.7);
        }
    }

    /* Section just updated - success indicator */
    .editable-section.just-updated {
        outline: 3px solid #10b981 !important;
        outline-offset: 2px;
        box-shadow: 0 0 25px rgba(16, 185, 129, 0.5);
        animation: flash-success 0.5s ease-out;
        position: relative;
    }

    .editable-section.just-updated::before {
        content: 'UPDATED';
        position: absolute;
        top: -28px;
        left: 50%;
        transform: translateX(-50%);
        background: #10b981;
        color: white;
        font-size: 0.7rem;
        font-weight: bold;
        padding: 4px 12px;
        border-radius: 4px;
        white-space: nowrap;
        z-index: 100;
        font-family: system-ui, -apple-system, sans-serif;
    }

    @keyframes flash-success {
        0% {
            background-color: rgba(16, 185, 129, 0.3);
        }
        100% {
            background-color: transparent;
        }
    }

    /* Item list in edit panel */
    .item-list {
        max-height: 200px;
        overflow-y: auto;
        margin-bottom: 1rem;
    }

    .item-list-item {
        padding: 0.5rem;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* Print styles */
    @media print {
        .review-controls, .edit-panel, .edit-btn {
            display: none !important;
        }
        .document-panel {
            max-width: none;
        }
        .legal-document {
            box-shadow: none;
            padding: 0;
        }
    }

    /* Mobile responsive */
    @media (max-width: 992px) {
        .review-container {
            flex-direction: column;
        }
        .edit-panel {
            width: 100%;
            position: static;
            order: -1;
            margin-bottom: 1rem;
        }
        .editable-section .edit-btn {
            opacity: 1;
        }
    }

    /* ========================================
       SIDE-BY-SIDE COMPARISON MODE
       ======================================== */
    .comparison-mode .review-container {
        max-width: 100%;
    }

    .comparison-mode .document-panel {
        display: none;
    }

    .comparison-mode .edit-panel {
        width: 320px;
        flex-shrink: 0;
    }

    .comparison-wrapper {
        display: none;
        flex: 1;
        gap: 1rem;
    }

    .comparison-mode .comparison-wrapper {
        display: flex;
    }

    .comparison-panel {
        flex: 1;
        min-width: 0;
    }

    .comparison-panel .legal-document {
        font-size: 12px;
        padding: 25px 30px;
    }

    .comparison-header {
        text-align: center;
        padding: 0.5rem;
        font-weight: bold;
        font-size: 0.85rem;
        border-radius: 4px 4px 0 0;
        margin-bottom: 0;
    }

    .comparison-header.original {
        background: #fef2f2;
        color: #991b1b;
        border: 1px solid #fecaca;
        border-bottom: none;
    }

    .comparison-header.updated {
        background: #f0fdf4;
        color: #166534;
        border: 1px solid #bbf7d0;
        border-bottom: none;
    }

    .comparison-panel .legal-document {
        border-radius: 0 0 4px 4px;
    }

    .comparison-panel.original-panel .legal-document {
        border: 1px solid #fecaca;
        background: #fffbfb;
    }

    .comparison-panel.updated-panel .legal-document {
        border: 1px solid #bbf7d0;
        background: #fbfffc;
    }

    /* Highlight changed sections in comparison */
    .comparison-panel.updated-panel .section-changed {
        background: rgba(16, 185, 129, 0.15);
        border-left: 3px solid #10b981;
        margin-left: -3px;
        padding-left: 0.5rem;
    }

    .comparison-panel.original-panel .section-original {
        background: rgba(220, 53, 69, 0.08);
        border-left: 3px solid #dc3545;
        margin-left: -3px;
        padding-left: 0.5rem;
    }

    /* Current section being edited in comparison */
    .comparison-panel .fixing-now {
        outline: 2px solid #6f42c1;
        outline-offset: 1px;
    }

    /* Toggle button for comparison */
    .comparison-toggle {
        display: none;
    }

    .fix-mode-active .comparison-toggle {
        display: inline-flex;
    }

    /* Responsive for comparison */
    @media (max-width: 1400px) {
        .comparison-mode .edit-panel {
            width: 280px;
        }
        .comparison-panel .legal-document {
            font-size: 11px;
            padding: 20px 25px;
        }
    }

    @media (max-width: 1200px) {
        .comparison-mode .comparison-wrapper {
            flex-direction: column;
        }
        .comparison-panel .legal-document {
            font-size: 12px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Status Banner -->
<div class="container-fluid no-print">
    {% include 'documents/partials/status_banner.html' %}
</div>

<!-- Review Controls -->
<div class="review-controls no-print">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="d-flex align-items-center gap-2">
                <a href="{% url 'documents:document_detail' document.id %}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-left me-1"></i>Back to Sections
                </a>
                <h5 class="mb-0 ms-2">Review & Edit</h5>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-purple btn-sm" id="aiReviewBtn" onclick="startAIReview()" style="border-color: #6f42c1; color: #6f42c1;">
                    <i class="bi bi-robot me-1"></i>AI Review
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="window.print()">
                    <i class="bi bi-printer me-1"></i>Print
                </button>
                {% if document.payment_status == 'finalized' %}
                    <a href="{% url 'documents:document_preview' document.id %}?generate=true" class="btn btn-success btn-sm">
                        <i class="bi bi-file-earmark-pdf me-1"></i>Download PDF
                    </a>
                {% elif document.payment_status == 'paid' or request.user.has_unlimited_access %}
                    <a href="{% url 'documents:finalize' document.id %}" class="btn btn-success btn-sm">
                        <i class="bi bi-file-earmark-pdf me-1"></i>Generate PDF
                    </a>
                {% else %}
                    <a href="{% url 'documents:checkout' document.id %}" class="btn btn-success btn-sm">
                        <i class="bi bi-credit-card me-1"></i>Pay & Generate PDF
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="container-fluid py-3">
    <div class="review-container">
        <!-- Document Panel -->
        <div class="document-panel">
            <div class="legal-document">

                <!-- CAPTION -->
                <div class="editable-section" data-section="incident_overview" data-field="court">
                    <button class="btn btn-sm btn-outline-primary edit-btn" onclick="editSection('incident_overview')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <div class="caption">
                        <div class="caption-court">
                            {% if document_data.court %}
                            {{ document_data.court }}
                            {% else %}
                            <span class="text-muted">[Click to add Federal District Court]</span>
                            {% endif %}
                        </div>

                        <div class="caption-box">
                            <div class="editable-section" data-section="plaintiff_info">
                                <button class="btn btn-sm btn-outline-primary edit-btn" onclick="editSection('plaintiff_info')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                {% if document_data.plaintiff.first_name %}
                                {{ document_data.plaintiff.first_name|upper }} {{ document_data.plaintiff.middle_name|upper }} {{ document_data.plaintiff.last_name|upper }},<br>
                                {% else %}
                                <span class="text-muted">[PLAINTIFF NAME]</span>,<br>
                                {% endif %}
                                <span style="margin-left: 2rem;">Plaintiff,</span>
                            </div>
                            <div class="caption-vs">v.</div>
                            <div class="editable-section" data-section="defendants">
                                <button class="btn btn-sm btn-outline-primary edit-btn" onclick="editSection('defendants')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                {% if document_data.defendants %}
                                    {% with first_def=document_data.defendants.0 %}
                                    {{ first_def.name|upper }}{% if document_data.defendants|length > 1 %},<br>
                                    <em>et al.</em>,{% else %},{% endif %}<br>
                                    {% endwith %}
                                {% else %}
                                <span class="text-muted">[DEFENDANTS]</span>,<br>
                                {% endif %}
                                <span style="margin-left: 2rem;">Defendant{% if document_data.defendants|length > 1 %}s{% endif %}.</span>
                            </div>
                        </div>

                        <div style="margin-top: 1rem; font-weight: bold;">
                            CIVIL ACTION NO. _______________
                        </div>

                        <div style="margin-top: 1rem; font-weight: bold; text-transform: uppercase;">
                            Complaint for Violation of Civil Rights<br>
                            Under 42 U.S.C. &sect; 1983
                        </div>
                    </div>
                </div>

                <!-- PARTIES -->
                <div class="section-header">PARTIES</div>

                <div class="editable-section" data-section="plaintiff_info">
                    <button class="btn btn-sm btn-outline-primary edit-btn" onclick="editSection('plaintiff_info')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <p class="no-indent">
                        <strong>1.</strong> Plaintiff
                        {% if document_data.plaintiff.first_name %}
                        {{ document_data.plaintiff.first_name }} {{ document_data.plaintiff.middle_name }} {{ document_data.plaintiff.last_name }}
                        is an individual residing at {{ document_data.plaintiff.street_address|default:"[ADDRESS]" }},
                        {{ document_data.plaintiff.city|default:"[CITY]" }}, {{ document_data.plaintiff.state|default:"[STATE]" }} {{ document_data.plaintiff.zip_code|default:"[ZIP]" }}.
                        {% else %}
                        <span class="text-muted">[Plaintiff information not yet provided]</span>
                        {% endif %}
                    </p>
                </div>

                <div class="editable-section" data-section="defendants">
                    <button class="btn btn-sm btn-outline-primary edit-btn" onclick="editSection('defendants')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    {% for defendant in document_data.defendants %}
                    <p class="no-indent">
                        <strong>{{ forloop.counter|add:1 }}.</strong> Defendant {{ defendant.name }}
                        {% if defendant.defendant_type == 'individual' %}
                        is an individual who, at all times relevant hereto,
                        {% if defendant.title_rank %}held the position of {{ defendant.title_rank }}{% else %}was employed{% endif %}
                        {% if defendant.agency_name %}by {{ defendant.agency_name }}{% endif %}.
                        {% if defendant.address %}Defendant may be served at {{ defendant.address }}.{% endif %}
                        {% else %}
                        is a government entity responsible for the actions of its employees.
                        {% if defendant.address %}{{ defendant.name }} may be served at {{ defendant.address }}.{% endif %}
                        {% endif %}
                    </p>
                    {% empty %}
                    <p class="no-indent text-muted">[No defendants added yet - click to add]</p>
                    {% endfor %}
                </div>

                <!-- JURISDICTION AND VENUE -->
                <div class="section-header">JURISDICTION AND VENUE</div>
                <p class="no-indent">
                    <strong>{{ document_data.defendants|length|add:2 }}.</strong>
                    This Court has jurisdiction pursuant to 28 U.S.C. &sect;&sect; 1331 and 1343.
                </p>
                <p class="no-indent">
                    <strong>{{ document_data.defendants|length|add:3 }}.</strong>
                    Venue is proper in this district pursuant to 28 U.S.C. &sect; 1391(b)
                    {% if document_data.incident.city %}
                    because the events occurred in {{ document_data.incident.city }}, {{ document_data.incident.state }}.
                    {% else %}
                    because the events giving rise to this action occurred in this district.
                    {% endif %}
                </p>

                <!-- STATEMENT OF FACTS -->
                <div class="section-header">STATEMENT OF FACTS</div>

                <div class="editable-section" data-section="incident_overview">
                    <button class="btn btn-sm btn-outline-primary edit-btn" onclick="editSection('incident_overview')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <p class="no-indent">
                        <strong>{{ document_data.defendants|length|add:4 }}.</strong>
                        On or about
                        {% if document_data.incident.incident_date %}{{ document_data.incident.incident_date }}{% else %}<span class="text-muted">[DATE]</span>{% endif %}
                        {% if document_data.incident.incident_time %}, at approximately {{ document_data.incident.incident_time }}{% endif %},
                        Plaintiff was located at
                        {% if document_data.incident.incident_location %}{{ document_data.incident.incident_location }}{% else %}<span class="text-muted">[LOCATION]</span>{% endif %},
                        {% if document_data.incident.city %}{{ document_data.incident.city }}, {{ document_data.incident.state }}{% else %}<span class="text-muted">[CITY, STATE]</span>{% endif %}.
                    </p>
                </div>

                <div class="editable-section" data-section="incident_narrative">
                    <button class="btn btn-sm btn-outline-primary edit-btn" onclick="editSection('incident_narrative')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    {% if document_data.narrative.detailed_narrative %}
                    <p class="no-indent">
                        <strong>{{ document_data.defendants|length|add:5 }}.</strong>
                        {{ document_data.narrative.detailed_narrative }}
                    </p>
                    {% else %}
                    <p class="no-indent text-muted">[Incident narrative not yet provided - click to add]</p>
                    {% endif %}
                </div>

                <!-- DAMAGES -->
                <div class="editable-section" data-section="damages">
                    <button class="btn btn-sm btn-outline-primary edit-btn" onclick="editSection('damages')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    {% if document_data.damages.physical_injury or document_data.damages.emotional_distress %}
                    <p class="no-indent">
                        <strong>{{ document_data.defendants|length|add:6 }}.</strong>
                        As a result of Defendants' actions, Plaintiff suffered
                        {% if document_data.damages.physical_injury %}physical injuries{{ document_data.damages.physical_injury_description|yesno:", specifically: ,"|safe }}{{ document_data.damages.physical_injury_description }}{% endif %}
                        {% if document_data.damages.physical_injury and document_data.damages.emotional_distress %} and {% endif %}
                        {% if document_data.damages.emotional_distress %}emotional distress{% if document_data.damages.emotional_distress_description %}, including {{ document_data.damages.emotional_distress_description }}{% endif %}{% endif %}.
                    </p>
                    {% else %}
                    <p class="no-indent text-muted">[Damages not yet specified - click to add]</p>
                    {% endif %}
                </div>

                <!-- CAUSES OF ACTION -->
                <div class="section-header">CAUSES OF ACTION</div>

                <div class="editable-section" data-section="rights_violated">
                    <button class="btn btn-sm btn-outline-primary edit-btn" onclick="editSection('rights_violated')">
                        <i class="bi bi-pencil"></i>
                    </button>

                    {% if document_data.rights_violated.fourth_amendment %}
                    <p class="no-indent"><strong>FOURTH AMENDMENT VIOLATION</strong></p>
                    <p class="no-indent">
                        Defendants violated Plaintiff's Fourth Amendment rights by:
                        {% if document_data.rights_violated.fourth_amendment_search %}unreasonable search; {% endif %}
                        {% if document_data.rights_violated.fourth_amendment_seizure %}unreasonable seizure; {% endif %}
                        {% if document_data.rights_violated.fourth_amendment_arrest %}arrest without probable cause; {% endif %}
                        {% if document_data.rights_violated.fourth_amendment_force %}use of excessive force.{% endif %}
                    </p>
                    {% if document_data.rights_violated.fourth_amendment_details %}
                    <p class="no-indent"><em>{{ document_data.rights_violated.fourth_amendment_details }}</em></p>
                    {% endif %}
                    {% endif %}

                    {% if document_data.rights_violated.first_amendment %}
                    <p class="no-indent"><strong>FIRST AMENDMENT VIOLATION</strong></p>
                    <p class="no-indent">
                        Defendants violated Plaintiff's First Amendment rights by:
                        {% if document_data.rights_violated.first_amendment_speech %}suppressing free speech; {% endif %}
                        {% if document_data.rights_violated.first_amendment_press %}interfering with right to record; {% endif %}
                        {% if document_data.rights_violated.first_amendment_assembly %}restricting peaceful assembly; {% endif %}
                        {% if document_data.rights_violated.first_amendment_petition %}interfering with right to petition.{% endif %}
                    </p>
                    {% endif %}

                    {% if document_data.rights_violated.fourteenth_amendment %}
                    <p class="no-indent"><strong>FOURTEENTH AMENDMENT VIOLATION</strong></p>
                    <p class="no-indent">
                        Defendants violated Plaintiff's Fourteenth Amendment rights by:
                        {% if document_data.rights_violated.fourteenth_amendment_due_process %}denying due process; {% endif %}
                        {% if document_data.rights_violated.fourteenth_amendment_equal_protection %}denying equal protection.{% endif %}
                    </p>
                    {% endif %}

                    {% if not document_data.rights_violated.first_amendment and not document_data.rights_violated.fourth_amendment and not document_data.rights_violated.fourteenth_amendment %}
                    <p class="no-indent text-muted">[No constitutional violations selected - click to add]</p>
                    {% endif %}
                </div>

                <!-- PRAYER FOR RELIEF -->
                <div class="section-header">PRAYER FOR RELIEF</div>

                <div class="editable-section" data-section="relief_sought">
                    <button class="btn btn-sm btn-outline-primary edit-btn" onclick="editSection('relief_sought')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <p class="no-indent">WHEREFORE, Plaintiff requests:</p>
                    <p class="no-indent" style="margin-left: 0.5in;">
                        A. A declaration that Defendants' actions violated Plaintiff's constitutional rights;
                    </p>
                    {% if document_data.relief.compensatory_damages %}
                    <p class="no-indent" style="margin-left: 0.5in;">
                        B. Compensatory damages{% if document_data.relief.compensatory_amount %} of ${{ document_data.relief.compensatory_amount|floatformat:2 }}{% endif %};
                    </p>
                    {% endif %}
                    {% if document_data.relief.punitive_damages %}
                    <p class="no-indent" style="margin-left: 0.5in;">
                        C. Punitive damages{% if document_data.relief.punitive_amount %} of ${{ document_data.relief.punitive_amount|floatformat:2 }}{% endif %};
                    </p>
                    {% endif %}
                    {% if document_data.relief.attorney_fees %}
                    <p class="no-indent" style="margin-left: 0.5in;">
                        D. Attorney's fees pursuant to 42 U.S.C. &sect; 1988;
                    </p>
                    {% endif %}
                    <p class="no-indent" style="margin-left: 0.5in;">
                        E. Such other relief as the Court deems just.
                    </p>
                    {% if document_data.relief.jury_trial_demanded %}
                    <p class="no-indent" style="margin-top: 1rem;"><strong>JURY DEMAND:</strong> Plaintiff demands trial by jury.</p>
                    {% endif %}
                </div>

                <!-- SIGNATURE -->
                <div class="editable-section" data-section="plaintiff_info" style="margin-top: 2rem;">
                    <button class="btn btn-sm btn-outline-primary edit-btn" onclick="editSection('plaintiff_info')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <p class="no-indent">Respectfully submitted,</p>
                    <p class="no-indent" style="margin-top: 2rem; border-top: 1px solid #000; width: 250px; padding-top: 0.25rem;">
                        {% if document_data.plaintiff.is_pro_se %}
                        {{ document_data.plaintiff.first_name }} {{ document_data.plaintiff.last_name }}, Pro Se<br>
                        {{ document_data.plaintiff.street_address }}<br>
                        {{ document_data.plaintiff.city }}, {{ document_data.plaintiff.state }} {{ document_data.plaintiff.zip_code }}
                        {% else %}
                        Attorney for Plaintiff
                        {% endif %}
                    </p>
                    <p class="no-indent">Dated: ____________________</p>
                </div>

            </div>
        </div>

        <!-- Side-by-Side Comparison Wrapper (hidden by default, shown in fix mode) -->
        <div class="comparison-wrapper" id="comparisonWrapper">
            <!-- Original Document (Left) -->
            <div class="comparison-panel original-panel">
                <div class="comparison-header original">
                    <i class="bi bi-file-earmark-text me-1"></i>ORIGINAL DOCUMENT
                </div>
                <div class="legal-document" id="originalDocument">
                    <!-- Cloned from document-panel when fix mode starts -->
                </div>
            </div>

            <!-- Updated Document (Right) -->
            <div class="comparison-panel updated-panel">
                <div class="comparison-header updated">
                    <i class="bi bi-file-earmark-check me-1"></i>UPDATED DOCUMENT (Changes Highlighted)
                </div>
                <div class="legal-document" id="updatedDocument">
                    <!-- Live version that gets updated -->
                </div>
            </div>
        </div>

        <!-- Edit Panel -->
        <div class="edit-panel no-print">
            <div class="edit-panel-card">
                <div class="edit-panel-header">
                    <h6 class="mb-0" id="editPanelTitle">
                        <i class="bi bi-pencil-square me-2"></i>Click a section to edit
                    </h6>
                </div>
                <div class="edit-panel-body" id="editPanelBody">
                    <p class="text-muted small">
                        Hover over any section in the document and click the <i class="bi bi-pencil"></i> button to edit it.
                    </p>
                    <p class="text-muted small mb-0">
                        Changes are saved automatically when you click "Save".
                    </p>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Edit Form Templates (hidden, loaded via JS) -->
{% for section_type, section_data in sections_data.items %}
<template id="form-{{ section_type }}">
    <form id="editForm-{{ section_type }}" class="edit-form" data-section="{{ section_type }}">
        {% csrf_token %}
        {% if section_data.is_multiple %}
        <div class="mb-3">
            <label class="form-label">Current {{ section_data.config.title }}</label>
            <div class="item-list">
                {% for item in section_data.items %}
                <div class="item-list-item">
                    <span>{{ item }}</span>
                    <a href="{% url 'documents:section_edit' document.id section_type %}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-pencil"></i>
                    </a>
                </div>
                {% empty %}
                <div class="text-muted small">No items yet</div>
                {% endfor %}
            </div>
            <a href="{% url 'documents:section_edit' document.id section_type %}" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-plus me-1"></i>Manage {{ section_data.config.title }}
            </a>
        </div>
        {% else %}
        {% for field in section_data.form %}
        <div class="mb-2">
            <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
            {{ field }}
            {% if field.errors %}
            <div class="invalid-feedback d-block">{{ field.errors.0 }}</div>
            {% endif %}
        </div>
        {% endfor %}
        <div class="d-flex gap-2 mt-3">
            <button type="submit" class="btn btn-primary btn-sm">
                <i class="bi bi-check me-1"></i>Save
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="cancelEdit()">
                Cancel
            </button>
        </div>
        {% endif %}
    </form>
</template>
{% endfor %}
{% endblock %}

{% block extra_js %}
<script>
let currentSection = null;

function editSection(sectionType) {
    // Remove editing class from previous section
    document.querySelectorAll('.editable-section.editing').forEach(el => {
        el.classList.remove('editing');
    });

    // Add editing class to clicked section
    document.querySelectorAll(`[data-section="${sectionType}"]`).forEach(el => {
        el.classList.add('editing');
    });

    currentSection = sectionType;

    // Update panel title
    const titles = {
        'plaintiff_info': 'Plaintiff Information',
        'incident_overview': 'Incident Overview',
        'defendants': 'Government Defendants',
        'incident_narrative': 'Incident Narrative',
        'rights_violated': 'Rights Violated',
        'damages': 'Damages',
        'relief_sought': 'Relief Sought',
        'witnesses': 'Witnesses',
        'evidence': 'Evidence',
        'prior_complaints': 'Prior Complaints'
    };

    document.getElementById('editPanelTitle').innerHTML =
        `<i class="bi bi-pencil-square me-2"></i>Edit: ${titles[sectionType] || sectionType}`;

    // Load form from template
    const template = document.getElementById(`form-${sectionType}`);
    if (template) {
        const clone = template.content.cloneNode(true);
        const panelBody = document.getElementById('editPanelBody');
        panelBody.innerHTML = '';
        panelBody.appendChild(clone);

        // Add form submit handler
        const form = panelBody.querySelector('form');
        if (form) {
            // Add Bootstrap classes to form elements
            form.querySelectorAll('input[type="text"], input[type="number"], input[type="email"], input[type="date"], input[type="time"], textarea').forEach(el => {
                el.classList.add('form-control', 'form-control-sm');
            });
            form.querySelectorAll('select').forEach(el => {
                el.classList.add('form-select', 'form-select-sm');
            });
            form.querySelectorAll('input[type="checkbox"]').forEach(el => {
                el.classList.add('form-check-input');
                // Wrap checkbox in form-check div
                const wrapper = document.createElement('div');
                wrapper.className = 'form-check';
                el.parentNode.insertBefore(wrapper, el);
                wrapper.appendChild(el);
            });

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                saveSection(sectionType, form);
            });
        }

        // Scroll panel into view on mobile
        if (window.innerWidth < 992) {
            panelBody.scrollIntoView({ behavior: 'smooth' });
        }
    }
}

function saveSection(sectionType, form) {
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;

    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Saving...';

    fetch(`/documents/{{ document.id }}/section/${sectionType}/save/`, {
        method: 'POST',
        body: formData,
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            submitBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Saved!';
            submitBtn.classList.remove('btn-primary');
            submitBtn.classList.add('btn-success');

            // Reload page to show updated data
            setTimeout(() => {
                window.location.reload();
            }, 500);
        } else {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;

            // Show errors
            if (data.errors) {
                for (const [field, errors] of Object.entries(data.errors)) {
                    const input = form.querySelector(`[name="${field}"]`);
                    if (input) {
                        input.classList.add('is-invalid');
                        let feedback = input.nextElementSibling;
                        if (!feedback || !feedback.classList.contains('invalid-feedback')) {
                            feedback = document.createElement('div');
                            feedback.className = 'invalid-feedback';
                            input.parentNode.insertBefore(feedback, input.nextSibling);
                        }
                        feedback.textContent = errors[0];
                    }
                }
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        alert('Error saving. Please try again.');
    });
}

function cancelEdit() {
    document.querySelectorAll('.editable-section.editing').forEach(el => {
        el.classList.remove('editing');
    });

    document.getElementById('editPanelTitle').innerHTML =
        '<i class="bi bi-pencil-square me-2"></i>Click a section to edit';

    document.getElementById('editPanelBody').innerHTML = `
        <p class="text-muted small">
            Hover over any section in the document and click the <i class="bi bi-pencil"></i> button to edit it.
        </p>
        <p class="text-muted small mb-0">
            Changes are saved automatically when you click "Save".
        </p>
    `;

    currentSection = null;
}

// Keyboard shortcut: Escape to cancel
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && currentSection) {
        cancelEdit();
    }
});

// AI Review functionality
let aiReviewResults = null;

// Map section names from AI response to data-section attributes
const sectionNameMap = {
    'caption': 'incident_overview',
    'parties': 'plaintiff_info',
    'jurisdiction': 'incident_overview',
    'facts': 'incident_narrative',
    'factual allegations': 'incident_narrative',
    'allegations': 'incident_narrative',
    'damages': 'damages',
    'causes_of_action': 'rights_violated',
    'causes of action': 'rights_violated',
    'legal claims': 'rights_violated',
    'claims': 'rights_violated',
    'constitutional violations': 'rights_violated',
    'legal basis': 'rights_violated',
    'relief': 'relief_sought',
    'relief_sought': 'relief_sought',
    'prayer for relief': 'relief_sought',
    'signature': 'plaintiff_info',
    'defendants': 'defendants',
    'defendant': 'defendants',
    'plaintiff': 'plaintiff_info',
    'plaintiff_info': 'plaintiff_info',
    'incident': 'incident_overview',
    'incident_overview': 'incident_overview',
    'incident overview': 'incident_overview',
    'narrative': 'incident_narrative',
    'incident_narrative': 'incident_narrative',
    'incident narrative': 'incident_narrative',
    'rights': 'rights_violated',
    'rights_violated': 'rights_violated',
    'rights violated': 'rights_violated',
    'witnesses': 'witnesses',
    'evidence': 'evidence'
};

function startAIReview() {
    const btn = document.getElementById('aiReviewBtn');
    const originalText = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Analyzing...';
    btn.style.backgroundColor = '#6f42c1';
    btn.style.color = 'white';

    // Clear previous highlights
    clearAIHighlights();

    fetch(`/documents/{{ document.id }}/ai-review/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        btn.style.backgroundColor = '';
        btn.style.color = '#6f42c1';

        if (data.success) {
            aiReviewResults = data;
            displayAIReview(data);
        } else {
            alert('AI Review failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        btn.style.backgroundColor = '';
        btn.style.color = '#6f42c1';
        console.error('Error:', error);
        alert('Error performing AI review. Please try again.');
    });
}

function clearAIHighlights() {
    document.querySelectorAll('.editable-section').forEach(el => {
        el.classList.remove('ai-issue-critical', 'ai-issue-warning', 'ai-issue-suggestion');
        const badges = el.querySelectorAll('.ai-issue-badge');
        badges.forEach(b => b.remove());
    });
}

function displayAIReview(data) {
    // Update the edit panel to show AI review results
    const panelTitle = document.getElementById('editPanelTitle');
    const panelBody = document.getElementById('editPanelBody');

    // Determine badge color based on overall assessment
    let assessmentBadge = '';
    if (data.overall_assessment === 'strong') {
        assessmentBadge = '<span class="badge bg-success ai-strength-badge">Strong</span>';
    } else if (data.overall_assessment === 'needs_work') {
        assessmentBadge = '<span class="badge bg-warning text-dark ai-strength-badge">Needs Work</span>';
    } else {
        assessmentBadge = '<span class="badge bg-danger ai-strength-badge">Weak</span>';
    }

    panelTitle.innerHTML = `<i class="bi bi-robot me-2"></i>AI Review ${assessmentBadge}`;

    let html = '';

    // Summary
    if (data.summary) {
        html += `<div class="alert alert-light border mb-3 small">${escapeHtml(data.summary)}</div>`;
    }

    // Strengths
    if (data.strengths && data.strengths.length > 0) {
        html += '<div class="mb-3"><h6 class="text-success"><i class="bi bi-check-circle me-1"></i>Strengths</h6><ul class="small mb-0">';
        data.strengths.forEach(s => {
            html += `<li>${escapeHtml(s)}</li>`;
        });
        html += '</ul></div>';
    }

    // Issues
    if (data.issues && data.issues.length > 0) {
        html += '<div class="mb-3"><h6><i class="bi bi-exclamation-circle me-1"></i>Issues to Address</h6>';
        data.issues.forEach((issue, index) => {
            const severityClass = issue.severity || 'suggestion';
            const severityIcon = severityClass === 'critical' ? 'x-circle text-danger' :
                                 severityClass === 'warning' ? 'exclamation-triangle text-warning' :
                                 'lightbulb text-info';

            html += `
                <div class="ai-issue-item ${severityClass}" onclick="scrollToIssue('${issue.section}', ${index})">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-${severityIcon} me-2 mt-1"></i>
                        <div>
                            <strong>${escapeHtml(issue.title)}</strong>
                            <div class="small text-muted">${escapeHtml(issue.description)}</div>
                            <div class="small mt-1"><strong>Suggestion:</strong> ${escapeHtml(issue.suggestion)}</div>
                        </div>
                    </div>
                </div>
            `;

            // Add highlight to the corresponding section
            highlightSection(issue.section, severityClass, index);
        });
        html += '</div>';
    } else {
        html += '<div class="alert alert-success"><i class="bi bi-check-circle me-1"></i>No issues found! Your document looks good.</div>';
    }

    // Clear button
    html += `<button class="btn btn-outline-secondary btn-sm w-100" onclick="clearAIReview()">
        <i class="bi bi-x-circle me-1"></i>Clear Review
    </button>`;

    panelBody.innerHTML = html;

    // Make the panel visible with review styling
    const panelCard = document.querySelector('.edit-panel-card');
    panelCard.classList.add('ai-review-panel');
}

function highlightSection(sectionName, severity, issueIndex) {
    // Map section name to data-section attribute
    const mappedSection = sectionNameMap[sectionName.toLowerCase()] || sectionName;

    const sections = document.querySelectorAll(`[data-section="${mappedSection}"]`);
    sections.forEach(el => {
        // Add the highest severity class (critical > warning > suggestion)
        if (severity === 'critical') {
            el.classList.remove('ai-issue-warning', 'ai-issue-suggestion');
            el.classList.add('ai-issue-critical');
        } else if (severity === 'warning' && !el.classList.contains('ai-issue-critical')) {
            el.classList.remove('ai-issue-suggestion');
            el.classList.add('ai-issue-warning');
        } else if (severity === 'suggestion' && !el.classList.contains('ai-issue-critical') && !el.classList.contains('ai-issue-warning')) {
            el.classList.add('ai-issue-suggestion');
        }
    });
}

function scrollToIssue(sectionName, issueIndex) {
    const mappedSection = sectionNameMap[sectionName.toLowerCase()] || sectionName;
    const section = document.querySelector(`[data-section="${mappedSection}"]`);
    if (section) {
        section.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // Flash effect
        section.style.transition = 'box-shadow 0.3s ease';
        section.style.boxShadow = '0 0 20px rgba(111, 66, 193, 0.5)';
        setTimeout(() => {
            section.style.boxShadow = '';
        }, 1500);
    }
}

function clearAIReview() {
    clearAIHighlights();
    aiReviewResults = null;

    const panelCard = document.querySelector('.edit-panel-card');
    panelCard.classList.remove('ai-review-panel');

    cancelEdit();
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ============================================
// STEP-THROUGH FIX MODE
// ============================================

let fixModeActive = false;
let currentIssueIndex = 0;
let appliedChanges = [];
let pendingFix = null;
let originalDocumentHtml = null;

function startFixMode() {
    if (!aiReviewResults || !aiReviewResults.issues || aiReviewResults.issues.length === 0) {
        alert('No issues to fix. Run AI Review first.');
        return;
    }

    fixModeActive = true;
    currentIssueIndex = 0;
    appliedChanges = [];
    pendingFix = null;

    // Enable comparison mode
    enableComparisonMode();

    showCurrentIssue();
}

function enableComparisonMode() {
    const container = document.querySelector('.container-fluid.py-3');
    const documentPanel = document.querySelector('.document-panel .legal-document');
    const originalDoc = document.getElementById('originalDocument');
    const updatedDoc = document.getElementById('updatedDocument');

    // Store and clone the original document
    originalDocumentHtml = documentPanel.innerHTML;
    originalDoc.innerHTML = originalDocumentHtml;
    updatedDoc.innerHTML = originalDocumentHtml;

    // Remove edit buttons from comparison panels (they should use the main panel)
    originalDoc.querySelectorAll('.edit-btn').forEach(btn => btn.remove());
    updatedDoc.querySelectorAll('.edit-btn').forEach(btn => btn.remove());

    // Add class to enable comparison layout
    container.classList.add('comparison-mode');
    document.body.classList.add('fix-mode-active');
}

function disableComparisonMode() {
    const container = document.querySelector('.container-fluid.py-3');
    container.classList.remove('comparison-mode');
    document.body.classList.remove('fix-mode-active');

    // Clear the comparison panels
    document.getElementById('originalDocument').innerHTML = '';
    document.getElementById('updatedDocument').innerHTML = '';
    originalDocumentHtml = null;
}

function updateComparisonView(sectionType, newContent) {
    // Update the "updated" panel with new content and highlight it
    const updatedDoc = document.getElementById('updatedDocument');
    if (!updatedDoc) return;

    const sections = updatedDoc.querySelectorAll(`[data-section="${sectionType}"]`);

    sections.forEach(el => {
        // Remove previous change highlights
        el.classList.remove('section-changed');

        // Find ALL paragraph elements inside and update the first one with content
        const paragraphs = el.querySelectorAll('p');
        if (paragraphs.length > 0 && newContent) {
            const mainP = paragraphs[0];
            const strongEl = mainP.querySelector('strong');
            if (strongEl) {
                // Preserve the paragraph number, update the rest
                const numberText = strongEl.outerHTML;
                mainP.innerHTML = numberText + ' ' + escapeHtml(newContent);
            } else {
                mainP.innerHTML = escapeHtml(newContent);
            }
        }

        // Add change highlight
        el.classList.add('section-changed');
    });

    // Also highlight the corresponding section in the original as changed
    const originalDoc = document.getElementById('originalDocument');
    if (originalDoc) {
        const originalSections = originalDoc.querySelectorAll(`[data-section="${sectionType}"]`);
        originalSections.forEach(el => {
            el.classList.add('section-original');
        });
    }

    // Scroll both panels to show the changed section
    if (sections.length > 0) {
        sections[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

function clearFixingHighlight() {
    document.querySelectorAll('.editable-section.fixing-now').forEach(el => {
        el.classList.remove('fixing-now');
    });
}

function highlightCurrentFixSection(sectionName) {
    clearFixingHighlight();
    const mappedSection = sectionNameMap[sectionName.toLowerCase()] || sectionName;
    const sections = document.querySelectorAll(`[data-section="${mappedSection}"]`);
    sections.forEach(el => {
        el.classList.add('fixing-now');
    });
}

function updateSectionContent(sectionType, newContent) {
    // Find the section in the document and update it visually
    // Only update the main document panel, not comparison panels
    const documentPanel = document.querySelector('.document-panel .legal-document');
    if (!documentPanel) return;

    const sections = documentPanel.querySelectorAll(`[data-section="${sectionType}"]`);

    sections.forEach(el => {
        // Remove fixing-now class and add just-updated class
        el.classList.remove('fixing-now', 'ai-issue-critical', 'ai-issue-warning', 'ai-issue-suggestion');
        el.classList.add('just-updated');

        // Find ALL paragraph elements inside and update the first one with content
        const paragraphs = el.querySelectorAll('p');
        if (paragraphs.length > 0 && newContent) {
            // Update the main paragraph content (preserve the strong number prefix)
            const mainP = paragraphs[0];
            const strongEl = mainP.querySelector('strong');
            if (strongEl) {
                // Preserve the paragraph number, update the rest
                const numberText = strongEl.outerHTML;
                mainP.innerHTML = numberText + ' ' + escapeHtml(newContent);
            } else {
                mainP.innerHTML = escapeHtml(newContent);
            }
        }

        // Scroll to show the updated section
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // Remove the just-updated class after a delay (keep the visual for next issues)
        setTimeout(() => {
            el.classList.remove('just-updated');
        }, 3000);
    });
}

function showCurrentIssue() {
    const issues = aiReviewResults.issues;
    if (currentIssueIndex >= issues.length) {
        clearFixingHighlight();
        showFinalComparison();
        return;
    }

    const issue = issues[currentIssueIndex];
    const panelTitle = document.getElementById('editPanelTitle');
    const panelBody = document.getElementById('editPanelBody');

    // Highlight the current section being fixed
    highlightCurrentFixSection(issue.section);

    // Scroll to the section
    scrollToIssue(issue.section, currentIssueIndex);

    const severityIcon = issue.severity === 'critical' ? 'x-circle text-danger' :
                         issue.severity === 'warning' ? 'exclamation-triangle text-warning' :
                         'lightbulb text-info';

    const progress = ((currentIssueIndex) / issues.length) * 100;

    let html = `
        <div class="fix-mode-header">
            <div class="d-flex justify-content-between align-items-center">
                <span><i class="bi bi-wrench me-2"></i>Fix Mode</span>
                <span class="badge bg-light text-dark">Issue ${currentIssueIndex + 1} of ${issues.length}</span>
            </div>
            <div class="fix-progress">
                <div class="fix-progress-bar" style="width: ${progress}%"></div>
            </div>
        </div>

        <div class="mb-3">
            <div class="d-flex align-items-start mb-2">
                <i class="bi bi-${severityIcon} me-2 mt-1"></i>
                <div>
                    <strong>${escapeHtml(issue.title)}</strong>
                    <div class="small text-muted">${escapeHtml(issue.description)}</div>
                </div>
            </div>
            <div class="alert alert-info small mb-0">
                <strong>Suggestion:</strong> ${escapeHtml(issue.suggestion)}
            </div>
        </div>

        <div id="fixContentArea">
            <button class="btn btn-primary w-100" onclick="generateFix(${currentIssueIndex})">
                <i class="bi bi-magic me-1"></i>Generate AI Fix
            </button>
        </div>

        <hr>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm flex-grow-1" onclick="skipIssue()">
                <i class="bi bi-skip-forward me-1"></i>Skip
            </button>
            <button class="btn btn-outline-danger btn-sm" onclick="exitFixMode()">
                <i class="bi bi-x-circle me-1"></i>Exit
            </button>
        </div>
    `;

    panelTitle.innerHTML = '<i class="bi bi-wrench me-2"></i>Fix Issues';
    panelBody.innerHTML = html;
}

async function generateFix(issueIndex) {
    const issue = aiReviewResults.issues[issueIndex];
    const fixArea = document.getElementById('fixContentArea');
    const mappedSection = sectionNameMap[issue.section.toLowerCase()] || issue.section;

    fixArea.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border text-purple" role="status">
                <span class="visually-hidden">Generating fix...</span>
            </div>
            <div class="small text-muted mt-2">AI is generating a fix...</div>
        </div>
    `;

    try {
        const response = await fetch(`/documents/{{ document.id }}/generate-fix/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                section_type: mappedSection,
                issue_title: issue.title,
                issue_description: issue.description,
                issue_suggestion: issue.suggestion,
            }),
        });

        const data = await response.json();

        if (data.success) {
            pendingFix = {
                issue: issue,
                section_type: mappedSection,
                original_content: data.original_content,
                rewritten_content: data.rewritten_content,
                changes_summary: data.changes_summary,
                field_updates: data.field_updates,
            };

            showFixPreview(pendingFix);
        } else {
            fixArea.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-circle me-1"></i>
                    ${escapeHtml(data.error || 'Failed to generate fix')}
                </div>
                <button class="btn btn-outline-primary btn-sm" onclick="generateFix(${issueIndex})">
                    <i class="bi bi-arrow-clockwise me-1"></i>Try Again
                </button>
            `;
        }
    } catch (error) {
        console.error('Error:', error);
        fixArea.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-circle me-1"></i>
                Error generating fix. Please try again.
            </div>
            <button class="btn btn-outline-primary btn-sm" onclick="generateFix(${issueIndex})">
                <i class="bi bi-arrow-clockwise me-1"></i>Try Again
            </button>
        `;
    }
}

function detectPlaceholders(text) {
    // Detect common placeholder patterns that AI might incorrectly insert
    const placeholderPatterns = [
        /\[insert\s+\w+\]/gi,
        /\[DATE\]/gi,
        /\[TIME\]/gi,
        /\[LOCATION\]/gi,
        /\[NAME\]/gi,
        /\[ADDRESS\]/gi,
        /\[AMOUNT\]/gi,
        /\[\w+\s+here\]/gi,
        /\[your\s+\w+\]/gi,
        /\[specific\s+\w+\]/gi,
    ];

    const found = [];
    for (const pattern of placeholderPatterns) {
        const matches = text.match(pattern);
        if (matches) {
            found.push(...matches);
        }
    }
    return found;
}

function showFixPreview(fix) {
    const fixArea = document.getElementById('fixContentArea');

    const diffHtml = generateWordDiff(fix.original_content || '', fix.rewritten_content || '');

    // Check for placeholders in the rewritten content
    const placeholders = detectPlaceholders(fix.rewritten_content || '');
    let warningHtml = '';
    if (placeholders.length > 0) {
        warningHtml = `
            <div class="alert alert-danger small mb-3">
                <i class="bi bi-exclamation-triangle me-1"></i>
                <strong>Warning:</strong> AI inserted placeholder text that may lose your data:
                <code>${escapeHtml(placeholders.join(', '))}</code>
                <br><strong>Recommendation:</strong> Skip this fix or regenerate it.
            </div>
        `;
    }

    fixArea.innerHTML = `
        <div class="mb-3">
            <h6 class="text-muted mb-2"><i class="bi bi-file-diff me-1"></i>Proposed Changes</h6>
            <div class="diff-container">${diffHtml}</div>
        </div>

        ${warningHtml}

        <div class="alert alert-light small mb-3">
            <strong>Summary:</strong> ${escapeHtml(fix.changes_summary)}
        </div>

        <div class="d-grid gap-2">
            ${placeholders.length > 0 ? `
            <button class="btn btn-warning" onclick="generateFix(currentIssueIndex)">
                <i class="bi bi-arrow-clockwise me-1"></i>Regenerate Fix
            </button>
            <button class="btn btn-outline-danger btn-sm" onclick="applyFix()">
                <i class="bi bi-exclamation-triangle me-1"></i>Apply Anyway (Not Recommended)
            </button>
            ` : `
            <button class="btn btn-success" onclick="applyFix()">
                <i class="bi bi-check-lg me-1"></i>Apply This Fix
            </button>
            `}
            <button class="btn btn-outline-secondary btn-sm" onclick="skipIssue()">
                <i class="bi bi-skip-forward me-1"></i>Skip This Issue
            </button>
        </div>
    `;
}

async function applyFix() {
    if (!pendingFix) return;

    const fixArea = document.getElementById('fixContentArea');
    const sectionType = pendingFix.section_type;
    const newContent = pendingFix.rewritten_content;

    fixArea.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Applying fix...</span>
            </div>
            <div class="small text-muted mt-2">Saving changes...</div>
        </div>
    `;

    try {
        const response = await fetch(`/documents/{{ document.id }}/apply-fix/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                section_type: pendingFix.section_type,
                field_updates: pendingFix.field_updates,
            }),
        });

        const data = await response.json();

        if (data.success) {
            appliedChanges.push({
                issue: pendingFix.issue,
                section_type: pendingFix.section_type,
                original_content: pendingFix.original_content,
                new_content: pendingFix.rewritten_content,
                applied: true,
            });

            // Update the main document section visually
            updateSectionContent(sectionType, newContent);

            // Update the side-by-side comparison view
            updateComparisonView(sectionType, newContent);

            pendingFix = null;
            currentIssueIndex++;
            showCurrentIssue();
        } else {
            fixArea.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-circle me-1"></i>
                    ${escapeHtml(data.error || 'Failed to apply fix')}
                </div>
                <button class="btn btn-outline-primary btn-sm" onclick="showFixPreview(pendingFix)">
                    <i class="bi bi-arrow-left me-1"></i>Back
                </button>
            `;
        }
    } catch (error) {
        console.error('Error:', error);
        fixArea.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-circle me-1"></i>
                Error applying fix. Please try again.
            </div>
            <button class="btn btn-outline-primary btn-sm" onclick="showFixPreview(pendingFix)">
                <i class="bi bi-arrow-left me-1"></i>Back
            </button>
        `;
    }
}

function skipIssue() {
    if (pendingFix) {
        appliedChanges.push({
            issue: pendingFix.issue,
            section_type: pendingFix.section_type,
            original_content: pendingFix.original_content,
            new_content: null,
            applied: false,
        });
    } else if (aiReviewResults && aiReviewResults.issues[currentIssueIndex]) {
        appliedChanges.push({
            issue: aiReviewResults.issues[currentIssueIndex],
            section_type: null,
            original_content: null,
            new_content: null,
            applied: false,
        });
    }

    pendingFix = null;
    currentIssueIndex++;
    showCurrentIssue();
}

function exitFixMode() {
    if (appliedChanges.length > 0) {
        if (!confirm('You have applied changes. Exit fix mode?')) {
            return;
        }
    }

    fixModeActive = false;
    currentIssueIndex = 0;
    appliedChanges = [];
    pendingFix = null;

    // Disable comparison mode
    disableComparisonMode();

    // Clear the fixing highlight
    clearFixingHighlight();

    // Show the original review results
    if (aiReviewResults) {
        displayAIReview(aiReviewResults);
    } else {
        clearAIReview();
    }
}

function showFinalComparison() {
    fixModeActive = false;
    clearFixingHighlight();

    const panelTitle = document.getElementById('editPanelTitle');
    const panelBody = document.getElementById('editPanelBody');

    const appliedCount = appliedChanges.filter(c => c.applied).length;
    const skippedCount = appliedChanges.filter(c => !c.applied).length;

    let html = `
        <div class="fix-mode-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
            <div class="d-flex justify-content-between align-items-center">
                <span><i class="bi bi-check-circle me-2"></i>Review Complete</span>
            </div>
        </div>

        <div class="alert alert-success mb-3">
            <strong>${appliedCount} changes applied</strong>, ${skippedCount} skipped
        </div>

        <h6 class="mb-2"><i class="bi bi-list-check me-1"></i>Changes Summary</h6>
        <div class="changes-list mb-3">
    `;

    appliedChanges.forEach((change, index) => {
        const statusClass = change.applied ? '' : 'skipped';
        const statusIcon = change.applied ? 'check-circle text-success' : 'skip-forward text-muted';
        const statusText = change.applied ? 'Applied' : 'Skipped';

        html += `
            <div class="change-item ${statusClass}">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>${escapeHtml(change.issue.title)}</strong>
                        <div class="small text-muted">${escapeHtml(change.issue.section)}</div>
                    </div>
                    <span class="badge ${change.applied ? 'bg-success' : 'bg-secondary'}">
                        <i class="bi bi-${statusIcon} me-1"></i>${statusText}
                    </span>
                </div>
                ${change.applied && change.original_content ? `
                <div class="before-after">
                    <div class="before">
                        <strong class="text-danger">Before:</strong><br>
                        ${escapeHtml(change.original_content.substring(0, 100))}${change.original_content.length > 100 ? '...' : ''}
                    </div>
                    <div class="after">
                        <strong class="text-success">After:</strong><br>
                        ${escapeHtml(change.new_content.substring(0, 100))}${change.new_content.length > 100 ? '...' : ''}
                    </div>
                </div>
                ` : ''}
            </div>
        `;
    });

    html += `
        </div>

        <div class="d-grid gap-2">
            <button class="btn btn-success" onclick="finalizeChanges()">
                <i class="bi bi-check-lg me-1"></i>Done - View Updated Document
            </button>
            <button class="btn btn-outline-primary btn-sm" onclick="startAIReview()">
                <i class="bi bi-arrow-clockwise me-1"></i>Run AI Review Again
            </button>
        </div>
    `;

    panelTitle.innerHTML = '<i class="bi bi-clipboard-check me-2"></i>Changes Applied';
    panelBody.innerHTML = html;
}

function finalizeChanges() {
    // Reload the page to show updated document
    window.location.reload();
}

// ============================================
// WORD-LEVEL DIFF ALGORITHM
// ============================================

function generateWordDiff(oldText, newText) {
    if (!oldText && !newText) return '<em class="text-muted">No content</em>';
    if (!oldText) return `<span class="diff-word-added">${escapeHtml(newText)}</span>`;
    if (!newText) return `<span class="diff-word-removed">${escapeHtml(oldText)}</span>`;

    const oldWords = tokenize(oldText);
    const newWords = tokenize(newText);

    const diff = computeDiff(oldWords, newWords);

    return diff.map(item => {
        if (item.type === 'equal') {
            return `<span class="diff-word-unchanged">${escapeHtml(item.value)}</span>`;
        } else if (item.type === 'delete') {
            return `<span class="diff-word-removed">${escapeHtml(item.value)}</span>`;
        } else if (item.type === 'insert') {
            return `<span class="diff-word-added">${escapeHtml(item.value)}</span>`;
        }
    }).join(' ');
}

function tokenize(text) {
    // Split by whitespace while preserving punctuation
    return text.split(/(\s+)/).filter(t => t.trim().length > 0);
}

function computeDiff(oldArr, newArr) {
    // Simple LCS-based diff algorithm
    const m = oldArr.length;
    const n = newArr.length;

    // Build LCS matrix
    const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));

    for (let i = 1; i <= m; i++) {
        for (let j = 1; j <= n; j++) {
            if (oldArr[i - 1] === newArr[j - 1]) {
                dp[i][j] = dp[i - 1][j - 1] + 1;
            } else {
                dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1]);
            }
        }
    }

    // Backtrack to find diff
    const result = [];
    let i = m, j = n;

    while (i > 0 || j > 0) {
        if (i > 0 && j > 0 && oldArr[i - 1] === newArr[j - 1]) {
            result.unshift({ type: 'equal', value: oldArr[i - 1] });
            i--;
            j--;
        } else if (j > 0 && (i === 0 || dp[i][j - 1] >= dp[i - 1][j])) {
            result.unshift({ type: 'insert', value: newArr[j - 1] });
            j--;
        } else {
            result.unshift({ type: 'delete', value: oldArr[i - 1] });
            i--;
        }
    }

    return result;
}

// Update displayAIReview to add "Fix Issues" button
const originalDisplayAIReview = displayAIReview;
displayAIReview = function(data) {
    originalDisplayAIReview(data);

    // Add "Fix Issues" button if there are issues
    if (data.issues && data.issues.length > 0) {
        const panelBody = document.getElementById('editPanelBody');
        const clearBtn = panelBody.querySelector('button[onclick="clearAIReview()"]');
        if (clearBtn) {
            const fixBtn = document.createElement('button');
            fixBtn.className = 'btn btn-purple btn-sm w-100 mb-2';
            fixBtn.style.backgroundColor = '#6f42c1';
            fixBtn.style.borderColor = '#6f42c1';
            fixBtn.style.color = 'white';
            fixBtn.innerHTML = '<i class="bi bi-wrench me-1"></i>Fix Issues Step-by-Step';
            fixBtn.onclick = startFixMode;
            clearBtn.parentNode.insertBefore(fixBtn, clearBtn);
        }
    }
};
</script>
{% endblock %}

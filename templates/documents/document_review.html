{% extends 'base.html' %}

{% block title %}Review & Edit: {{ document.title }} - {{ header_app_name }}{% endblock %}

{% block extra_css %}
<style>
    /* Review page layout */
    .review-container {
        display: flex;
        gap: 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    .document-panel {
        flex: 1;
        max-width: 850px;
    }

    .edit-panel {
        width: 400px;
        position: sticky;
        top: 80px;
        height: fit-content;
        max-height: calc(100vh - 100px);
        overflow-y: auto;
    }

    /* Legal document styling */
    .legal-document {
        font-family: 'Times New Roman', Times, serif;
        font-size: 14px;
        line-height: 1.8;
        background: white;
        padding: 40px 50px;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
        border-radius: 4px;
    }

    .legal-document .caption {
        text-align: center;
        margin-bottom: 2rem;
        line-height: 1.6;
    }

    .legal-document .caption-court {
        font-weight: bold;
        text-transform: uppercase;
        margin-bottom: 1rem;
    }

    .legal-document .caption-box {
        border: 1px solid #000;
        padding: 1rem 2rem;
        display: inline-block;
        text-align: left;
    }

    .legal-document .caption-vs {
        text-align: center;
        margin: 0.5rem 0;
        font-weight: bold;
    }

    .legal-document .section-header {
        text-align: center;
        font-weight: bold;
        text-decoration: underline;
        margin: 1.5rem 0 1rem 0;
    }

    .legal-document p {
        text-indent: 0.5in;
        margin-bottom: 0.5rem;
        text-align: justify;
    }

    .legal-document .no-indent {
        text-indent: 0;
    }

    /* Editable section styling */
    .editable-section {
        position: relative;
        padding: 0.5rem;
        margin: -0.5rem;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .editable-section:hover {
        background: rgba(13, 110, 253, 0.05);
    }

    .editable-section .edit-btn {
        position: absolute;
        top: 0;
        right: 0;
        opacity: 0;
        transition: opacity 0.2s ease;
        z-index: 10;
    }

    .editable-section:hover .edit-btn {
        opacity: 1;
    }

    /* Edit panel styling */
    .edit-panel-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .edit-panel-header {
        background: #f8f9fa;
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
        border-radius: 8px 8px 0 0;
    }

    .edit-panel-body {
        padding: 1rem;
    }

    .edit-panel .form-label {
        font-weight: 500;
        font-size: 0.875rem;
    }

    .edit-panel .form-control,
    .edit-panel .form-select {
        font-size: 0.875rem;
    }

    /* Section indicator */
    .section-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 0.5rem;
    }

    .section-indicator.active {
        background: #0d6efd;
    }

    .section-indicator.inactive {
        background: #dee2e6;
    }

    /* Review controls */
    .review-controls {
        position: sticky;
        top: 0;
        background: #f8f9fa;
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
        z-index: 100;
        margin-bottom: 1.5rem;
    }

    /* Highlight currently editing */
    .editable-section.editing {
        background: rgba(13, 110, 253, 0.1);
        outline: 2px solid #0d6efd;
    }

    /* AI Review highlighting */
    .editable-section.ai-issue-critical {
        background: rgba(220, 53, 69, 0.15);
        border-left: 4px solid #dc3545;
        padding-left: calc(0.5rem + 4px);
        margin-left: -4px;
    }

    .editable-section.ai-issue-warning {
        background: rgba(255, 193, 7, 0.15);
        border-left: 4px solid #ffc107;
        padding-left: calc(0.5rem + 4px);
        margin-left: -4px;
    }

    .editable-section.ai-issue-suggestion {
        background: rgba(13, 202, 240, 0.1);
        border-left: 4px solid #0dcaf0;
        padding-left: calc(0.5rem + 4px);
        margin-left: -4px;
    }

    .ai-issue-badge {
        position: absolute;
        top: 0.25rem;
        left: 0.25rem;
        font-size: 0.7rem;
        cursor: pointer;
        z-index: 5;
    }

    .ai-review-panel {
        border: 2px solid #6f42c1;
    }

    .ai-review-panel .card-header {
        background: #6f42c1;
        color: white;
    }

    .ai-issue-item {
        padding: 0.75rem;
        border-radius: 0.375rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: transform 0.1s ease;
    }

    .ai-issue-item:hover {
        transform: translateX(3px);
    }

    .ai-issue-item.critical {
        background: rgba(220, 53, 69, 0.1);
        border-left: 3px solid #dc3545;
    }

    .ai-issue-item.warning {
        background: rgba(255, 193, 7, 0.1);
        border-left: 3px solid #ffc107;
    }

    .ai-issue-item.suggestion {
        background: rgba(13, 202, 240, 0.1);
        border-left: 3px solid #0dcaf0;
    }

    .ai-strength-badge {
        font-size: 0.8rem;
        padding: 0.25rem 0.75rem;
    }

    /* Item list in edit panel */
    .item-list {
        max-height: 200px;
        overflow-y: auto;
        margin-bottom: 1rem;
    }

    .item-list-item {
        padding: 0.5rem;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* Print styles */
    @media print {
        .review-controls, .edit-panel, .edit-btn {
            display: none !important;
        }
        .document-panel {
            max-width: none;
        }
        .legal-document {
            box-shadow: none;
            padding: 0;
        }
    }

    /* Mobile responsive */
    @media (max-width: 992px) {
        .review-container {
            flex-direction: column;
        }
        .edit-panel {
            width: 100%;
            position: static;
            order: -1;
            margin-bottom: 1rem;
        }
        .editable-section .edit-btn {
            opacity: 1;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Status Banner -->
<div class="container-fluid no-print">
    {% include 'documents/partials/status_banner.html' %}
</div>

<!-- Review Controls -->
<div class="review-controls no-print">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="d-flex align-items-center gap-2">
                <a href="{% url 'documents:document_detail' document.id %}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-left me-1"></i>Back to Sections
                </a>
                <h5 class="mb-0 ms-2">Review & Edit</h5>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-purple btn-sm" id="aiReviewBtn" onclick="startAIReview()" style="border-color: #6f42c1; color: #6f42c1;">
                    <i class="bi bi-robot me-1"></i>AI Review
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="window.print()">
                    <i class="bi bi-printer me-1"></i>Print
                </button>
                {% if document.payment_status == 'finalized' %}
                    <a href="{% url 'documents:document_preview' document.id %}?generate=true" class="btn btn-success btn-sm">
                        <i class="bi bi-file-earmark-pdf me-1"></i>Download PDF
                    </a>
                {% elif document.payment_status == 'paid' or request.user.has_unlimited_access %}
                    <a href="{% url 'documents:finalize' document.id %}" class="btn btn-success btn-sm">
                        <i class="bi bi-file-earmark-pdf me-1"></i>Generate PDF
                    </a>
                {% else %}
                    <a href="{% url 'documents:checkout' document.id %}" class="btn btn-success btn-sm">
                        <i class="bi bi-credit-card me-1"></i>Pay & Generate PDF
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="container-fluid py-3">
    <div class="review-container">
        <!-- Document Panel -->
        <div class="document-panel">
            <div class="legal-document">

                <!-- CAPTION -->
                <div class="editable-section" data-section="incident_overview" data-field="court">
                    <button class="btn btn-sm btn-outline-primary edit-btn" onclick="editSection('incident_overview')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <div class="caption">
                        <div class="caption-court">
                            {% if document_data.court %}
                            {{ document_data.court }}
                            {% else %}
                            <span class="text-muted">[Click to add Federal District Court]</span>
                            {% endif %}
                        </div>

                        <div class="caption-box">
                            <div class="editable-section" data-section="plaintiff_info">
                                <button class="btn btn-sm btn-outline-primary edit-btn" onclick="editSection('plaintiff_info')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                {% if document_data.plaintiff.first_name %}
                                {{ document_data.plaintiff.first_name|upper }} {{ document_data.plaintiff.middle_name|upper }} {{ document_data.plaintiff.last_name|upper }},<br>
                                {% else %}
                                <span class="text-muted">[PLAINTIFF NAME]</span>,<br>
                                {% endif %}
                                <span style="margin-left: 2rem;">Plaintiff,</span>
                            </div>
                            <div class="caption-vs">v.</div>
                            <div class="editable-section" data-section="defendants">
                                <button class="btn btn-sm btn-outline-primary edit-btn" onclick="editSection('defendants')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                {% if document_data.defendants %}
                                    {% with first_def=document_data.defendants.0 %}
                                    {{ first_def.name|upper }}{% if document_data.defendants|length > 1 %},<br>
                                    <em>et al.</em>,{% else %},{% endif %}<br>
                                    {% endwith %}
                                {% else %}
                                <span class="text-muted">[DEFENDANTS]</span>,<br>
                                {% endif %}
                                <span style="margin-left: 2rem;">Defendant{% if document_data.defendants|length > 1 %}s{% endif %}.</span>
                            </div>
                        </div>

                        <div style="margin-top: 1rem; font-weight: bold;">
                            CIVIL ACTION NO. _______________
                        </div>

                        <div style="margin-top: 1rem; font-weight: bold; text-transform: uppercase;">
                            Complaint for Violation of Civil Rights<br>
                            Under 42 U.S.C. &sect; 1983
                        </div>
                    </div>
                </div>

                <!-- PARTIES -->
                <div class="section-header">PARTIES</div>

                <div class="editable-section" data-section="plaintiff_info">
                    <button class="btn btn-sm btn-outline-primary edit-btn" onclick="editSection('plaintiff_info')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <p class="no-indent">
                        <strong>1.</strong> Plaintiff
                        {% if document_data.plaintiff.first_name %}
                        {{ document_data.plaintiff.first_name }} {{ document_data.plaintiff.middle_name }} {{ document_data.plaintiff.last_name }}
                        is an individual residing at {{ document_data.plaintiff.street_address|default:"[ADDRESS]" }},
                        {{ document_data.plaintiff.city|default:"[CITY]" }}, {{ document_data.plaintiff.state|default:"[STATE]" }} {{ document_data.plaintiff.zip_code|default:"[ZIP]" }}.
                        {% else %}
                        <span class="text-muted">[Plaintiff information not yet provided]</span>
                        {% endif %}
                    </p>
                </div>

                <div class="editable-section" data-section="defendants">
                    <button class="btn btn-sm btn-outline-primary edit-btn" onclick="editSection('defendants')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    {% for defendant in document_data.defendants %}
                    <p class="no-indent">
                        <strong>{{ forloop.counter|add:1 }}.</strong> Defendant {{ defendant.name }}
                        {% if defendant.defendant_type == 'individual' %}
                        is an individual who, at all times relevant hereto,
                        {% if defendant.title_rank %}held the position of {{ defendant.title_rank }}{% else %}was employed{% endif %}
                        {% if defendant.agency_name %}by {{ defendant.agency_name }}{% endif %}.
                        {% if defendant.address %}Defendant may be served at {{ defendant.address }}.{% endif %}
                        {% else %}
                        is a government entity responsible for the actions of its employees.
                        {% if defendant.address %}{{ defendant.name }} may be served at {{ defendant.address }}.{% endif %}
                        {% endif %}
                    </p>
                    {% empty %}
                    <p class="no-indent text-muted">[No defendants added yet - click to add]</p>
                    {% endfor %}
                </div>

                <!-- JURISDICTION AND VENUE -->
                <div class="section-header">JURISDICTION AND VENUE</div>
                <p class="no-indent">
                    <strong>{{ document_data.defendants|length|add:2 }}.</strong>
                    This Court has jurisdiction pursuant to 28 U.S.C. &sect;&sect; 1331 and 1343.
                </p>
                <p class="no-indent">
                    <strong>{{ document_data.defendants|length|add:3 }}.</strong>
                    Venue is proper in this district pursuant to 28 U.S.C. &sect; 1391(b)
                    {% if document_data.incident.city %}
                    because the events occurred in {{ document_data.incident.city }}, {{ document_data.incident.state }}.
                    {% else %}
                    because the events giving rise to this action occurred in this district.
                    {% endif %}
                </p>

                <!-- STATEMENT OF FACTS -->
                <div class="section-header">STATEMENT OF FACTS</div>

                <div class="editable-section" data-section="incident_overview">
                    <button class="btn btn-sm btn-outline-primary edit-btn" onclick="editSection('incident_overview')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <p class="no-indent">
                        <strong>{{ document_data.defendants|length|add:4 }}.</strong>
                        On or about
                        {% if document_data.incident.incident_date %}{{ document_data.incident.incident_date }}{% else %}<span class="text-muted">[DATE]</span>{% endif %}
                        {% if document_data.incident.incident_time %}, at approximately {{ document_data.incident.incident_time }}{% endif %},
                        Plaintiff was located at
                        {% if document_data.incident.incident_location %}{{ document_data.incident.incident_location }}{% else %}<span class="text-muted">[LOCATION]</span>{% endif %},
                        {% if document_data.incident.city %}{{ document_data.incident.city }}, {{ document_data.incident.state }}{% else %}<span class="text-muted">[CITY, STATE]</span>{% endif %}.
                    </p>
                </div>

                <div class="editable-section" data-section="incident_narrative">
                    <button class="btn btn-sm btn-outline-primary edit-btn" onclick="editSection('incident_narrative')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    {% if document_data.narrative.detailed_narrative %}
                    <p class="no-indent">
                        <strong>{{ document_data.defendants|length|add:5 }}.</strong>
                        {{ document_data.narrative.detailed_narrative }}
                    </p>
                    {% else %}
                    <p class="no-indent text-muted">[Incident narrative not yet provided - click to add]</p>
                    {% endif %}
                </div>

                <!-- DAMAGES -->
                <div class="editable-section" data-section="damages">
                    <button class="btn btn-sm btn-outline-primary edit-btn" onclick="editSection('damages')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    {% if document_data.damages.physical_injury or document_data.damages.emotional_distress %}
                    <p class="no-indent">
                        <strong>{{ document_data.defendants|length|add:6 }}.</strong>
                        As a result of Defendants' actions, Plaintiff suffered
                        {% if document_data.damages.physical_injury %}physical injuries{{ document_data.damages.physical_injury_description|yesno:", specifically: ,"|safe }}{{ document_data.damages.physical_injury_description }}{% endif %}
                        {% if document_data.damages.physical_injury and document_data.damages.emotional_distress %} and {% endif %}
                        {% if document_data.damages.emotional_distress %}emotional distress{% if document_data.damages.emotional_distress_description %}, including {{ document_data.damages.emotional_distress_description }}{% endif %}{% endif %}.
                    </p>
                    {% else %}
                    <p class="no-indent text-muted">[Damages not yet specified - click to add]</p>
                    {% endif %}
                </div>

                <!-- CAUSES OF ACTION -->
                <div class="section-header">CAUSES OF ACTION</div>

                <div class="editable-section" data-section="rights_violated">
                    <button class="btn btn-sm btn-outline-primary edit-btn" onclick="editSection('rights_violated')">
                        <i class="bi bi-pencil"></i>
                    </button>

                    {% if document_data.rights_violated.fourth_amendment %}
                    <p class="no-indent"><strong>FOURTH AMENDMENT VIOLATION</strong></p>
                    <p class="no-indent">
                        Defendants violated Plaintiff's Fourth Amendment rights by:
                        {% if document_data.rights_violated.fourth_amendment_search %}unreasonable search; {% endif %}
                        {% if document_data.rights_violated.fourth_amendment_seizure %}unreasonable seizure; {% endif %}
                        {% if document_data.rights_violated.fourth_amendment_arrest %}arrest without probable cause; {% endif %}
                        {% if document_data.rights_violated.fourth_amendment_force %}use of excessive force.{% endif %}
                    </p>
                    {% if document_data.rights_violated.fourth_amendment_details %}
                    <p class="no-indent"><em>{{ document_data.rights_violated.fourth_amendment_details }}</em></p>
                    {% endif %}
                    {% endif %}

                    {% if document_data.rights_violated.first_amendment %}
                    <p class="no-indent"><strong>FIRST AMENDMENT VIOLATION</strong></p>
                    <p class="no-indent">
                        Defendants violated Plaintiff's First Amendment rights by:
                        {% if document_data.rights_violated.first_amendment_speech %}suppressing free speech; {% endif %}
                        {% if document_data.rights_violated.first_amendment_press %}interfering with right to record; {% endif %}
                        {% if document_data.rights_violated.first_amendment_assembly %}restricting peaceful assembly; {% endif %}
                        {% if document_data.rights_violated.first_amendment_petition %}interfering with right to petition.{% endif %}
                    </p>
                    {% endif %}

                    {% if document_data.rights_violated.fourteenth_amendment %}
                    <p class="no-indent"><strong>FOURTEENTH AMENDMENT VIOLATION</strong></p>
                    <p class="no-indent">
                        Defendants violated Plaintiff's Fourteenth Amendment rights by:
                        {% if document_data.rights_violated.fourteenth_amendment_due_process %}denying due process; {% endif %}
                        {% if document_data.rights_violated.fourteenth_amendment_equal_protection %}denying equal protection.{% endif %}
                    </p>
                    {% endif %}

                    {% if not document_data.rights_violated.first_amendment and not document_data.rights_violated.fourth_amendment and not document_data.rights_violated.fourteenth_amendment %}
                    <p class="no-indent text-muted">[No constitutional violations selected - click to add]</p>
                    {% endif %}
                </div>

                <!-- PRAYER FOR RELIEF -->
                <div class="section-header">PRAYER FOR RELIEF</div>

                <div class="editable-section" data-section="relief_sought">
                    <button class="btn btn-sm btn-outline-primary edit-btn" onclick="editSection('relief_sought')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <p class="no-indent">WHEREFORE, Plaintiff requests:</p>
                    <p class="no-indent" style="margin-left: 0.5in;">
                        A. A declaration that Defendants' actions violated Plaintiff's constitutional rights;
                    </p>
                    {% if document_data.relief.compensatory_damages %}
                    <p class="no-indent" style="margin-left: 0.5in;">
                        B. Compensatory damages{% if document_data.relief.compensatory_amount %} of ${{ document_data.relief.compensatory_amount|floatformat:2 }}{% endif %};
                    </p>
                    {% endif %}
                    {% if document_data.relief.punitive_damages %}
                    <p class="no-indent" style="margin-left: 0.5in;">
                        C. Punitive damages{% if document_data.relief.punitive_amount %} of ${{ document_data.relief.punitive_amount|floatformat:2 }}{% endif %};
                    </p>
                    {% endif %}
                    {% if document_data.relief.attorney_fees %}
                    <p class="no-indent" style="margin-left: 0.5in;">
                        D. Attorney's fees pursuant to 42 U.S.C. &sect; 1988;
                    </p>
                    {% endif %}
                    <p class="no-indent" style="margin-left: 0.5in;">
                        E. Such other relief as the Court deems just.
                    </p>
                    {% if document_data.relief.jury_trial_demanded %}
                    <p class="no-indent" style="margin-top: 1rem;"><strong>JURY DEMAND:</strong> Plaintiff demands trial by jury.</p>
                    {% endif %}
                </div>

                <!-- SIGNATURE -->
                <div class="editable-section" data-section="plaintiff_info" style="margin-top: 2rem;">
                    <button class="btn btn-sm btn-outline-primary edit-btn" onclick="editSection('plaintiff_info')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <p class="no-indent">Respectfully submitted,</p>
                    <p class="no-indent" style="margin-top: 2rem; border-top: 1px solid #000; width: 250px; padding-top: 0.25rem;">
                        {% if document_data.plaintiff.is_pro_se %}
                        {{ document_data.plaintiff.first_name }} {{ document_data.plaintiff.last_name }}, Pro Se<br>
                        {{ document_data.plaintiff.street_address }}<br>
                        {{ document_data.plaintiff.city }}, {{ document_data.plaintiff.state }} {{ document_data.plaintiff.zip_code }}
                        {% else %}
                        Attorney for Plaintiff
                        {% endif %}
                    </p>
                    <p class="no-indent">Dated: ____________________</p>
                </div>

            </div>
        </div>

        <!-- Edit Panel -->
        <div class="edit-panel no-print">
            <div class="edit-panel-card">
                <div class="edit-panel-header">
                    <h6 class="mb-0" id="editPanelTitle">
                        <i class="bi bi-pencil-square me-2"></i>Click a section to edit
                    </h6>
                </div>
                <div class="edit-panel-body" id="editPanelBody">
                    <p class="text-muted small">
                        Hover over any section in the document and click the <i class="bi bi-pencil"></i> button to edit it.
                    </p>
                    <p class="text-muted small mb-0">
                        Changes are saved automatically when you click "Save".
                    </p>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Edit Form Templates (hidden, loaded via JS) -->
{% for section_type, section_data in sections_data.items %}
<template id="form-{{ section_type }}">
    <form id="editForm-{{ section_type }}" class="edit-form" data-section="{{ section_type }}">
        {% csrf_token %}
        {% if section_data.is_multiple %}
        <div class="mb-3">
            <label class="form-label">Current {{ section_data.config.title }}</label>
            <div class="item-list">
                {% for item in section_data.items %}
                <div class="item-list-item">
                    <span>{{ item }}</span>
                    <a href="{% url 'documents:section_edit' document.id section_type %}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-pencil"></i>
                    </a>
                </div>
                {% empty %}
                <div class="text-muted small">No items yet</div>
                {% endfor %}
            </div>
            <a href="{% url 'documents:section_edit' document.id section_type %}" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-plus me-1"></i>Manage {{ section_data.config.title }}
            </a>
        </div>
        {% else %}
        {% for field in section_data.form %}
        <div class="mb-2">
            <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
            {{ field }}
            {% if field.errors %}
            <div class="invalid-feedback d-block">{{ field.errors.0 }}</div>
            {% endif %}
        </div>
        {% endfor %}
        <div class="d-flex gap-2 mt-3">
            <button type="submit" class="btn btn-primary btn-sm">
                <i class="bi bi-check me-1"></i>Save
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="cancelEdit()">
                Cancel
            </button>
        </div>
        {% endif %}
    </form>
</template>
{% endfor %}
{% endblock %}

{% block extra_js %}
<script>
let currentSection = null;

function editSection(sectionType) {
    // Remove editing class from previous section
    document.querySelectorAll('.editable-section.editing').forEach(el => {
        el.classList.remove('editing');
    });

    // Add editing class to clicked section
    document.querySelectorAll(`[data-section="${sectionType}"]`).forEach(el => {
        el.classList.add('editing');
    });

    currentSection = sectionType;

    // Update panel title
    const titles = {
        'plaintiff_info': 'Plaintiff Information',
        'incident_overview': 'Incident Overview',
        'defendants': 'Government Defendants',
        'incident_narrative': 'Incident Narrative',
        'rights_violated': 'Rights Violated',
        'damages': 'Damages',
        'relief_sought': 'Relief Sought',
        'witnesses': 'Witnesses',
        'evidence': 'Evidence',
        'prior_complaints': 'Prior Complaints'
    };

    document.getElementById('editPanelTitle').innerHTML =
        `<i class="bi bi-pencil-square me-2"></i>Edit: ${titles[sectionType] || sectionType}`;

    // Load form from template
    const template = document.getElementById(`form-${sectionType}`);
    if (template) {
        const clone = template.content.cloneNode(true);
        const panelBody = document.getElementById('editPanelBody');
        panelBody.innerHTML = '';
        panelBody.appendChild(clone);

        // Add form submit handler
        const form = panelBody.querySelector('form');
        if (form) {
            // Add Bootstrap classes to form elements
            form.querySelectorAll('input[type="text"], input[type="number"], input[type="email"], input[type="date"], input[type="time"], textarea').forEach(el => {
                el.classList.add('form-control', 'form-control-sm');
            });
            form.querySelectorAll('select').forEach(el => {
                el.classList.add('form-select', 'form-select-sm');
            });
            form.querySelectorAll('input[type="checkbox"]').forEach(el => {
                el.classList.add('form-check-input');
                // Wrap checkbox in form-check div
                const wrapper = document.createElement('div');
                wrapper.className = 'form-check';
                el.parentNode.insertBefore(wrapper, el);
                wrapper.appendChild(el);
            });

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                saveSection(sectionType, form);
            });
        }

        // Scroll panel into view on mobile
        if (window.innerWidth < 992) {
            panelBody.scrollIntoView({ behavior: 'smooth' });
        }
    }
}

function saveSection(sectionType, form) {
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;

    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Saving...';

    fetch(`/documents/{{ document.id }}/section/${sectionType}/save/`, {
        method: 'POST',
        body: formData,
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            submitBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Saved!';
            submitBtn.classList.remove('btn-primary');
            submitBtn.classList.add('btn-success');

            // Reload page to show updated data
            setTimeout(() => {
                window.location.reload();
            }, 500);
        } else {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;

            // Show errors
            if (data.errors) {
                for (const [field, errors] of Object.entries(data.errors)) {
                    const input = form.querySelector(`[name="${field}"]`);
                    if (input) {
                        input.classList.add('is-invalid');
                        let feedback = input.nextElementSibling;
                        if (!feedback || !feedback.classList.contains('invalid-feedback')) {
                            feedback = document.createElement('div');
                            feedback.className = 'invalid-feedback';
                            input.parentNode.insertBefore(feedback, input.nextSibling);
                        }
                        feedback.textContent = errors[0];
                    }
                }
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        alert('Error saving. Please try again.');
    });
}

function cancelEdit() {
    document.querySelectorAll('.editable-section.editing').forEach(el => {
        el.classList.remove('editing');
    });

    document.getElementById('editPanelTitle').innerHTML =
        '<i class="bi bi-pencil-square me-2"></i>Click a section to edit';

    document.getElementById('editPanelBody').innerHTML = `
        <p class="text-muted small">
            Hover over any section in the document and click the <i class="bi bi-pencil"></i> button to edit it.
        </p>
        <p class="text-muted small mb-0">
            Changes are saved automatically when you click "Save".
        </p>
    `;

    currentSection = null;
}

// Keyboard shortcut: Escape to cancel
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && currentSection) {
        cancelEdit();
    }
});

// AI Review functionality
let aiReviewResults = null;

// Map section names from AI response to data-section attributes
const sectionNameMap = {
    'caption': 'incident_overview',
    'parties': 'plaintiff_info',
    'jurisdiction': 'incident_overview',
    'facts': 'incident_narrative',
    'damages': 'damages',
    'causes_of_action': 'rights_violated',
    'relief': 'relief_sought',
    'signature': 'plaintiff_info',
    'defendants': 'defendants',
    'plaintiff': 'plaintiff_info',
    'incident': 'incident_overview',
    'narrative': 'incident_narrative',
    'rights': 'rights_violated',
    'rights_violated': 'rights_violated'
};

function startAIReview() {
    const btn = document.getElementById('aiReviewBtn');
    const originalText = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Analyzing...';
    btn.style.backgroundColor = '#6f42c1';
    btn.style.color = 'white';

    // Clear previous highlights
    clearAIHighlights();

    fetch(`/documents/{{ document.id }}/ai-review/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        btn.style.backgroundColor = '';
        btn.style.color = '#6f42c1';

        if (data.success) {
            aiReviewResults = data;
            displayAIReview(data);
        } else {
            alert('AI Review failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        btn.style.backgroundColor = '';
        btn.style.color = '#6f42c1';
        console.error('Error:', error);
        alert('Error performing AI review. Please try again.');
    });
}

function clearAIHighlights() {
    document.querySelectorAll('.editable-section').forEach(el => {
        el.classList.remove('ai-issue-critical', 'ai-issue-warning', 'ai-issue-suggestion');
        const badges = el.querySelectorAll('.ai-issue-badge');
        badges.forEach(b => b.remove());
    });
}

function displayAIReview(data) {
    // Update the edit panel to show AI review results
    const panelTitle = document.getElementById('editPanelTitle');
    const panelBody = document.getElementById('editPanelBody');

    // Determine badge color based on overall assessment
    let assessmentBadge = '';
    if (data.overall_assessment === 'strong') {
        assessmentBadge = '<span class="badge bg-success ai-strength-badge">Strong</span>';
    } else if (data.overall_assessment === 'needs_work') {
        assessmentBadge = '<span class="badge bg-warning text-dark ai-strength-badge">Needs Work</span>';
    } else {
        assessmentBadge = '<span class="badge bg-danger ai-strength-badge">Weak</span>';
    }

    panelTitle.innerHTML = `<i class="bi bi-robot me-2"></i>AI Review ${assessmentBadge}`;

    let html = '';

    // Summary
    if (data.summary) {
        html += `<div class="alert alert-light border mb-3 small">${escapeHtml(data.summary)}</div>`;
    }

    // Strengths
    if (data.strengths && data.strengths.length > 0) {
        html += '<div class="mb-3"><h6 class="text-success"><i class="bi bi-check-circle me-1"></i>Strengths</h6><ul class="small mb-0">';
        data.strengths.forEach(s => {
            html += `<li>${escapeHtml(s)}</li>`;
        });
        html += '</ul></div>';
    }

    // Issues
    if (data.issues && data.issues.length > 0) {
        html += '<div class="mb-3"><h6><i class="bi bi-exclamation-circle me-1"></i>Issues to Address</h6>';
        data.issues.forEach((issue, index) => {
            const severityClass = issue.severity || 'suggestion';
            const severityIcon = severityClass === 'critical' ? 'x-circle text-danger' :
                                 severityClass === 'warning' ? 'exclamation-triangle text-warning' :
                                 'lightbulb text-info';

            html += `
                <div class="ai-issue-item ${severityClass}" onclick="scrollToIssue('${issue.section}', ${index})">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-${severityIcon} me-2 mt-1"></i>
                        <div>
                            <strong>${escapeHtml(issue.title)}</strong>
                            <div class="small text-muted">${escapeHtml(issue.description)}</div>
                            <div class="small mt-1"><strong>Suggestion:</strong> ${escapeHtml(issue.suggestion)}</div>
                        </div>
                    </div>
                </div>
            `;

            // Add highlight to the corresponding section
            highlightSection(issue.section, severityClass, index);
        });
        html += '</div>';
    } else {
        html += '<div class="alert alert-success"><i class="bi bi-check-circle me-1"></i>No issues found! Your document looks good.</div>';
    }

    // Clear button
    html += `<button class="btn btn-outline-secondary btn-sm w-100" onclick="clearAIReview()">
        <i class="bi bi-x-circle me-1"></i>Clear Review
    </button>`;

    panelBody.innerHTML = html;

    // Make the panel visible with review styling
    const panelCard = document.querySelector('.edit-panel-card');
    panelCard.classList.add('ai-review-panel');
}

function highlightSection(sectionName, severity, issueIndex) {
    // Map section name to data-section attribute
    const mappedSection = sectionNameMap[sectionName.toLowerCase()] || sectionName;

    const sections = document.querySelectorAll(`[data-section="${mappedSection}"]`);
    sections.forEach(el => {
        // Add the highest severity class (critical > warning > suggestion)
        if (severity === 'critical') {
            el.classList.remove('ai-issue-warning', 'ai-issue-suggestion');
            el.classList.add('ai-issue-critical');
        } else if (severity === 'warning' && !el.classList.contains('ai-issue-critical')) {
            el.classList.remove('ai-issue-suggestion');
            el.classList.add('ai-issue-warning');
        } else if (severity === 'suggestion' && !el.classList.contains('ai-issue-critical') && !el.classList.contains('ai-issue-warning')) {
            el.classList.add('ai-issue-suggestion');
        }
    });
}

function scrollToIssue(sectionName, issueIndex) {
    const mappedSection = sectionNameMap[sectionName.toLowerCase()] || sectionName;
    const section = document.querySelector(`[data-section="${mappedSection}"]`);
    if (section) {
        section.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // Flash effect
        section.style.transition = 'box-shadow 0.3s ease';
        section.style.boxShadow = '0 0 20px rgba(111, 66, 193, 0.5)';
        setTimeout(() => {
            section.style.boxShadow = '';
        }, 1500);
    }
}

function clearAIReview() {
    clearAIHighlights();
    aiReviewResults = null;

    const panelCard = document.querySelector('.edit-panel-card');
    panelCard.classList.remove('ai-review-panel');

    cancelEdit();
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}

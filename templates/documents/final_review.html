{% extends 'base.html' %}

{% block title %}Final Review: {{ document.title }} - {{ header_app_name }}{% endblock %}

{% block extra_css %}
<style>
    /* Page layout */
    .final-review-container {
        max-width: 900px;
        margin: 0 auto;
    }

    /* Header bar */
    .review-header {
        background: linear-gradient(135deg, #1a365d 0%, #2d4a7c 100%);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .review-header h1 {
        margin: 0;
        font-size: 1.25rem;
    }

    /* Action buttons */
    .action-bar {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
        padding: 0.75rem 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        align-items: center;
    }

    /* Legal document styling - court format */
    .legal-document {
        font-family: 'Times New Roman', Times, serif;
        font-size: 13pt;
        line-height: 2;
        background: white;
        padding: 1in;
        box-shadow: 0 0 20px rgba(0,0,0,0.15);
        border: 1px solid #ddd;
        min-height: 11in;
    }

    /* Caption - centered court header */
    .court-caption {
        text-align: center;
        margin-bottom: 36pt;
    }

    .court-name {
        font-weight: bold;
        text-transform: uppercase;
        font-size: 13pt;
        margin-bottom: 24pt;
    }

    .case-caption {
        display: flex;
        justify-content: center;
        margin-bottom: 24pt;
    }

    .case-caption-box {
        border: 2px solid black;
        padding: 12pt 24pt;
        text-align: left;
        min-width: 400px;
    }

    .case-caption-box .party {
        margin-bottom: 6pt;
    }

    .case-caption-box .vs {
        text-align: center;
        font-weight: bold;
        margin: 12pt 0;
    }

    .case-caption-box .case-number {
        text-align: right;
        margin-top: 12pt;
    }

    .document-title {
        text-align: center;
        font-weight: bold;
        text-transform: uppercase;
        text-decoration: underline;
        margin-bottom: 24pt;
        font-size: 13pt;
    }

    /* Section headers */
    .section-header {
        text-align: center;
        font-weight: bold;
        text-decoration: underline;
        margin: 24pt 0 12pt 0;
        font-size: 13pt;
    }

    /* Paragraphs with proper indentation */
    .legal-document p {
        text-indent: 0.5in;
        margin-bottom: 0;
        text-align: justify;
    }

    .legal-document p.no-indent {
        text-indent: 0;
    }

    .legal-document .numbered-para {
        text-indent: 0;
        margin-left: 0.5in;
        position: relative;
    }

    .legal-document .numbered-para .para-num {
        position: absolute;
        left: -0.5in;
        width: 0.4in;
        text-align: right;
    }

    /* Section content */
    .section-content {
        white-space: pre-wrap;
        font-family: 'Times New Roman', Times, serif;
        font-size: 13pt;
        line-height: 2;
    }

    /* Editable section */
    .document-section {
        position: relative;
        padding: 8pt;
        margin: 4pt -8pt;
        border-radius: 4px;
        border: 2px solid transparent;
        transition: all 0.2s ease;
    }

    .document-section:hover {
        background: rgba(13, 110, 253, 0.02);
        border-color: rgba(13, 110, 253, 0.15);
    }

    .document-section.editing {
        background: rgba(13, 110, 253, 0.05);
        border-color: #0d6efd;
    }

    .section-toolbar {
        position: absolute;
        top: 4pt;
        right: 4pt;
        display: none;
        gap: 4pt;
        z-index: 10;
    }

    .document-section:hover .section-toolbar {
        display: flex;
    }

    .section-toolbar .btn {
        padding: 2px 6px;
        font-size: 11px;
    }

    /* Edit mode */
    .edit-textarea {
        width: 100%;
        min-height: 150px;
        font-family: 'Times New Roman', Times, serif;
        font-size: 13pt;
        line-height: 2;
        padding: 12pt;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        resize: vertical;
    }

    .edit-actions {
        display: flex;
        gap: 8pt;
        margin-top: 8pt;
    }

    /* AI Review Panel */
    .ai-review-panel {
        background: white;
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
        padding: 1.5rem;
        margin-bottom: 1rem;
    }

    .review-issue {
        padding: 0.75rem;
        border-radius: 4px;
        margin-bottom: 0.75rem;
        font-size: 0.9rem;
    }

    .review-issue.severity-high {
        background: #f8d7da;
        border-left: 4px solid #dc3545;
    }

    .review-issue.severity-medium {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
    }

    .review-issue.severity-low {
        background: #d1ecf1;
        border-left: 4px solid #17a2b8;
    }

    .review-strength {
        padding: 0.5rem 0.75rem;
        background: #d4edda;
        border-left: 4px solid #28a745;
        border-radius: 4px;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    /* Signature block */
    .signature-block {
        margin-top: 48pt;
        margin-left: 50%;
    }

    /* Loading overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.95);
        display: none;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 1000;
    }

    .loading-overlay.active {
        display: flex;
    }

    /* Error/info messages */
    .generation-message {
        text-align: center;
        padding: 2rem;
        background: #f8f9fa;
        border-radius: 8px;
        margin: 1rem 0;
    }

    /* Print styles */
    @media print {
        .action-bar, .review-header, .section-toolbar, .ai-review-panel {
            display: none !important;
        }
        .legal-document {
            box-shadow: none;
            border: none;
            padding: 0;
        }
    }

    @media (max-width: 768px) {
        .legal-document {
            padding: 0.5in;
            font-size: 12pt;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-3">
    <div class="final-review-container">
        <!-- Header -->
        <div class="review-header">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <h1>{{ document.title }}</h1>
                <a href="{% url 'documents:document_detail' document.id %}" class="btn btn-sm btn-outline-light">
                    <i class="bi bi-arrow-left"></i> Back
                </a>
            </div>
        </div>

        {% if auto_generate_error %}
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Auto-generation failed: {{ auto_generate_error }}
        </div>
        {% endif %}

        {% if data_changed %}
        <div class="alert alert-info d-flex justify-content-between align-items-center" id="dataChangedBanner">
            <span>
                <i class="bi bi-info-circle me-2"></i>
                Your information has changed since this document was generated.
            </span>
            <button id="regenerateFromBannerBtn" class="btn btn-primary btn-sm">
                <i class="bi bi-arrow-clockwise"></i> Regenerate Document
            </button>
        </div>
        {% endif %}

        {% if has_final_document %}
        <!-- Action Bar -->
        <div class="action-bar">
            <button id="aiReviewBtn" class="btn btn-info btn-sm text-white" {% if not can_use_ai %}disabled{% endif %}>
                <i class="bi bi-robot"></i> AI Review
            </button>
            <a href="{% url 'documents:download_final_pdf' document.id %}" class="btn btn-success btn-sm">
                <i class="bi bi-file-earmark-pdf"></i> Download PDF
            </a>
            <button class="btn btn-outline-secondary btn-sm" onclick="window.print()">
                <i class="bi bi-printer"></i> Print
            </button>
        </div>

        <!-- AI Review Results Panel (hidden by default) -->
        <div id="aiReviewPanel" class="ai-review-panel" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="bi bi-robot"></i> AI Review</h5>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('aiReviewPanel').style.display='none'">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div id="aiReviewContent"></div>
        </div>

        <!-- The Legal Document -->
        <div class="legal-document">
            <!-- Court Caption -->
            <div class="court-caption">
                <div class="court-name">
                    {{ document_data.court|default:"UNITED STATES DISTRICT COURT" }}<br>
                    FOR THE {{ document_data.district|default:"[DISTRICT]" }} DISTRICT OF {{ document_data.state_name|default:document_data.incident.state|upper }}
                </div>

                <div class="case-caption">
                    <div class="case-caption-box">
                        <div class="party">{{ document_data.plaintiff.first_name|upper }} {{ document_data.plaintiff.last_name|upper }},</div>
                        <div class="party" style="margin-left: 2em;">Plaintiff,</div>
                        <div class="vs">v.</div>
                        {% for defendant in document_data.defendants %}
                        <div class="party">{{ defendant.name|upper }}{% if not forloop.last %},{% else %},{% endif %}</div>
                        {% empty %}
                        <div class="party">[DEFENDANTS],</div>
                        {% endfor %}
                        <div class="party" style="margin-left: 2em;">Defendant{% if document_data.defendants|length > 1 %}s{% endif %}.</div>
                        <div class="case-number">Case No. ________________</div>
                    </div>
                </div>

                <div class="document-title">
                    COMPLAINT FOR VIOLATION OF CIVIL RIGHTS<br>
                    PURSUANT TO 42 U.S.C. ยง 1983
                </div>
            </div>

            <!-- Introduction -->
            <div class="document-section" data-section="introduction">
                <div class="section-toolbar">
                    <button class="btn btn-outline-primary edit-section-btn" title="Edit"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-outline-secondary regenerate-btn" title="Regenerate"><i class="bi bi-arrow-clockwise"></i></button>
                </div>
                <div class="section-content">{{ document.final_introduction }}</div>
                <div class="section-edit" style="display: none;">
                    <textarea class="edit-textarea">{{ document.final_introduction }}</textarea>
                    <div class="edit-actions">
                        <button class="btn btn-sm btn-primary save-btn">Save</button>
                        <button class="btn btn-sm btn-outline-secondary cancel-btn">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Jurisdiction -->
            <div class="section-header">JURISDICTION AND VENUE</div>
            <div class="document-section" data-section="jurisdiction">
                <div class="section-toolbar">
                    <button class="btn btn-outline-primary edit-section-btn" title="Edit"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-outline-secondary regenerate-btn" title="Regenerate"><i class="bi bi-arrow-clockwise"></i></button>
                </div>
                <div class="section-content">{{ document.final_jurisdiction }}</div>
                <div class="section-edit" style="display: none;">
                    <textarea class="edit-textarea">{{ document.final_jurisdiction }}</textarea>
                    <div class="edit-actions">
                        <button class="btn btn-sm btn-primary save-btn">Save</button>
                        <button class="btn btn-sm btn-outline-secondary cancel-btn">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Parties -->
            <div class="section-header">PARTIES</div>
            <div class="document-section" data-section="parties">
                <div class="section-toolbar">
                    <button class="btn btn-outline-primary edit-section-btn" title="Edit"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-outline-secondary regenerate-btn" title="Regenerate"><i class="bi bi-arrow-clockwise"></i></button>
                </div>
                <div class="section-content">{{ document.final_parties }}</div>
                <div class="section-edit" style="display: none;">
                    <textarea class="edit-textarea">{{ document.final_parties }}</textarea>
                    <div class="edit-actions">
                        <button class="btn btn-sm btn-primary save-btn">Save</button>
                        <button class="btn btn-sm btn-outline-secondary cancel-btn">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Statement of Facts -->
            <div class="section-header">STATEMENT OF FACTS</div>
            <div class="document-section" data-section="facts">
                <div class="section-toolbar">
                    <button class="btn btn-outline-primary edit-section-btn" title="Edit"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-outline-secondary regenerate-btn" title="Regenerate"><i class="bi bi-arrow-clockwise"></i></button>
                </div>
                <div class="section-content">{{ document.final_facts }}</div>
                <div class="section-edit" style="display: none;">
                    <textarea class="edit-textarea" style="min-height: 300px;">{{ document.final_facts }}</textarea>
                    <div class="edit-actions">
                        <button class="btn btn-sm btn-primary save-btn">Save</button>
                        <button class="btn btn-sm btn-outline-secondary cancel-btn">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Causes of Action -->
            <div class="section-header">CAUSES OF ACTION</div>
            {% for cause in document.final_causes_of_action %}
            <div class="document-section cause-of-action" data-section="causes_of_action" data-cause-index="{{ forloop.counter0 }}">
                <div class="section-toolbar">
                    <button class="btn btn-outline-primary edit-section-btn" title="Edit"><i class="bi bi-pencil"></i></button>
                </div>
                <div class="section-content">{{ cause.content }}</div>
                <div class="section-edit" style="display: none;">
                    <textarea class="edit-textarea" style="min-height: 250px;">{{ cause.content }}</textarea>
                    <div class="edit-actions">
                        <button class="btn btn-sm btn-primary save-btn">Save</button>
                        <button class="btn btn-sm btn-outline-secondary cancel-btn">Cancel</button>
                    </div>
                </div>
            </div>
            {% empty %}
            <p class="text-muted">[No causes of action generated]</p>
            {% endfor %}

            <!-- Prayer for Relief -->
            <div class="section-header">PRAYER FOR RELIEF</div>
            <div class="document-section" data-section="prayer">
                <div class="section-toolbar">
                    <button class="btn btn-outline-primary edit-section-btn" title="Edit"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-outline-secondary regenerate-btn" title="Regenerate"><i class="bi bi-arrow-clockwise"></i></button>
                </div>
                <div class="section-content">{{ document.final_prayer }}</div>
                <div class="section-edit" style="display: none;">
                    <textarea class="edit-textarea">{{ document.final_prayer }}</textarea>
                    <div class="edit-actions">
                        <button class="btn btn-sm btn-primary save-btn">Save</button>
                        <button class="btn btn-sm btn-outline-secondary cancel-btn">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Jury Demand -->
            {% if document.final_jury_demand %}
            <div class="section-header">JURY DEMAND</div>
            <div class="document-section" data-section="jury_demand">
                <div class="section-toolbar">
                    <button class="btn btn-outline-primary edit-section-btn" title="Edit"><i class="bi bi-pencil"></i></button>
                </div>
                <div class="section-content">{{ document.final_jury_demand }}</div>
                <div class="section-edit" style="display: none;">
                    <textarea class="edit-textarea">{{ document.final_jury_demand }}</textarea>
                    <div class="edit-actions">
                        <button class="btn btn-sm btn-primary save-btn">Save</button>
                        <button class="btn btn-sm btn-outline-secondary cancel-btn">Cancel</button>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Signature -->
            <div class="signature-block">
                <div class="document-section" data-section="signature">
                    <div class="section-toolbar">
                        <button class="btn btn-outline-primary edit-section-btn" title="Edit"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-outline-secondary regenerate-btn" title="Regenerate"><i class="bi bi-arrow-clockwise"></i></button>
                    </div>
                    <div class="section-content">{{ document.final_signature }}</div>
                    <div class="section-edit" style="display: none;">
                        <textarea class="edit-textarea">{{ document.final_signature }}</textarea>
                        <div class="edit-actions">
                            <button class="btn btn-sm btn-primary save-btn">Save</button>
                            <button class="btn btn-sm btn-outline-secondary cancel-btn">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% else %}
        <!-- Document not yet generated -->
        <div class="generation-message">
            {% if completion_pct < 50 %}
            <h4><i class="bi bi-exclamation-circle text-warning"></i> More Information Needed</h4>
            <p class="text-muted mb-3">
                Please complete at least 50% of the document sections before generating.
                <br>Current progress: <strong>{{ completion_pct }}%</strong>
            </p>
            <a href="{% url 'documents:document_detail' document.id %}" class="btn btn-primary">
                <i class="bi bi-arrow-left"></i> Return to Edit Sections
            </a>
            {% elif not can_use_ai %}
            <h4><i class="bi bi-exclamation-circle text-warning"></i> AI Limit Reached</h4>
            <p class="text-muted mb-3">Please upgrade your subscription to generate the document.</p>
            {% else %}
            <h4><i class="bi bi-hourglass-split"></i> Generating Document...</h4>
            <p class="text-muted">Please wait while we generate your legal document.</p>
            <div class="spinner-border text-primary mt-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <script>location.reload();</script>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <div id="loadingMessage">Processing...</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const documentId = {{ document.id }};
const csrfToken = '{{ csrf_token }}';

// Regenerate from banner (when data has changed)
document.getElementById('regenerateFromBannerBtn')?.addEventListener('click', async function() {
    if (!confirm('Regenerate document with your updated information? All manual edits will be lost.')) return;
    showLoading('Regenerating document...');
    try {
        const response = await fetch(`/documents/${documentId}/final/generate/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        if (data.success) location.reload();
        else { hideLoading(); alert(data.error || 'Failed'); }
    } catch (e) { hideLoading(); alert('Error: ' + e.message); }
});

// AI Review
document.getElementById('aiReviewBtn')?.addEventListener('click', async function() {
    showLoading('AI reviewing document...');
    try {
        const response = await fetch(`/documents/${documentId}/final/ai-review/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        hideLoading();
        if (data.success) displayAIReview(data.review);
        else alert(data.error || 'Review failed');
    } catch (e) { hideLoading(); alert('Error: ' + e.message); }
});

function displayAIReview(review) {
    const panel = document.getElementById('aiReviewPanel');
    const content = document.getElementById('aiReviewContent');
    let html = `<p><strong>Assessment:</strong> ${review.overall_assessment || 'N/A'}</p>`;
    if (review.ready_for_filing !== undefined) {
        html += review.ready_for_filing
            ? '<p><span class="badge bg-success">Ready for Filing</span></p>'
            : '<p><span class="badge bg-warning text-dark">Needs Attention</span></p>';
    }
    if (review.strengths?.length) {
        html += '<h6>Strengths</h6>';
        review.strengths.forEach(s => html += `<div class="review-strength"><i class="bi bi-check-circle text-success"></i> ${s}</div>`);
    }
    if (review.issues?.length) {
        html += '<h6 class="mt-3">Issues</h6>';
        review.issues.forEach(i => html += `<div class="review-issue severity-${i.severity||'medium'}"><strong>${i.section||'General'}</strong>: ${i.issue}${i.suggestion ? `<br><em>Fix: ${i.suggestion}</em>` : ''}</div>`);
    }
    content.innerHTML = html;
    panel.style.display = 'block';
    panel.scrollIntoView({ behavior: 'smooth' });
}

// Section editing
document.querySelectorAll('.edit-section-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const section = this.closest('.document-section');
        section.classList.add('editing');
        section.querySelector('.section-content').style.display = 'none';
        section.querySelector('.section-edit').style.display = 'block';
        section.querySelector('.section-toolbar').style.display = 'none';
    });
});

document.querySelectorAll('.cancel-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const section = this.closest('.document-section');
        section.classList.remove('editing');
        section.querySelector('.section-content').style.display = 'block';
        section.querySelector('.section-edit').style.display = 'none';
    });
});

document.querySelectorAll('.save-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const section = this.closest('.document-section');
        const sectionKey = section.dataset.section;
        const causeIndex = section.dataset.causeIndex;
        const content = section.querySelector('.edit-textarea').value;
        try {
            const response = await fetch(`/documents/${documentId}/final/save-section/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/json' },
                body: JSON.stringify({ section: sectionKey, content: content, cause_index: causeIndex !== undefined ? parseInt(causeIndex) : null })
            });
            const data = await response.json();
            if (data.success) {
                section.querySelector('.section-content').textContent = content;
                section.classList.remove('editing');
                section.querySelector('.section-content').style.display = 'block';
                section.querySelector('.section-edit').style.display = 'none';
            } else alert(data.error || 'Save failed');
        } catch (e) { alert('Error: ' + e.message); }
    });
});

// Regenerate single section
document.querySelectorAll('.regenerate-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const section = this.closest('.document-section');
        const sectionKey = section.dataset.section;
        if (!confirm(`Regenerate this section? Edits will be lost.`)) return;
        showLoading('Regenerating...');
        try {
            const response = await fetch(`/documents/${documentId}/final/regenerate-section/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/json' },
                body: JSON.stringify({ section: sectionKey })
            });
            const data = await response.json();
            hideLoading();
            if (data.success) {
                section.querySelector('.section-content').textContent = data.content;
                section.querySelector('.edit-textarea').value = data.content;
            } else alert(data.error || 'Failed');
        } catch (e) { hideLoading(); alert('Error: ' + e.message); }
    });
});

function showLoading(msg) {
    document.getElementById('loadingMessage').textContent = msg;
    document.getElementById('loadingOverlay').classList.add('active');
}
function hideLoading() {
    document.getElementById('loadingOverlay').classList.remove('active');
}
</script>
{% endblock %}

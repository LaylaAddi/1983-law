{% extends 'base.html' %}

{% block title %}Final Review: {{ document.title }} - {{ header_app_name }}{% endblock %}

{% block extra_css %}
<style>
    /* Final review layout */
    .final-review-container {
        max-width: 1200px;
        margin: 0 auto;
    }

    /* Status header */
    .review-header {
        background: linear-gradient(135deg, #1a365d 0%, #2d4a7c 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }

    .review-header h1 {
        margin: 0 0 0.5rem 0;
        font-size: 1.5rem;
    }

    .review-header .meta {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    /* Action buttons */
    .action-bar {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
    }

    /* Legal document styling */
    .legal-document {
        font-family: 'Times New Roman', Times, serif;
        font-size: 14px;
        line-height: 1.8;
        background: white;
        padding: 50px 60px;
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
        border-radius: 4px;
        margin-bottom: 2rem;
    }

    .legal-document .section-header {
        text-align: center;
        font-weight: bold;
        text-decoration: underline;
        margin: 2rem 0 1rem 0;
        font-size: 14px;
    }

    .legal-document p {
        text-indent: 0.5in;
        margin-bottom: 0.5rem;
        text-align: justify;
    }

    .legal-document .no-indent {
        text-indent: 0;
    }

    .legal-document pre {
        font-family: 'Times New Roman', Times, serif;
        white-space: pre-wrap;
        font-size: 14px;
        line-height: 1.8;
        margin: 0;
        background: transparent;
        border: none;
        padding: 0;
    }

    /* Editable section styling */
    .document-section {
        position: relative;
        padding: 1rem;
        margin: 1rem -1rem;
        border-radius: 4px;
        transition: all 0.2s ease;
        border: 2px solid transparent;
    }

    .document-section:hover {
        background: rgba(13, 110, 253, 0.03);
        border-color: rgba(13, 110, 253, 0.2);
    }

    .document-section.editing {
        background: rgba(13, 110, 253, 0.05);
        border-color: #0d6efd;
    }

    .section-toolbar {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        display: none;
        gap: 0.5rem;
    }

    .document-section:hover .section-toolbar {
        display: flex;
    }

    .section-toolbar .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }

    /* Edit mode */
    .edit-textarea {
        width: 100%;
        min-height: 200px;
        font-family: 'Times New Roman', Times, serif;
        font-size: 14px;
        line-height: 1.8;
        padding: 1rem;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        resize: vertical;
    }

    .edit-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    /* AI Review Panel */
    .ai-review-panel {
        background: white;
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .ai-review-panel h3 {
        margin-bottom: 1rem;
        font-size: 1.1rem;
    }

    .review-issue {
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
    }

    .review-issue.severity-high {
        background: #f8d7da;
        border-left: 4px solid #dc3545;
    }

    .review-issue.severity-medium {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
    }

    .review-issue.severity-low {
        background: #d1ecf1;
        border-left: 4px solid #17a2b8;
    }

    .review-strength {
        padding: 0.75rem;
        background: #d4edda;
        border-left: 4px solid #28a745;
        border-radius: 4px;
        margin-bottom: 0.5rem;
    }

    /* Caption styling */
    .caption {
        text-align: center;
        margin-bottom: 2rem;
        font-family: 'Times New Roman', Times, serif;
    }

    .caption-court {
        font-weight: bold;
        text-transform: uppercase;
        margin-bottom: 1rem;
    }

    .caption-box {
        text-align: left;
        white-space: pre-wrap;
    }

    /* Cause of Action */
    .cause-of-action {
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px dashed #dee2e6;
    }

    /* Loading overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.9);
        display: none;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 1000;
    }

    .loading-overlay.active {
        display: flex;
    }

    /* No document state */
    .no-document-message {
        text-align: center;
        padding: 3rem;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .no-document-message h3 {
        margin-bottom: 1rem;
    }

    /* Progress info */
    .completion-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: rgba(255,255,255,0.2);
        border-radius: 20px;
        font-size: 0.9rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .legal-document {
            padding: 30px 20px;
        }

        .action-bar {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="final-review-container">
        <!-- Status Header -->
        <div class="review-header">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                <div>
                    <h1>{{ document.title }}</h1>
                    <div class="meta">
                        <span class="me-3"><i class="bi bi-calendar"></i> Created: {{ document.created_at|date:"M j, Y" }}</span>
                        {% if document.final_generated_at %}
                        <span class="me-3"><i class="bi bi-file-earmark-text"></i> Generated: {{ document.final_generated_at|date:"M j, Y g:i A" }}</span>
                        {% endif %}
                        {% if document.final_edited_at %}
                        <span><i class="bi bi-pencil"></i> Edited: {{ document.final_edited_at|date:"M j, Y g:i A" }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="completion-badge">
                    <i class="bi bi-pie-chart"></i>
                    {{ completion_pct }}% Complete
                </div>
            </div>
        </div>

        <!-- Action Bar -->
        <div class="action-bar">
            {% if not has_final_document %}
            <button id="generateBtn" class="btn btn-primary" {% if completion_pct < 50 %}disabled{% endif %}>
                <i class="bi bi-magic"></i> Generate Document
            </button>
            {% if completion_pct < 50 %}
            <span class="text-muted align-self-center">Complete at least 50% of sections before generating</span>
            {% endif %}
            {% else %}
            <button id="regenerateAllBtn" class="btn btn-outline-primary">
                <i class="bi bi-arrow-clockwise"></i> Regenerate All
            </button>
            <button id="aiReviewBtn" class="btn btn-info text-white" {% if not can_use_ai %}disabled{% endif %}>
                <i class="bi bi-robot"></i> AI Review
            </button>
            <a href="{% url 'documents:download_final_pdf' document.id %}" class="btn btn-success">
                <i class="bi bi-file-earmark-pdf"></i> Download PDF
            </a>
            {% endif %}
            <a href="{% url 'documents:document_detail' document.id %}" class="btn btn-outline-secondary ms-auto">
                <i class="bi bi-arrow-left"></i> Back to Document
            </a>
        </div>

        <!-- AI Review Results Panel (hidden by default) -->
        <div id="aiReviewPanel" class="ai-review-panel" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3><i class="bi bi-robot"></i> AI Review Results</h3>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('aiReviewPanel').style.display='none'">
                    <i class="bi bi-x"></i> Close
                </button>
            </div>
            <div id="aiReviewContent">
                <!-- AI review content will be inserted here -->
            </div>
        </div>

        {% if has_final_document %}
        <!-- The Legal Document -->
        <div class="legal-document">
            <!-- Caption (generated from data, not editable here) -->
            <div class="caption">
                <div class="caption-court">{{ document_data.court|default:"UNITED STATES DISTRICT COURT" }}</div>
                <div class="caption-box">
                    <pre>{{ document_data.plaintiff.first_name|upper }} {{ document_data.plaintiff.last_name|upper }},
    Plaintiff,

v.                                          Case No. ________________

{% for defendant in document_data.defendants %}{{ defendant.name|upper }}{% if not forloop.last %},
{% endif %}{% empty %}UNKNOWN DEFENDANTS{% endfor %},
    Defendants.

________________________________________

COMPLAINT FOR VIOLATION OF CIVIL RIGHTS
PURSUANT TO 42 U.S.C. ยง 1983

________________________________________</pre>
                </div>
            </div>

            <!-- Introduction -->
            <div class="document-section" data-section="introduction">
                <div class="section-toolbar">
                    <button class="btn btn-sm btn-outline-primary edit-section-btn" title="Edit">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary regenerate-btn" title="Regenerate">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="section-content">
                    <pre>{{ document.final_introduction }}</pre>
                </div>
                <div class="section-edit" style="display: none;">
                    <textarea class="edit-textarea">{{ document.final_introduction }}</textarea>
                    <div class="edit-actions">
                        <button class="btn btn-sm btn-primary save-btn">Save</button>
                        <button class="btn btn-sm btn-outline-secondary cancel-btn">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Jurisdiction -->
            <div class="document-section" data-section="jurisdiction">
                <div class="section-toolbar">
                    <button class="btn btn-sm btn-outline-primary edit-section-btn" title="Edit">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary regenerate-btn" title="Regenerate">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="section-content">
                    <pre>{{ document.final_jurisdiction }}</pre>
                </div>
                <div class="section-edit" style="display: none;">
                    <textarea class="edit-textarea">{{ document.final_jurisdiction }}</textarea>
                    <div class="edit-actions">
                        <button class="btn btn-sm btn-primary save-btn">Save</button>
                        <button class="btn btn-sm btn-outline-secondary cancel-btn">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Parties -->
            <div class="document-section" data-section="parties">
                <div class="section-toolbar">
                    <button class="btn btn-sm btn-outline-primary edit-section-btn" title="Edit">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary regenerate-btn" title="Regenerate">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="section-content">
                    <pre>{{ document.final_parties }}</pre>
                </div>
                <div class="section-edit" style="display: none;">
                    <textarea class="edit-textarea">{{ document.final_parties }}</textarea>
                    <div class="edit-actions">
                        <button class="btn btn-sm btn-primary save-btn">Save</button>
                        <button class="btn btn-sm btn-outline-secondary cancel-btn">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Statement of Facts -->
            <div class="document-section" data-section="facts">
                <div class="section-toolbar">
                    <button class="btn btn-sm btn-outline-primary edit-section-btn" title="Edit">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary regenerate-btn" title="Regenerate">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="section-content">
                    <pre>{{ document.final_facts }}</pre>
                </div>
                <div class="section-edit" style="display: none;">
                    <textarea class="edit-textarea" style="min-height: 400px;">{{ document.final_facts }}</textarea>
                    <div class="edit-actions">
                        <button class="btn btn-sm btn-primary save-btn">Save</button>
                        <button class="btn btn-sm btn-outline-secondary cancel-btn">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Causes of Action -->
            {% for cause in document.final_causes_of_action %}
            <div class="document-section cause-of-action" data-section="causes_of_action" data-cause-index="{{ forloop.counter0 }}">
                <div class="section-toolbar">
                    <button class="btn btn-sm btn-outline-primary edit-section-btn" title="Edit">
                        <i class="bi bi-pencil"></i>
                    </button>
                </div>
                <div class="section-content">
                    <pre>{{ cause.content }}</pre>
                </div>
                <div class="section-edit" style="display: none;">
                    <textarea class="edit-textarea" style="min-height: 400px;">{{ cause.content }}</textarea>
                    <div class="edit-actions">
                        <button class="btn btn-sm btn-primary save-btn">Save</button>
                        <button class="btn btn-sm btn-outline-secondary cancel-btn">Cancel</button>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="section-header">CAUSES OF ACTION</div>
            <p class="text-muted no-indent">[No causes of action generated. Please ensure Rights Violated section is complete.]</p>
            {% endfor %}

            <!-- Prayer for Relief -->
            <div class="document-section" data-section="prayer">
                <div class="section-toolbar">
                    <button class="btn btn-sm btn-outline-primary edit-section-btn" title="Edit">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary regenerate-btn" title="Regenerate">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="section-content">
                    <pre>{{ document.final_prayer }}</pre>
                </div>
                <div class="section-edit" style="display: none;">
                    <textarea class="edit-textarea">{{ document.final_prayer }}</textarea>
                    <div class="edit-actions">
                        <button class="btn btn-sm btn-primary save-btn">Save</button>
                        <button class="btn btn-sm btn-outline-secondary cancel-btn">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Jury Demand -->
            {% if document.final_jury_demand %}
            <div class="document-section" data-section="jury_demand">
                <div class="section-toolbar">
                    <button class="btn btn-sm btn-outline-primary edit-section-btn" title="Edit">
                        <i class="bi bi-pencil"></i>
                    </button>
                </div>
                <div class="section-content">
                    <pre>{{ document.final_jury_demand }}</pre>
                </div>
                <div class="section-edit" style="display: none;">
                    <textarea class="edit-textarea">{{ document.final_jury_demand }}</textarea>
                    <div class="edit-actions">
                        <button class="btn btn-sm btn-primary save-btn">Save</button>
                        <button class="btn btn-sm btn-outline-secondary cancel-btn">Cancel</button>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Signature -->
            <div class="document-section" data-section="signature">
                <div class="section-toolbar">
                    <button class="btn btn-sm btn-outline-primary edit-section-btn" title="Edit">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary regenerate-btn" title="Regenerate">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="section-content">
                    <pre>{{ document.final_signature }}</pre>
                </div>
                <div class="section-edit" style="display: none;">
                    <textarea class="edit-textarea">{{ document.final_signature }}</textarea>
                    <div class="edit-actions">
                        <button class="btn btn-sm btn-primary save-btn">Save</button>
                        <button class="btn btn-sm btn-outline-secondary cancel-btn">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        {% else %}
        <!-- No document generated yet -->
        <div class="no-document-message">
            <h3><i class="bi bi-file-earmark-text text-muted"></i></h3>
            <h3>Document Not Yet Generated</h3>
            <p class="text-muted mb-4">
                Click "Generate Document" above to create your legal complaint from the information you've entered.
                {% if completion_pct < 50 %}
                <br><strong>Note:</strong> Please complete at least 50% of the sections before generating.
                {% endif %}
            </p>
            <a href="{% url 'documents:document_detail' document.id %}" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left"></i> Return to Edit Sections
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <div id="loadingMessage">Generating document...</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const documentId = {{ document.id }};
const csrfToken = '{{ csrf_token }}';

// Generate document
document.getElementById('generateBtn')?.addEventListener('click', async function() {
    showLoading('Generating your legal document...');

    try {
        const response = await fetch(`/documents/${documentId}/final/generate/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            location.reload();
        } else if (data.limit_reached) {
            hideLoading();
            alert('AI limit reached. Please upgrade to continue.');
        } else {
            hideLoading();
            alert(data.error || 'Failed to generate document');
        }
    } catch (error) {
        hideLoading();
        alert('Error: ' + error.message);
    }
});

// Regenerate all
document.getElementById('regenerateAllBtn')?.addEventListener('click', async function() {
    if (!confirm('This will regenerate all sections. Any manual edits will be lost. Continue?')) {
        return;
    }

    showLoading('Regenerating document...');

    try {
        const response = await fetch(`/documents/${documentId}/final/generate/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            location.reload();
        } else {
            hideLoading();
            alert(data.error || 'Failed to regenerate document');
        }
    } catch (error) {
        hideLoading();
        alert('Error: ' + error.message);
    }
});

// AI Review
document.getElementById('aiReviewBtn')?.addEventListener('click', async function() {
    showLoading('AI is reviewing your document...');

    try {
        const response = await fetch(`/documents/${documentId}/final/ai-review/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();
        hideLoading();

        if (data.success) {
            displayAIReview(data.review);
        } else if (data.limit_reached) {
            alert('AI limit reached. Please upgrade to continue.');
        } else {
            alert(data.error || 'Failed to get AI review');
        }
    } catch (error) {
        hideLoading();
        alert('Error: ' + error.message);
    }
});

function displayAIReview(review) {
    const panel = document.getElementById('aiReviewPanel');
    const content = document.getElementById('aiReviewContent');

    let html = '';

    // Overall assessment
    html += `<div class="mb-3"><strong>Overall Assessment:</strong> ${review.overall_assessment || 'N/A'}</div>`;

    // Ready for filing badge
    if (review.ready_for_filing !== undefined) {
        const badge = review.ready_for_filing
            ? '<span class="badge bg-success">Ready for Filing</span>'
            : '<span class="badge bg-warning text-dark">Needs Attention</span>';
        html += `<div class="mb-3">${badge}</div>`;
    }

    // Strengths
    if (review.strengths && review.strengths.length > 0) {
        html += '<h5 class="mt-3">Strengths</h5>';
        review.strengths.forEach(strength => {
            html += `<div class="review-strength"><i class="bi bi-check-circle text-success"></i> ${strength}</div>`;
        });
    }

    // Issues
    if (review.issues && review.issues.length > 0) {
        html += '<h5 class="mt-3">Issues to Address</h5>';
        review.issues.forEach(issue => {
            html += `
                <div class="review-issue severity-${issue.severity || 'medium'}">
                    <div><strong>${issue.section || 'General'}</strong> <span class="badge bg-${issue.severity === 'high' ? 'danger' : issue.severity === 'medium' ? 'warning' : 'info'}">${issue.severity || 'medium'}</span></div>
                    <div class="mt-1">${issue.issue}</div>
                    ${issue.suggestion ? `<div class="mt-1 text-muted"><em>Suggestion: ${issue.suggestion}</em></div>` : ''}
                    ${issue.example_text ? `<div class="mt-2 p-2 bg-light border-start border-3 border-primary"><small><strong>Example:</strong> ${issue.example_text}</small></div>` : ''}
                </div>
            `;
        });
    }

    content.innerHTML = html;
    panel.style.display = 'block';
    panel.scrollIntoView({ behavior: 'smooth' });
}

// Section editing
document.querySelectorAll('.edit-section-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const section = this.closest('.document-section');
        section.classList.add('editing');
        section.querySelector('.section-content').style.display = 'none';
        section.querySelector('.section-edit').style.display = 'block';
        section.querySelector('.section-toolbar').style.display = 'none';
    });
});

document.querySelectorAll('.cancel-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const section = this.closest('.document-section');
        section.classList.remove('editing');
        section.querySelector('.section-content').style.display = 'block';
        section.querySelector('.section-edit').style.display = 'none';
    });
});

document.querySelectorAll('.save-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const section = this.closest('.document-section');
        const sectionKey = section.dataset.section;
        const causeIndex = section.dataset.causeIndex;
        const content = section.querySelector('.edit-textarea').value;

        try {
            const response = await fetch(`/documents/${documentId}/final/save-section/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    section: sectionKey,
                    content: content,
                    cause_index: causeIndex !== undefined ? parseInt(causeIndex) : null
                })
            });

            const data = await response.json();

            if (data.success) {
                // Update displayed content
                section.querySelector('.section-content pre').textContent = content;
                section.classList.remove('editing');
                section.querySelector('.section-content').style.display = 'block';
                section.querySelector('.section-edit').style.display = 'none';
            } else {
                alert(data.error || 'Failed to save');
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    });
});

// Regenerate single section
document.querySelectorAll('.regenerate-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const section = this.closest('.document-section');
        const sectionKey = section.dataset.section;

        if (!confirm(`Regenerate ${sectionKey.replace(/_/g, ' ')}? Any edits will be lost.`)) {
            return;
        }

        showLoading('Regenerating section...');

        try {
            const response = await fetch(`/documents/${documentId}/final/regenerate-section/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ section: sectionKey })
            });

            const data = await response.json();
            hideLoading();

            if (data.success) {
                section.querySelector('.section-content pre').textContent = data.content;
                section.querySelector('.edit-textarea').value = data.content;
            } else {
                alert(data.error || 'Failed to regenerate');
            }
        } catch (error) {
            hideLoading();
            alert('Error: ' + error.message);
        }
    });
});

function showLoading(message) {
    document.getElementById('loadingMessage').textContent = message;
    document.getElementById('loadingOverlay').classList.add('active');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.remove('active');
}
</script>
{% endblock %}

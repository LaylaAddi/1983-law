{% extends 'base.html' %}

{% block title %}Preview: {{ document.title }} - {{ header_app_name }}{% endblock %}

{% block extra_css %}
<style>
    /* Draft watermark */
    .draft-watermark {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-45deg);
        font-size: 60px;
        font-weight: bold;
        color: rgba(128, 128, 128, 0.15);
        white-space: nowrap;
        pointer-events: none;
        z-index: 1000;
        user-select: none;
    }

    /* Print styles for watermark */
    @media print {
        .draft-watermark {
            position: fixed;
            color: rgba(128, 128, 128, 0.2);
        }
    }

    /* Legal document styling */
    .legal-document {
        font-family: 'Times New Roman', Times, serif;
        font-size: 14px;
        line-height: 2;
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 60px 72px;
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }

    .legal-document .caption {
        text-align: center;
        white-space: pre-line;
        margin-bottom: 2rem;
        line-height: 1.8;
    }

    .legal-document .section-header {
        text-align: center;
        font-weight: bold;
        text-decoration: underline;
        margin: 2rem 0 1rem 0;
    }

    .legal-document .cause-header {
        text-align: center;
        font-weight: bold;
        margin: 2rem 0 1rem 0;
    }

    .legal-document p {
        text-indent: 0.5in;
        margin-bottom: 0;
        text-align: justify;
    }

    .legal-document .no-indent {
        text-indent: 0;
    }

    .legal-document .signature-block {
        margin-top: 3rem;
        white-space: pre-line;
        line-height: 1.5;
    }

    .legal-document .prayer-item {
        margin-left: 0.5in;
        text-indent: -0.25in;
        margin-bottom: 0.5rem;
    }

    /* Preview controls */
    .preview-controls {
        position: sticky;
        top: 0;
        background: #f8f9fa;
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
        z-index: 100;
        margin-bottom: 2rem;
    }

    /* Missing data alert */
    .missing-data-card {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    /* Tab styling */
    .nav-tabs .nav-link {
        color: #6c757d;
    }
    .nav-tabs .nav-link.active {
        font-weight: 600;
    }

    /* Raw data view styling */
    .raw-data-section {
        border-left: 4px solid #dee2e6;
        padding-left: 1.5rem;
        margin-bottom: 2rem;
    }
    .raw-data-section.completed {
        border-left-color: #198754;
    }

    /* Print styles */
    @media print {
        .no-print, .preview-controls, .nav-tabs {
            display: none !important;
        }
        .legal-document {
            box-shadow: none;
            padding: 0;
            max-width: none;
        }
        body {
            background: white;
        }
    }
</style>
{% endblock %}

{% block content %}
{% if document.payment_status != 'finalized' %}
<!-- Draft Watermark -->
<div class="draft-watermark">DRAFT - {{ app_name }}</div>
{% endif %}

<!-- Status Banner -->
<div class="container-fluid no-print">
    {% include 'documents/partials/status_banner.html' %}
</div>

<!-- Preview Controls -->
<div class="preview-controls no-print">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
                <a href="{% url 'documents:document_detail' document.id %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Back to Document
                </a>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" onclick="window.print()">
                    <i class="bi bi-printer me-1"></i>Print
                </button>
                {% if document.payment_status == 'finalized' %}
                <a href="{% url 'documents:download_pdf' document.id %}" class="btn btn-success">
                    <i class="bi bi-file-earmark-pdf me-1"></i>Download PDF
                </a>
                {% endif %}
                {% if generated_document %}
                <a href="?generate=false" class="btn btn-outline-secondary">
                    <i class="bi bi-eye me-1"></i>View Raw Data
                </a>
                {% else %}
                <a href="?generate=true" class="btn btn-primary">
                    <i class="bi bi-file-earmark-text me-1"></i>Generate Legal Document
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="container-fluid py-4">
    {% if generation_error %}
    <div class="container mb-4">
        <div class="alert alert-danger">
            <h5><i class="bi bi-exclamation-triangle me-2"></i>Document Generation Error</h5>
            <p class="mb-0">{{ generation_error }}</p>
        </div>
    </div>
    {% endif %}

    {% if generated_document %}
    <!-- GENERATED LEGAL DOCUMENT VIEW -->
    <div class="legal-document">
        <!-- Caption -->
        <div class="caption">
{{ generated_document.caption }}
        </div>

        <!-- Introduction -->
        <p class="no-indent">{{ generated_document.introduction }}</p>

        <!-- Jurisdiction and Venue -->
        <div class="section">
{{ generated_document.jurisdiction|linebreaks }}
        </div>

        <!-- Parties -->
        <div class="section">
{{ generated_document.parties|linebreaks }}
        </div>

        <!-- Statement of Facts -->
        <div class="section">
{{ generated_document.facts|linebreaks }}
        </div>

        <!-- Causes of Action -->
        <div class="section-header">CAUSES OF ACTION</div>
        {% for cause in generated_document.causes_of_action %}
        <div class="section">
{{ cause.content|linebreaks }}
        </div>
        {% empty %}
        <p class="text-muted"><em>No causes of action generated. Please ensure you have selected which constitutional rights were violated.</em></p>
        {% endfor %}

        <!-- Prayer for Relief -->
        <div class="section">
{{ generated_document.prayer|linebreaks }}
        </div>

        <!-- Jury Demand -->
        {% if generated_document.jury_demand %}
        <div class="section">
{{ generated_document.jury_demand|linebreaks }}
        </div>
        {% endif %}

        <!-- Signature Block -->
        <div class="signature-block">
{{ generated_document.signature }}
        </div>
    </div>

    {% else %}
    <!-- RAW DATA VIEW (when document not generated or missing data) -->

    {% if not document_data.has_minimum_data %}
    <!-- Missing Data Warning -->
    <div class="container">
        <div class="missing-data-card">
            <h5><i class="bi bi-exclamation-triangle me-2"></i>More Information Needed</h5>
            <p class="mb-2">To generate a legal document, please complete the following:</p>
            <ul class="mb-3">
                {% if not document_data.plaintiff.first_name or not document_data.plaintiff.last_name %}
                <li>Complete your <a href="{% url 'documents:section_edit' document.id 'plaintiff_info' %}">Plaintiff Information</a> (need first and last name)</li>
                {% endif %}
                {% if not document_data.narrative.detailed_narrative %}
                <li>Add your <a href="{% url 'documents:section_edit' document.id 'incident_narrative' %}">Incident Narrative</a> (need detailed narrative)</li>
                {% endif %}
                {% if not document_data.rights_violated.first_amendment and not document_data.rights_violated.fourth_amendment and not document_data.rights_violated.fifth_amendment and not document_data.rights_violated.fourteenth_amendment %}
                <li>Select which <a href="{% url 'documents:section_edit' document.id 'rights_violated' %}">Rights Were Violated</a> (need at least one amendment)</li>
                {% endif %}
            </ul>
            <details class="mt-3">
                <summary class="text-muted" style="cursor: pointer;">Debug: Current Data Status</summary>
                <pre class="mt-2 p-2 bg-light" style="font-size: 0.8rem;">
Plaintiff: {{ document_data.plaintiff.first_name }} {{ document_data.plaintiff.last_name }}
Has Narrative: {{ document_data.narrative.detailed_narrative|yesno:"Yes,No" }}
First Amendment: {{ document_data.rights_violated.first_amendment|yesno:"Yes,No" }}
Fourth Amendment: {{ document_data.rights_violated.fourth_amendment|yesno:"Yes,No" }}
Fifth Amendment: {{ document_data.rights_violated.fifth_amendment|yesno:"Yes,No" }}
Fourteenth Amendment: {{ document_data.rights_violated.fourteenth_amendment|yesno:"Yes,No" }}
Has Minimum Data: {{ document_data.has_minimum_data|yesno:"Yes,No" }}
                </pre>
            </details>
            <a href="{% url 'documents:document_detail' document.id %}" class="btn btn-primary mt-3">
                <i class="bi bi-pencil me-1"></i>Continue Editing
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Raw Data Display -->
    <div class="container">
        <h2 class="mb-4">{{ document.title }}</h2>

        <!-- Plaintiff Information -->
        {% with section_data=sections_data.plaintiff_info %}
        {% if section_data %}
        <div class="raw-data-section {% if section_data.section.status == 'completed' %}completed{% endif %}">
            <h4><i class="bi bi-person me-2"></i>Plaintiff Information</h4>
            {% if section_data.data %}
            <p><strong>Name:</strong> {{ section_data.data.first_name }} {{ section_data.data.middle_name }} {{ section_data.data.last_name }}</p>
            <p><strong>Address:</strong> {{ section_data.data.street_address }}, {{ section_data.data.city }}, {{ section_data.data.state }} {{ section_data.data.zip_code }}</p>
            <p><strong>Phone:</strong> {{ section_data.data.phone }}</p>
            <p><strong>Email:</strong> {{ section_data.data.email }}</p>
            <p><strong>Representation:</strong> {% if section_data.data.is_pro_se %}Pro Se{% else %}Represented by {{ section_data.data.attorney_name }}{% endif %}</p>
            {% else %}
            <p class="text-muted"><em>No information provided yet.</em></p>
            {% endif %}
        </div>
        {% endif %}
        {% endwith %}

        <!-- Incident Overview -->
        {% with section_data=sections_data.incident_overview %}
        {% if section_data %}
        <div class="raw-data-section {% if section_data.section.status == 'completed' %}completed{% endif %}">
            <h4><i class="bi bi-calendar-event me-2"></i>Incident Overview</h4>
            {% if section_data.data %}
            <p><strong>Date:</strong> {{ section_data.data.incident_date|date:"F j, Y"|default:"Not provided" }}</p>
            <p><strong>Time:</strong> {{ section_data.data.incident_time|time:"g:i A"|default:"Not provided" }}</p>
            <p><strong>Location:</strong> {{ section_data.data.incident_location }}, {{ section_data.data.city }}, {{ section_data.data.state }}</p>
            <p><strong>Federal Court:</strong> {{ section_data.data.federal_district_court|default:"Not determined" }}</p>
            {% else %}
            <p class="text-muted"><em>No information provided yet.</em></p>
            {% endif %}
        </div>
        {% endif %}
        {% endwith %}

        <!-- Defendants -->
        {% with section_data=sections_data.defendants %}
        {% if section_data %}
        <div class="raw-data-section {% if section_data.section.status == 'completed' %}completed{% endif %}">
            <h4><i class="bi bi-shield-exclamation me-2"></i>Defendants</h4>
            {% if section_data.data %}
            {% for defendant in section_data.data %}
            <div class="card mb-2 {% if defendant.defendant_type == 'individual' and not defendant.agency_name %}border-danger{% endif %}">
                <div class="card-body py-2">
                    <strong>{{ defendant.name }}</strong>
                    {% if defendant.title_rank %} - {{ defendant.title_rank }}{% endif %}
                    {% if defendant.agency_name %}
                    <br><small class="text-muted">{{ defendant.agency_name }}</small>
                    {% elif defendant.defendant_type == 'individual' %}
                    <br><small class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>Missing agency - required for proper service</small>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% else %}
            <p class="text-muted"><em>No defendants added yet.</em></p>
            {% endif %}
        </div>
        {% endif %}
        {% endwith %}

        <!-- Incident Narrative -->
        {% with section_data=sections_data.incident_narrative %}
        {% if section_data %}
        <div class="raw-data-section {% if section_data.section.status == 'completed' %}completed{% endif %}">
            <h4><i class="bi bi-journal-text me-2"></i>Incident Narrative</h4>
            {% if section_data.data %}
            <p>{{ section_data.data.detailed_narrative|default:"No narrative provided"|linebreaks }}</p>
            {% else %}
            <p class="text-muted"><em>No information provided yet.</em></p>
            {% endif %}
        </div>
        {% endif %}
        {% endwith %}

        <!-- Rights Violated -->
        {% with section_data=sections_data.rights_violated %}
        {% if section_data %}
        <div class="raw-data-section {% if section_data.section.status == 'completed' %}completed{% endif %}">
            <h4><i class="bi bi-file-earmark-ruled me-2"></i>Rights Violated</h4>
            {% if section_data.data %}
            <ul>
                {% if section_data.data.first_amendment %}<li>First Amendment</li>{% endif %}
                {% if section_data.data.fourth_amendment %}<li>Fourth Amendment</li>{% endif %}
                {% if section_data.data.fifth_amendment %}<li>Fifth Amendment</li>{% endif %}
                {% if section_data.data.fourteenth_amendment %}<li>Fourteenth Amendment</li>{% endif %}
            </ul>
            {% else %}
            <p class="text-muted"><em>No rights selected yet.</em></p>
            {% endif %}
        </div>
        {% endif %}
        {% endwith %}

        <!-- Relief Sought -->
        {% with section_data=sections_data.relief_sought %}
        {% if section_data %}
        <div class="raw-data-section {% if section_data.section.status == 'completed' %}completed{% endif %}">
            <h4><i class="bi bi-trophy me-2"></i>Relief Sought</h4>
            {% if section_data.data %}
            <ul>
                {% if section_data.data.compensatory_damages %}<li>Compensatory Damages</li>{% endif %}
                {% if section_data.data.punitive_damages %}<li>Punitive Damages</li>{% endif %}
                {% if section_data.data.injunctive_relief %}<li>Injunctive Relief</li>{% endif %}
                {% if section_data.data.declaratory_relief %}<li>Declaratory Relief</li>{% endif %}
                {% if section_data.data.attorney_fees %}<li>Attorney's Fees</li>{% endif %}
            </ul>
            {% if section_data.data.jury_trial_demanded %}
            <p><strong>Jury Trial:</strong> Demanded</p>
            {% endif %}
            {% else %}
            <p class="text-muted"><em>No relief specified yet.</em></p>
            {% endif %}
        </div>
        {% endif %}
        {% endwith %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Nothing needed for now - purely display
</script>
{% endblock %}

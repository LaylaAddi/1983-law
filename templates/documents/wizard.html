{% extends "base.html" %}
{% load static %}

{% block title %}Case Interview - {{ document.title }}{% endblock %}

{% block extra_css %}
<style>
    .wizard-progress { background: var(--bs-dark, #1a1a2e); border-radius: 12px; padding: 1rem 1.5rem; margin-bottom: 2rem; }
    .wizard-step-dot { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.85rem; transition: all 0.3s ease; cursor: pointer; border: 2px solid transparent; }
    .wizard-step-dot.active { background: #0d6efd; color: #fff; border-color: #0d6efd; box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.25); }
    .wizard-step-dot.completed { background: #198754; color: #fff; border-color: #198754; }
    .wizard-step-dot.pending { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.5); border-color: rgba(255,255,255,0.2); }
    .wizard-step-line { flex: 1; height: 2px; background: rgba(255,255,255,0.15); margin: 0 0.25rem; }
    .wizard-step-line.completed { background: #198754; }
    .wizard-step-label { font-size: 0.7rem; color: rgba(255,255,255,0.6); margin-top: 0.25rem; white-space: nowrap; }
    .wizard-step-label.active { color: #fff; }

    .step-card { display: none; }
    .step-card.active { display: block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .ai-badge { font-size: 0.7rem; background: rgba(13,110,253,0.1); color: #0d6efd; padding: 2px 8px; border-radius: 12px; display: inline-block; margin-left: 0.5rem; }

    .voice-btn { border: none; background: none; color: #6c757d; padding: 0.375rem; cursor: pointer; transition: color 0.2s; }
    .voice-btn:hover { color: #0d6efd; }
    .voice-btn.recording { color: #dc3545; animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .violation-card { border: 2px solid transparent; border-radius: 8px; padding: 1rem; cursor: pointer; transition: all 0.2s; background: var(--bs-body-bg); }
    .violation-card:hover { border-color: rgba(13,110,253,0.3); }
    .violation-card.selected { border-color: #0d6efd; background: rgba(13,110,253,0.05); }

    .analysis-card { border-left: 4px solid; border-radius: 8px; padding: 1rem 1.25rem; margin-bottom: 1rem; }
    .analysis-card.strong { border-left-color: #198754; }
    .analysis-card.moderate { border-left-color: #ffc107; }
    .analysis-card.worth_including { border-left-color: #6c757d; }

    .strength-badge { font-size: 0.75rem; padding: 2px 10px; border-radius: 12px; }
    .strength-badge.strong { background: rgba(25,135,84,0.15); color: #198754; }
    .strength-badge.moderate { background: rgba(255,193,7,0.15); color: #b58a00; }
    .strength-badge.worth_including { background: rgba(108,117,125,0.15); color: #6c757d; }

    .terminal-box { background: #0a0a1a; border-radius: 8px; padding: 1rem; font-family: monospace; font-size: 0.85rem; color: #00ff88; max-height: 200px; overflow-y: auto; }
    .terminal-cursor { display: inline-block; width: 8px; height: 14px; background: #00ff88; animation: blink 1s step-end infinite; vertical-align: middle; }
    @keyframes blink { 50% { opacity: 0; } }

    /* Include toggle for analysis cards */
    .analysis-card .include-toggle { opacity: 0.7; transition: opacity 0.2s; }
    .analysis-card .include-toggle:hover { opacity: 1; }
    .analysis-card.excluded { opacity: 0.5; border-left-style: dashed; }
    .analysis-card.excluded .include-label { text-decoration: line-through; }
    .case-law-card { transition: opacity 0.2s; }
    .case-law-card.excluded { opacity: 0.5; }
    .research-link { font-size: 0.8rem; text-decoration: none; }
    .research-link:hover { text-decoration: underline; }

    /* Violation explanation modal */
    .violation-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1050; display: flex; align-items: center; justify-content: center; }
    .violation-modal-content { background: var(--bs-body-bg, #fff); border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; padding: 2rem; position: relative; }
    .violation-modal-content .close-btn { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--bs-body-color); }

    /* Court district box */
    .wizard-court-box {
        background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
        border: 2px solid #ff9800;
        border-radius: 0.5rem;
        padding: 1.25rem;
        margin-top: 0.5rem;
    }
    .wizard-court-box .box-header {
        color: #e65100;
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
    }
    .wizard-court-box .box-header i {
        font-size: 1.3rem;
        margin-right: 0.5rem;
    }
    .wizard-court-confirmation {
        background: #fff;
        border: 2px solid #dc3545;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-top: 1rem;
    }
    .wizard-court-confirmation.confirmed {
        border-color: #198754;
        background: #d1e7dd;
    }
    .wizard-court-confirmation label {
        font-weight: 600;
        color: #dc3545;
    }
    .wizard-court-confirmation.confirmed label {
        color: #198754;
    }

    /* Dark mode overrides */
    [data-theme="dark"] .alert-primary { background-color: #1e3a5f; border-color: #2c5282; color: #e0e0e0; }
    [data-theme="dark"] .alert-primary .alert-heading { color: #90cdf4; }
    [data-theme="dark"] .alert-primary hr { border-color: #4a7ab0; }
    [data-theme="dark"] .card.border-info { border-color: #2c5a6a !important; }
    [data-theme="dark"] .card.border-info .card-header.bg-info { background-color: #1a3a4a !important; border-color: #2c5a6a; }
    [data-theme="dark"] .alert-light { background-color: #2a2a3e; border-color: #3a3a4e; color: #e0e0e0; }
    [data-theme="dark"] .violation-modal-content { background: #1a1a2e; color: #e0e0e0; }
    [data-theme="dark"] .wizard-court-box { background: linear-gradient(135deg, #2a2000 0%, #3a2e00 100%); border-color: #b36d00; }
    [data-theme="dark"] .wizard-court-box .box-header { color: #ffb74d; }
    [data-theme="dark"] .wizard-court-confirmation { background: #1a1a2e; border-color: #dc3545; }
    [data-theme="dark"] .wizard-court-confirmation.confirmed { background: #1a3a2e; border-color: #198754; }
</style>
{% endblock %}

{% block content %}
<div x-data="wizardApp()" x-init="init()">

    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'documents:document_list' %}">Documents</a></li>
            <li class="breadcrumb-item"><a href="{% url 'documents:document_detail' document.slug %}">{{ document.title|truncatechars:30 }}</a></li>
            <li class="breadcrumb-item active">Case Interview</li>
        </ol>
    </nav>

    <!-- Progress Bar -->
    <div class="wizard-progress" x-show="currentView !== 'story'">
        <div class="d-flex align-items-center justify-content-between">
            <template x-for="(step, index) in steps" :key="index">
                <div class="d-flex align-items-center" :class="index < steps.length - 1 ? 'flex-fill' : ''">
                    <div class="text-center">
                        <div class="wizard-step-dot"
                             :class="{
                                 'active': currentStep === index + 1,
                                 'completed': stepCompleted(index + 1),
                                 'pending': currentStep !== index + 1 && !stepCompleted(index + 1)
                             }"
                             @click="goToStep(index + 1)">
                            <span x-show="!stepCompleted(index + 1)" x-text="index + 1"></span>
                            <i x-show="stepCompleted(index + 1)" class="bi bi-check"></i>
                        </div>
                        <div class="wizard-step-label d-none d-md-block"
                             :class="{ 'active': currentStep === index + 1 }"
                             x-text="step.title"></div>
                    </div>
                    <div x-show="index < steps.length - 1"
                         class="wizard-step-line"
                         :class="{ 'completed': stepCompleted(index + 1) }"></div>
                </div>
            </template>
        </div>
    </div>

    <!-- ==================== STORY INPUT VIEW ==================== -->
    <div x-show="currentView === 'story'" class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body p-4">
                    <h3 class="mb-3"><i class="bi bi-journal-text me-2"></i>Tell Your Story</h3>

                    <div class="alert alert-primary mb-3">
                        <h5 class="alert-heading"><i class="bi bi-shield-check me-2"></i>This is a Legal Document</h5>
                        <p class="mb-2">
                            Your story will form the foundation of your Section 1983 civil rights complaint, which will be filed in federal court.
                            <strong>Accuracy matters.</strong> Take your time and include as much detail as you can remember.
                        </p>
                        <hr>
                        <p class="mb-0 small">
                            <i class="bi bi-mic me-1"></i>
                            <strong>Prefer to speak?</strong> Click the microphone icon to dictate your story using voice.
                        </p>
                    </div>

                    <div class="mb-3">
                        <h5>What to Include:</h5>
                        <p class="text-muted">
                            Describe what happened in your own words. Don't worry about legal language - just tell us your story
                            as if you're explaining it to a friend. The more detail you provide, the better we can help build your case.
                        </p>
                        <ul class="text-muted small">
                            <li><strong>When and where</strong> did this happen? (dates, times, addresses, city, state)</li>
                            <li><strong>Who was involved?</strong> (officer names, badge numbers, agencies)</li>
                            <li><strong>What was said?</strong> (quote conversations as accurately as possible)</li>
                            <li><strong>What was done?</strong> (physical actions, arrests, searches)</li>
                            <li><strong>What harm did you suffer?</strong> (injuries, emotional distress, financial losses)</li>
                            <li><strong>Who else saw this?</strong> (witnesses, bystanders)</li>
                            <li><strong>Do you have evidence?</strong> (video, photos, documents)</li>
                            <li><strong>Were you recording?</strong> (phone, camera, dashcam - mention the device)</li>
                        </ul>
                    </div>

                    <div class="mb-3">
                        {% if test_stories %}
                        <!-- Test User: Sample Stories Dropdown -->
                        <div class="mb-3">
                            <div class="alert alert-info py-2">
                                <i class="bi bi-lightning me-1"></i>
                                <strong>Test Mode:</strong> Select a sample story to test the AI parsing
                            </div>
                            <label for="testStorySelect" class="form-label fw-bold">Select Sample Story</label>
                            <select id="testStorySelect" class="form-select mb-2"
                                    @change="let id = parseInt($event.target.value); if (id && testStories[id]) story = testStories[id];">
                                <option value="">-- Choose a test story --</option>
                                {% for s in test_stories %}
                                <option value="{{ s.id }}">
                                    {{ s.id }}. {{ s.title }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}
                        <label class="form-label fw-bold">Your Story</label>
                        <div class="position-relative">
                            <textarea x-model="story" class="form-control" rows="12"
                                      placeholder="On March 15, 2024, I was walking down Main Street in Des Moines, Iowa when two officers approached me..."></textarea>
                            <button type="button" class="voice-btn position-absolute"
                                    style="bottom: 8px; right: 8px;"
                                    x-show="speechSupported"
                                    :class="{ 'recording': isRecording }"
                                    @click="toggleVoiceInput('story')"
                                    :title="isRecording ? 'Stop recording' : 'Speak your story'">
                                <i class="bi" :class="isRecording ? 'bi-mic-fill' : 'bi-mic'" style="font-size: 1.3rem;"></i>
                            </button>
                        </div>
                        <div class="form-text" x-show="speechSupported">
                            <i class="bi bi-mic me-1"></i>Click the microphone to dictate your story
                        </div>
                    </div>

                    <!-- Tips -->
                    <div class="card mb-3 border-info" x-show="!isProcessing">
                        <div class="card-header bg-info text-white py-2">
                            <h6 class="mb-0"><i class="bi bi-lightbulb me-2"></i>Tips for a Good Story</h6>
                        </div>
                        <div class="card-body py-2">
                            <ul class="mb-0 small">
                                <li class="mb-1"><strong>Be specific about dates and times</strong> - "August 8th at 1:15 PM" instead of "last week"</li>
                                <li class="mb-1"><strong>Name the people involved</strong> - Include officer names, badge numbers if you know them</li>
                                <li class="mb-1"><strong>Describe the location</strong> - Include the city, state, and specific address or intersection</li>
                                <li class="mb-1"><strong>Quote what was said</strong> - Include dialogue as accurately as you can remember</li>
                                <li class="mb-1"><strong>Describe physical actions</strong> - Did anyone push, grab, handcuff, or use a weapon?</li>
                                <li class="mb-1"><strong>Mention witnesses</strong> - Were there other people who saw what happened? Were they recording?</li>
                                <li><strong>Note any evidence</strong> - Video, photos, documents, medical records? Mention the device you used.</li>
                            </ul>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <a href="{% url 'documents:document_detail' document.slug %}" class="btn btn-outline-secondary me-2">
                                <i class="bi bi-arrow-left me-1"></i>Back to Document
                            </a>
                            <button x-show="hasSession" class="btn btn-outline-secondary" @click="currentView = 'steps'">
                                Cancel
                            </button>
                        </div>
                        <button class="btn btn-primary btn-lg" @click="submitStory()" :disabled="story.length < 50 || isProcessing">
                            <span x-show="!isProcessing && !hasSession">Analyze My Story <i class="bi bi-arrow-right ms-1"></i></span>
                            <span x-show="!isProcessing && hasSession">Re-Analyze Story <i class="bi bi-arrow-right ms-1"></i></span>
                            <span x-show="isProcessing"><span class="spinner-border spinner-border-sm me-1"></span>Analyzing...</span>
                        </button>
                    </div>

                    <!-- Terminal during processing -->
                    <div x-show="isProcessing" class="mt-4">
                        <div class="terminal-box" x-ref="terminal">
                            <template x-for="line in terminalLines" :key="line.id">
                                <div>
                                    <span class="text-muted">$</span> <span x-text="line.text"></span>
                                </div>
                            </template>
                            <div><span class="text-muted">$</span> <span class="terminal-cursor"></span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== STEP VIEWS ==================== -->
    <div x-show="currentView === 'steps'" class="row justify-content-center">
        <div class="col-lg-8">

            <!-- Edit Story Banner -->
            <div class="alert alert-light border d-flex align-items-center justify-content-between mb-3 py-2">
                <div>
                    <i class="bi bi-pencil-square me-1"></i>
                    <span class="small">AI extracted the details below from your story. Review and correct each step.</span>
                </div>
                <button class="btn btn-sm btn-outline-primary" @click="currentView = 'story'">
                    <i class="bi bi-arrow-left me-1"></i>Edit Story
                </button>
            </div>

            <!-- STEP 1: When & Where -->
            <div class="step-card" :class="{ 'active': currentStep === 1 }">
                <div class="card">
                    <div class="card-body p-4">
                        <h4 class="mb-1"><i class="bi bi-geo-alt me-2"></i>When & Where</h4>
                        <p class="text-muted mb-4">When and where did the incident happen?</p>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Date of Incident <span x-show="aiSuggested(1, 'incident_date')" class="ai-badge">AI suggested</span></label>
                                <input type="date" class="form-control" x-model="stepData[1].incident_date">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Time of Incident <span x-show="aiSuggested(1, 'incident_time')" class="ai-badge">AI suggested</span></label>
                                <input type="time" class="form-control" x-model="stepData[1].incident_time">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Location <span x-show="aiSuggested(1, 'incident_location')" class="ai-badge">AI suggested</span></label>
                                <div class="input-group">
                                    <input type="text" class="form-control" x-model="stepData[1].incident_location" placeholder="e.g., Corner of 5th and Main St">
                                    <button class="voice-btn btn btn-outline-secondary" type="button" x-show="speechSupported" @click="toggleVoiceInput('stepData[1].incident_location')"><i class="bi bi-mic"></i></button>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Address <small class="text-muted">(if known)</small></label>
                                <input type="text" class="form-control" x-model="stepData[1].address" placeholder="e.g., 123 Main St, Suite 200">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">City <span class="text-danger">*</span> <span x-show="aiSuggested(1, 'city')" class="ai-badge">AI suggested</span></label>
                                <input type="text" class="form-control" :class="{ 'is-invalid': step1CityError }" x-model="stepData[1].city" placeholder="City" @input="step1CityError = ''">
                                <div class="invalid-feedback" x-show="step1CityError" x-text="step1CityError"></div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">State <span class="text-danger">*</span> <span x-show="aiSuggested(1, 'state')" class="ai-badge">AI suggested</span></label>
                                <select class="form-select" :class="{ 'is-invalid': step1StateError }" x-model="stepData[1].state" @change="step1StateError = ''">
                                    {% for value, label in us_states %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback" x-show="step1StateError" x-text="step1StateError"></div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Location Type</label>
                                <select class="form-select" x-model="stepData[1].location_type">
                                    <option value="">Select...</option>
                                    <option value="sidewalk">Sidewalk / Public Street</option>
                                    <option value="public_easement">Public Easement</option>
                                    <option value="home">Home / Residence</option>
                                    <option value="vehicle">Vehicle</option>
                                    <option value="business">Business / Store</option>
                                    <option value="park">Public Park</option>
                                    <option value="police_station">Police Station</option>
                                    <option value="fire_station">Fire Station</option>
                                    <option value="courthouse">Courthouse</option>
                                    <option value="city_hall">City Hall</option>
                                    <option value="dmv">DMV Office</option>
                                    <option value="post_office">Post Office</option>
                                    <option value="public_library">Public Library</option>
                                    <option value="government_office">Other Government Office</option>
                                    <option value="dot_inspection">DOT Inspection Area</option>
                                    <option value="jail_prison">Jail / Prison</option>
                                    <option value="school">School / Campus</option>
                                    <option value="hospital">Hospital / Medical Facility</option>
                                    <option value="public_transit">Public Transit / Bus Stop</option>
                                    <option value="parking_lot">Parking Lot</option>
                                    <option value="highway">Highway / Interstate</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-6" x-show="stepData[1].location_type === 'other'" x-transition>
                                <label class="form-label">Describe Location</label>
                                <input type="text" class="form-control" x-model="stepData[1].location_type_other" placeholder="e.g., Private driveway, church parking lot">
                            </div>

                            <!-- Federal District Court -->
                            <div class="col-12">
                                <div class="wizard-court-box">
                                    <div class="box-header">
                                        <i class="bi bi-building"></i>
                                        <span>Federal District Court - Required</span>
                                    </div>
                                    <p class="small text-muted mb-3">
                                        <strong>Why is this important?</strong> Section 1983 cases must be filed in federal court.
                                        Filing in the wrong court can get your case dismissed. You must confirm the correct district.
                                    </p>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Federal District Court <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" :class="{ 'is-invalid': step1CourtError }"
                                            x-model="stepData[1].federal_district_court"
                                            :readonly="!stepData[1].use_manual_court"
                                            :placeholder="stepData[1].use_manual_court ? 'Enter federal district court name' : 'Enter city & state above â€” court will be looked up automatically'">
                                        <div class="text-danger small mt-1" x-show="step1CourtError" x-text="step1CourtError"></div>
                                        <div class="mt-2">
                                            <button class="btn btn-outline-primary" type="button" @click="lookupCourt(true)" :disabled="courtLookupLoading || !stepData[1].city || !stepData[1].state || stepData[1].use_manual_court">
                                                <span x-show="!courtLookupLoading"><i class="bi bi-search me-1"></i>Lookup Court</span>
                                                <span x-show="courtLookupLoading"><span class="spinner-border spinner-border-sm me-1"></span>Searching...</span>
                                            </button>
                                        </div>
                                        <small class="d-block mt-1" x-show="courtLookupConfidence" :class="{
                                            'text-success': courtLookupConfidence === 'high',
                                            'text-warning': courtLookupConfidence === 'medium',
                                            'text-danger': courtLookupConfidence === 'failed'
                                        }">
                                            <i class="bi me-1" :class="{
                                                'bi-check-circle': courtLookupConfidence === 'high',
                                                'bi-exclamation-circle': courtLookupConfidence === 'medium',
                                                'bi-x-circle': courtLookupConfidence === 'failed'
                                            }"></i>
                                            <span x-text="courtLookupMessage"></span>
                                        </small>
                                    </div>

                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="wizardManualCourt" x-model="stepData[1].use_manual_court">
                                        <label class="form-check-label" for="wizardManualCourt">
                                            I want to enter the court name manually
                                        </label>
                                        <div class="form-text">Check this if the automatic lookup is incorrect or you already know your court.</div>
                                    </div>

                                    <div class="wizard-court-confirmation" :class="{ 'confirmed': stepData[1].court_district_confirmed }">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="wizardCourtConfirm" x-model="stepData[1].court_district_confirmed">
                                            <label class="form-check-label" for="wizardCourtConfirm">
                                                <i class="bi bi-exclamation-triangle-fill me-1"></i>
                                                I confirm this is the correct federal district court for my case
                                            </label>
                                        </div>
                                        <div class="form-text mt-2">
                                            <strong>You must check this box to continue.</strong> By checking, you confirm you have verified the court district is correct for where your incident occurred.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STEP 2: Who Was Involved -->
            <div class="step-card" :class="{ 'active': currentStep === 2 }">
                <div class="card">
                    <div class="card-body p-4">
                        <h4 class="mb-1"><i class="bi bi-people me-2"></i>Who Was Involved</h4>
                        <p class="text-muted mb-4">Who were the officers or officials involved?</p>

                        <h6 class="mb-3">Government Defendants</h6>
                        <template x-for="(defendant, i) in stepData[2].defendants" :key="'d'+i">
                            <div class="card mb-3 bg-light">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="fw-bold" x-text="'Defendant ' + (i + 1)"></span>
                                        <button class="btn btn-sm btn-outline-danger" @click="stepData[2].defendants.splice(i, 1)" x-show="stepData[2].defendants.length > 1"><i class="bi bi-trash"></i></button>
                                    </div>
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <input type="text" class="form-control form-control-sm" x-model="defendant.name" placeholder="Name">
                                        </div>
                                        <div class="col-md-6">
                                            <input type="text" class="form-control form-control-sm" x-model="defendant.agency_name" placeholder="Agency">
                                        </div>
                                        <div class="col-md-4">
                                            <input type="text" class="form-control form-control-sm" x-model="defendant.badge_number" placeholder="Badge #">
                                        </div>
                                        <div class="col-md-4">
                                            <input type="text" class="form-control form-control-sm" x-model="defendant.title_rank" placeholder="Title/Rank">
                                        </div>
                                        <div class="col-md-4">
                                            <select class="form-select form-select-sm" x-model="defendant.defendant_type">
                                                <option value="individual">Individual Officer</option>
                                                <option value="agency">Government Agency</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <button class="btn btn-outline-primary btn-sm mb-4" @click="stepData[2].defendants.push({name:'', badge_number:'', title_rank:'', agency_name:'', defendant_type:'individual', description:''})">
                            <i class="bi bi-plus-circle me-1"></i>Add Defendant
                        </button>

                        <h6 class="mb-3">Witnesses</h6>
                        <template x-for="(witness, i) in stepData[2].witnesses" :key="'w'+i">
                            <div class="card mb-3 bg-light">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="fw-bold" x-text="'Witness ' + (i + 1)"></span>
                                        <button class="btn btn-sm btn-outline-danger" @click="stepData[2].witnesses.splice(i, 1)"><i class="bi bi-trash"></i></button>
                                    </div>
                                    <div class="row g-2">
                                        <div class="col-md-6"><input type="text" class="form-control form-control-sm" x-model="witness.name" placeholder="Name"></div>
                                        <div class="col-md-6"><input type="text" class="form-control form-control-sm" x-model="witness.relationship" placeholder="Relationship (bystander, etc.)"></div>
                                        <div class="col-12"><textarea class="form-control form-control-sm" x-model="witness.what_they_witnessed" placeholder="What did they see?" rows="2"></textarea></div>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <button class="btn btn-outline-primary btn-sm" @click="stepData[2].witnesses.push({name:'', relationship:'', what_they_witnessed:'', contact_info:''})">
                            <i class="bi bi-plus-circle me-1"></i>Add Witness
                        </button>
                    </div>
                </div>
            </div>

            <!-- STEP 3: What Happened -->
            <div class="step-card" :class="{ 'active': currentStep === 3 }">
                <div class="card">
                    <div class="card-body p-4">
                        <h4 class="mb-1"><i class="bi bi-journal-text me-2"></i>What Happened</h4>
                        <p class="text-muted mb-4">Walk us through the incident step by step.</p>

                        <div class="mb-3">
                            <label class="form-label">What were you doing before the incident? <span x-show="aiSuggested(3, 'what_were_you_doing')" class="ai-badge">AI suggested</span></label>
                            <textarea class="form-control" x-model="stepData[3].what_were_you_doing" rows="2" placeholder="I was walking home from the store..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">How did the initial contact happen? <span x-show="aiSuggested(3, 'initial_contact')" class="ai-badge">AI suggested</span></label>
                            <textarea class="form-control" x-model="stepData[3].initial_contact" rows="2" placeholder="Two officers approached me and..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">What was said? <span x-show="aiSuggested(3, 'what_was_said')" class="ai-badge">AI suggested</span></label>
                            <textarea class="form-control" x-model="stepData[3].what_was_said" rows="3" placeholder="The officer said... I responded..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">What physical actions were taken? <span x-show="aiSuggested(3, 'physical_actions')" class="ai-badge">AI suggested</span></label>
                            <textarea class="form-control" x-model="stepData[3].physical_actions" rows="3" placeholder="The officer grabbed my arm..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">How did it end? <span x-show="aiSuggested(3, 'how_it_ended')" class="ai-badge">AI suggested</span></label>
                            <textarea class="form-control" x-model="stepData[3].how_it_ended" rows="2" placeholder="Eventually they let me go..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Full detailed narrative <span x-show="aiSuggested(3, 'detailed_narrative')" class="ai-badge">AI suggested</span></label>
                            <textarea class="form-control" x-model="stepData[3].detailed_narrative" rows="5" placeholder="Complete narrative of the incident (can be edited from AI suggestion)..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STEP 4: Why It Was Wrong -->
            <div class="step-card" :class="{ 'active': currentStep === 4 }">
                <div class="card">
                    <div class="card-body p-4">
                        <h4 class="mb-1"><i class="bi bi-shield-exclamation me-2"></i>Why Was It Wrong</h4>
                        <p class="text-muted mb-4">Select the situations that apply to what happened to you. You can select multiple.</p>

                        <div class="row g-3">
                            <template x-for="violation in violationOptions" :key="violation.key">
                                <div class="col-md-6">
                                    <div class="violation-card"
                                         :class="{ 'selected': stepData[4].selections.includes(violation.key) }"
                                         @click="toggleViolation(violation.key)">
                                        <div class="d-flex align-items-start">
                                            <i class="bi me-2 mt-1" :class="stepData[4].selections.includes(violation.key) ? 'bi-check-square-fill text-primary' : 'bi-square'" style="font-size:1.2rem;"></i>
                                            <div>
                                                <div class="fw-bold" x-text="violation.label"></div>
                                                <small class="text-muted" x-text="violation.description"></small>
                                                <div><span class="badge bg-secondary mt-1" x-text="violation.amendment"></span></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <div class="mt-4">
                            <label class="form-label">Anything else you believe was wrong?</label>
                            <textarea class="form-control" x-model="stepData[4].additional_text" rows="3" placeholder="Describe any other rights you believe were violated..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STEP 5: How It Affected You -->
            <div class="step-card" :class="{ 'active': currentStep === 5 }">
                <div class="card">
                    <div class="card-body p-4">
                        <h4 class="mb-1"><i class="bi bi-heart-pulse me-2"></i>How It Affected You</h4>
                        <p class="text-muted mb-4">Describe the harm or damages you experienced.</p>

                        <div class="mb-3">
                            <label class="form-label">Physical Injuries <span x-show="aiSuggested(5, 'physical_injuries')" class="ai-badge">AI suggested</span></label>
                            <textarea class="form-control" x-model="stepData[5].physical_injuries" rows="2" placeholder="Bruises, cuts, broken bones, etc."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Medical Treatment</label>
                            <textarea class="form-control" x-model="stepData[5].medical_treatment" rows="2" placeholder="ER visit, surgery, ongoing treatment..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Emotional / Psychological Impact <span x-show="aiSuggested(5, 'emotional_distress')" class="ai-badge">AI suggested</span></label>
                            <textarea class="form-control" x-model="stepData[5].emotional_distress" rows="2" placeholder="Anxiety, PTSD, fear, depression..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Financial Losses <span x-show="aiSuggested(5, 'financial_losses')" class="ai-badge">AI suggested</span></label>
                            <textarea class="form-control" x-model="stepData[5].financial_losses" rows="2" placeholder="Medical bills, legal fees, property damage..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Lost Wages</label>
                            <textarea class="form-control" x-model="stepData[5].lost_wages" rows="2" placeholder="Time off work, lost job..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ongoing Effects</label>
                            <textarea class="form-control" x-model="stepData[5].ongoing_effects" rows="2" placeholder="Continuing pain, recurring nightmares, inability to trust police..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STEP 6: Evidence -->
            <div class="step-card" :class="{ 'active': currentStep === 6 }">
                <div class="card">
                    <div class="card-body p-4">
                        <h4 class="mb-1"><i class="bi bi-camera me-2"></i>Evidence & Proof</h4>
                        <p class="text-muted mb-4">What evidence do you have to support your case?</p>

                        <h6 class="mb-3">Types of Evidence Available</h6>
                        <div class="row g-2 mb-4">
                            <template x-for="type in evidenceTypes" :key="type.key">
                                <div class="col-6 col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" :id="'ev_'+type.key"
                                               :checked="stepData[6].evidence_types.includes(type.key)"
                                               @change="toggleEvidenceType(type.key)">
                                        <label class="form-check-label" :for="'ev_'+type.key">
                                            <i class="bi me-1" :class="type.icon"></i><span x-text="type.label"></span>
                                        </label>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <h6 class="mb-3">Evidence Items</h6>
                        <template x-for="(item, i) in stepData[6].items" :key="'e'+i">
                            <div class="card mb-2 bg-light">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="fw-bold" x-text="'Item ' + (i+1)"></span>
                                        <button class="btn btn-sm btn-outline-danger" @click="stepData[6].items.splice(i,1)"><i class="bi bi-trash"></i></button>
                                    </div>
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <select class="form-select form-select-sm" x-model="item.evidence_type">
                                                <option value="">Type...</option>
                                                <option value="video">Video</option>
                                                <option value="photo">Photo</option>
                                                <option value="audio">Audio</option>
                                                <option value="document">Document</option>
                                                <option value="body_cam">Body Cam</option>
                                                <option value="dash_cam">Dash Cam</option>
                                                <option value="medical_records">Medical Records</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </div>
                                        <div class="col-md-8"><input type="text" class="form-control form-control-sm" x-model="item.title" placeholder="Title / Description"></div>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <button class="btn btn-outline-primary btn-sm" @click="stepData[6].items.push({evidence_type:'', title:'', description:'', is_in_possession:true})">
                            <i class="bi bi-plus-circle me-1"></i>Add Evidence Item
                        </button>

                        <div class="mt-4">
                            <label class="form-label">YouTube Video URL (optional)</label>
                            <input type="url" class="form-control" x-model="stepData[6].youtube_url" placeholder="https://youtube.com/watch?v=...">
                            <div class="form-text">If you have video evidence on YouTube, you can analyze it after completing the wizard.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STEP 7: Preferences -->
            <div class="step-card" :class="{ 'active': currentStep === 7 }">
                <div class="card">
                    <div class="card-body p-4">
                        <h4 class="mb-1"><i class="bi bi-gear me-2"></i>Preferences</h4>
                        <p class="text-muted mb-4">Choose how you want your complaint prepared.</p>

                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="caseLawToggle" x-model="stepData[7].use_case_law" style="transform: scale(1.3);">
                                    <label class="form-check-label fw-bold ms-2" for="caseLawToggle">
                                        Include relevant case law
                                    </label>
                                </div>
                                <p class="text-muted mt-2 mb-0">
                                    Case law references show the court that similar situations have been ruled in favor of plaintiffs.
                                    This can strengthen your complaint but is not required.
                                </p>
                                <div class="alert alert-info mt-3 mb-0" x-show="stepData[7].use_case_law">
                                    <i class="bi bi-info-circle me-1"></i>
                                    AI will suggest relevant precedent cases. A legal professional should verify all citations before filing.
                                </div>
                            </div>
                        </div>

                        <div class="card bg-light">
                            <div class="card-body">
                                <h6><i class="bi bi-check-circle me-2 text-success"></i>Ready to Analyze</h6>
                                <p class="mb-0 text-muted">Click "Analyze My Case" below to get AI's assessment of your potential violations, recommended case law, and a preview of your complaint.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="d-flex justify-content-between mt-4" x-show="currentView === 'steps'">
                <button class="btn btn-outline-secondary" @click="prevStep()">
                    <i class="bi bi-arrow-left me-1"></i><span x-text="currentStep === 1 ? 'Back to Story' : 'Previous'"></span>
                </button>
                <div>
                    <button class="btn btn-outline-secondary me-2" @click="saveCurrentStep()" :disabled="isSaving">
                        <span x-show="!isSaving"><i class="bi bi-save me-1"></i>Save</span>
                        <span x-show="isSaving"><span class="spinner-border spinner-border-sm"></span></span>
                    </button>
                    <template x-if="currentStep < 7">
                        <button class="btn btn-primary" @click="nextStep()">
                            Next <i class="bi bi-arrow-right ms-1"></i>
                        </button>
                    </template>
                    <template x-if="currentStep === 7">
                        <button class="btn btn-success btn-lg" @click="analyzeCase()" :disabled="isAnalyzing">
                            <span x-show="!isAnalyzing"><i class="bi bi-lightning me-1"></i>Analyze My Case</span>
                            <span x-show="isAnalyzing"><span class="spinner-border spinner-border-sm me-1"></span>Analyzing...</span>
                        </button>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== ANALYSIS VIEW ==================== -->
    <div x-show="currentView === 'analysis'" class="row justify-content-center">
        <div class="col-lg-10">

            <!-- Processing animation -->
            <div x-show="isAnalyzing" class="text-center py-5">
                <div class="terminal-box mx-auto" style="max-width:500px; text-align:left;">
                    <template x-for="line in terminalLines" :key="line.id">
                        <div><span class="text-muted">$</span> <span x-text="line.text"></span></div>
                    </template>
                    <div><span class="text-muted">$</span> <span class="terminal-cursor"></span></div>
                </div>
                <p class="text-muted mt-3">Analyzing your case details...</p>
            </div>

            <!-- Analysis Results -->
            <div x-show="!isAnalyzing && analysisData.violations">

                <h3 class="mb-4"><i class="bi bi-lightning me-2"></i>Case Analysis</h3>

                <div class="alert alert-info mb-4">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Select what to include.</strong> Toggle items on or off to control what goes into your complaint.
                    Items marked <span class="strength-badge strong">strong</span> and <span class="strength-badge moderate">moderate</span> are included by default.
                </div>

                <!-- Potential Violations -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Potential Violations</h5>
                    <small class="text-muted" x-text="(analysisData.violations || []).filter(v => v.included !== false).length + ' of ' + (analysisData.violations || []).length + ' included'"></small>
                </div>
                <template x-for="(violation, i) in analysisData.violations || []" :key="'v'+i">
                    <div class="analysis-card" :class="[violation.strength, violation.included === false ? 'excluded' : '']">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="d-flex align-items-start flex-grow-1">
                                <div class="form-check form-switch include-toggle me-3 mt-1">
                                    <input class="form-check-input" type="checkbox" role="switch"
                                           :id="'v_toggle_' + i"
                                           :checked="violation.included !== false"
                                           @change="violation.included = $event.target.checked; saveAnalysisSelections()">
                                </div>
                                <div>
                                    <span class="fw-bold include-label" x-text="violation.amendment"></span>
                                    <span class="ms-2 text-muted include-label" x-text="violation.violation_type"></span>
                                </div>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <a href="#" class="research-link text-primary"
                                   @click.prevent="showViolationExplanation(violation)"
                                   title="Learn more about this violation">
                                    <i class="bi bi-question-circle"></i> Learn more
                                </a>
                                <span class="strength-badge" :class="violation.strength" x-text="(violation.strength || '').replace('_', ' ')"></span>
                            </div>
                        </div>
                        <p class="mb-0" x-text="violation.description"></p>
                    </div>
                </template>

                <!-- Case Law -->
                <template x-if="analysisData.case_law && analysisData.case_law.length > 0">
                    <div class="mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0"><i class="bi bi-book me-2"></i>Supporting Case Law</h5>
                            <small class="text-muted" x-text="(analysisData.case_law || []).filter(c => c.included !== false).length + ' of ' + (analysisData.case_law || []).length + ' included'"></small>
                        </div>
                        <template x-for="(caseRef, i) in analysisData.case_law" :key="'c'+i">
                            <div class="card mb-2 case-law-card" :class="caseRef.included === false ? 'excluded' : ''">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-start">
                                        <div class="form-check form-switch include-toggle me-3 mt-1">
                                            <input class="form-check-input" type="checkbox" role="switch"
                                                   :id="'c_toggle_' + i"
                                                   :checked="caseRef.included !== false"
                                                   @change="caseRef.included = $event.target.checked; saveAnalysisSelections()">
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="fw-bold include-label" x-text="caseRef.case_name"></div>
                                                <a :href="'https://scholar.google.com/scholar?q=' + encodeURIComponent('&quot;' + (caseRef.case_name || '') + '&quot;')"
                                                   target="_blank" rel="noopener noreferrer"
                                                   class="research-link text-primary ms-2 text-nowrap"
                                                   @click.stop
                                                   title="Research this case on Google Scholar">
                                                    <i class="bi bi-box-arrow-up-right"></i> Research
                                                </a>
                                            </div>
                                            <p class="mb-1 text-muted" x-text="caseRef.relevance"></p>
                                            <small class="text-muted fst-italic" x-text="caseRef.key_holding"></small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <div class="alert alert-warning mt-2">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            AI-suggested citations. A legal professional should verify these before filing.
                        </div>
                    </div>
                </template>

                <!-- Action Buttons -->
                <div class="d-flex justify-content-between mt-4 mb-5">
                    <button class="btn btn-outline-secondary" @click="currentView = 'steps'; currentStep = 1;">
                        <i class="bi bi-pencil me-1"></i>Edit My Answers
                    </button>
                    <button class="btn btn-success btn-lg" @click="completeWizard()" :disabled="isCompleting">
                        <span x-show="!isCompleting"><i class="bi bi-check-circle me-1"></i>Build My Complaint</span>
                        <span x-show="isCompleting"><span class="spinner-border spinner-border-sm me-1"></span>Building...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Violation Explanation Modal -->
    <div x-show="showingViolationModal" x-transition class="violation-modal-overlay" @click.self="showingViolationModal = false" style="display: none;">
        <div class="violation-modal-content">
            <button class="close-btn" @click="showingViolationModal = false"><i class="bi bi-x-lg"></i></button>
            <h4 class="mb-1" x-text="violationModalData.title"></h4>
            <span class="badge bg-secondary mb-3" x-text="violationModalData.amendment"></span>
            <div class="mb-3">
                <h6>What This Means</h6>
                <p x-text="violationModalData.explanation"></p>
            </div>
            <div class="mb-3">
                <h6>Elements to Prove</h6>
                <ul>
                    <template x-for="(element, i) in violationModalData.elements || []" :key="'el'+i">
                        <li x-text="element"></li>
                    </template>
                </ul>
            </div>
            <div class="mb-3">
                <h6>Why It Matters in a Section 1983 Case</h6>
                <p x-text="violationModalData.significance"></p>
            </div>
            <div class="text-end">
                <button class="btn btn-outline-secondary" @click="showingViolationModal = false">Close</button>
            </div>
        </div>
    </div>

</div>

{% if test_stories %}
{{ test_stories|json_script:"test-stories-data" }}
{% endif %}

<!-- Alpine.js -->
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.3/dist/cdn.min.js" defer></script>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function wizardApp() {
    // Build test stories lookup (id â†’ story text) from JSON script tag
    const _testStories = {};
    {% if test_stories %}
    try {
        const _raw = JSON.parse(document.getElementById('test-stories-data').textContent);
        _raw.forEach(s => { _testStories[s.id] = s.story; });
    } catch(e) {}
    {% endif %}

    return {
        // State
        testStories: _testStories,
        documentSlug: '{{ document.slug }}',
        sessionSlug: '{{ session_slug }}',
        hasSession: {{ has_session|yesno:"true,false" }},
        currentView: new URLSearchParams(window.location.search).get('view') === 'story' ? 'story' : ('{{ wizard_status }}' === 'not_started' || !'{{ session_slug }}' ? 'story' : ('{{ wizard_status }}' === 'analyzed' ? 'analysis' : 'steps')),
        currentStep: {{ current_step }},
        story: '{{ document.story_text|escapejs }}',
        isProcessing: false,
        isSaving: false,
        isAnalyzing: false,
        isCompleting: false,
        isRecording: false,
        speechSupported: false,
        terminalLines: [],
        terminalInterval: null,
        showingViolationModal: false,
        violationModalData: {},

        // Court lookup state
        courtLookupLoading: false,
        courtLookupConfidence: '',
        courtLookupMessage: '',
        _lastCourtLookupKey: '',
        step1CityError: '',
        step1StateError: '',
        step1CourtError: '',

        // AI data
        aiExtracted: JSON.parse('{{ ai_extracted|escapejs }}'),
        analysisData: JSON.parse('{{ ai_analysis|escapejs }}'),

        // Step data (user-confirmed)
        stepData: {
            1: { incident_date: '', incident_time: '', incident_location: '', address: '', city: '', state: '', location_type: '', location_type_other: '', was_recording: null, recording_device: '', federal_district_court: '', use_manual_court: false, court_district_confirmed: false },
            2: { defendants: [{ name: '', badge_number: '', title_rank: '', agency_name: '', defendant_type: 'individual', description: '' }], witnesses: [] },
            3: { summary: '', detailed_narrative: '', what_were_you_doing: '', initial_contact: '', what_was_said: '', physical_actions: '', how_it_ended: '' },
            4: { selections: [], additional_text: '', ai_violations: [] },
            5: { physical_injuries: '', medical_treatment: '', emotional_distress: '', financial_losses: '', lost_wages: '', ongoing_effects: '' },
            6: { evidence_types: [], items: [], youtube_url: '' },
            7: { use_case_law: true },
        },

        steps: [
            { title: 'When & Where' },
            { title: 'Who' },
            { title: 'What' },
            { title: 'Why' },
            { title: 'Impact' },
            { title: 'Evidence' },
            { title: 'Options' },
        ],

        violationOptions: [
            { key: 'searched_without_warrant', label: 'Searched without a warrant', description: 'Officers searched you, your vehicle, or your property without a warrant or consent.', amendment: 'Fourth Amendment' },
            { key: 'arrested_no_cause', label: 'Arrested without probable cause', description: 'You were arrested or detained without a valid legal reason.', amendment: 'Fourth Amendment' },
            { key: 'excessive_force', label: 'Excessive force', description: 'Officers used more physical force than was necessary.', amendment: 'Fourth Amendment' },
            { key: 'punished_for_speech', label: 'Punished for speaking out', description: 'You were retaliated against for what you said or expressed.', amendment: 'First Amendment' },
            { key: 'punished_for_recording', label: 'Punished for recording', description: 'You were stopped or punished for recording police activity.', amendment: 'First Amendment' },
            { key: 'racial_discrimination', label: 'Racial discrimination', description: 'You were treated differently because of your race or ethnicity.', amendment: 'Fourteenth Amendment' },
            { key: 'gender_discrimination', label: 'Gender discrimination', description: 'You were treated differently because of your gender.', amendment: 'Fourteenth Amendment' },
            { key: 'forced_statements', label: 'Forced to make statements', description: 'You were coerced into making self-incriminating statements.', amendment: 'Fifth Amendment' },
            { key: 'denied_medical_care', label: 'Denied medical care', description: 'Officers refused to get you medical attention when you needed it.', amendment: 'Fourteenth Amendment' },
            { key: 'denied_due_process', label: 'Denied due process', description: 'Your case was handled without proper legal procedures.', amendment: 'Fourteenth Amendment' },
            { key: 'retaliation', label: 'Retaliation for complaint', description: 'Officers retaliated against you for filing a complaint or exercising rights.', amendment: 'First Amendment' },
        ],

        evidenceTypes: [
            { key: 'video', label: 'Video', icon: 'bi-camera-video' },
            { key: 'photo', label: 'Photos', icon: 'bi-image' },
            { key: 'audio', label: 'Audio', icon: 'bi-mic' },
            { key: 'body_cam', label: 'Body Camera', icon: 'bi-person-badge' },
            { key: 'dash_cam', label: 'Dash Camera', icon: 'bi-car-front' },
            { key: 'medical_records', label: 'Medical Records', icon: 'bi-hospital' },
            { key: 'police_report', label: 'Police Report', icon: 'bi-file-earmark' },
            { key: 'witness_statements', label: 'Witness Statements', icon: 'bi-chat-quote' },
            { key: 'social_media', label: 'Social Media', icon: 'bi-phone' },
        ],

        init() {
            this.speechSupported = 'SpeechRecognition' in window || 'webkitSpeechRecognition' in window;

            // If we have a session, load interview data into stepData
            if (this.hasSession) {
                const saved = JSON.parse('{{ interview_data|escapejs }}');
                for (let i = 1; i <= 7; i++) {
                    const key = 'step_' + i;
                    if (saved[key]) {
                        this.stepData[i] = { ...this.stepData[i], ...saved[key] };
                    }
                }
                // Pre-fill from AI extraction if step data is empty
                this.prefillFromAI();
            }

            // Auto-lookup court when city or state changes
            this.$watch('stepData[1].city', () => {
                if (this.stepData[1].city && this.stepData[1].state && !this.stepData[1].federal_district_court) {
                    this.lookupCourt();
                }
            });
            this.$watch('stepData[1].state', () => {
                if (this.stepData[1].city && this.stepData[1].state && !this.stepData[1].federal_district_court) {
                    this.lookupCourt();
                }
            });

            // Auto-lookup court on page load if city/state filled but court empty
            if (this.stepData[1].city && this.stepData[1].state && !this.stepData[1].federal_district_court) {
                this.lookupCourt();
            }

            // If analysis is done, show analysis view
            if ('{{ analysis_status }}' === 'completed' && this.analysisData.violations) {
                this.initAnalysisDefaults();
                this.currentView = 'analysis';
            }
        },

        prefillFromAI() {
            const ai = this.aiExtracted;
            for (let i = 1; i <= 7; i++) {
                const key = 'step_' + i;
                if (ai[key]) {
                    for (const [field, value] of Object.entries(ai[key])) {
                        // Skip null/undefined but allow false and empty arrays
                        if (value === null || value === undefined) continue;
                        // Skip if field doesn't exist in stepData
                        if (!(field in this.stepData[i])) continue;

                        const current = this.stepData[i][field];

                        if (Array.isArray(value) && Array.isArray(current)) {
                            // Only overwrite arrays if current is empty or has a single blank entry
                            if (current.length === 0 ||
                                (current.length === 1 && !current[0].name)) {
                                this.stepData[i][field] = value;
                            }
                        } else if (typeof value === 'boolean') {
                            // Always set booleans (was_recording: true/false)
                            if (current === null || current === undefined) {
                                this.stepData[i][field] = value;
                            }
                        } else if (typeof value === 'string' && value) {
                            // Only set strings if current is empty
                            if (!current) {
                                this.stepData[i][field] = value;
                            }
                        }
                    }
                }
            }
            // Ensure at least one defendant exists
            if (!this.stepData[2].defendants || this.stepData[2].defendants.length === 0) {
                this.stepData[2].defendants = [{ name: '', badge_number: '', title_rank: '', agency_name: '', defendant_type: 'individual', description: '' }];
            }
        },

        aiSuggested(step, field) {
            const ai = this.aiExtracted['step_' + step];
            return ai && ai[field] && this.stepData[step][field] === ai[field];
        },

        stepCompleted(n) {
            const data = this.stepData[n];
            if (!data) return false;
            switch(n) {
                case 1: return !!(data.incident_date || data.city);
                case 2: return data.defendants && data.defendants.some(d => d.name);
                case 3: return !!(data.detailed_narrative || data.what_were_you_doing);
                case 4: return data.selections && data.selections.length > 0;
                case 5: return !!(data.physical_injuries || data.emotional_distress || data.financial_losses);
                case 6: return data.evidence_types && data.evidence_types.length > 0;
                case 7: return true; // Always "complete" since it's just a preference
                default: return false;
            }
        },

        goToStep(n) {
            if (this.currentView === 'story') return;
            if (this.currentStep === 1 && n !== 1 && !this.validateStep1()) {
                return;
            }
            this.saveCurrentStep(true);
            this.currentStep = n;
        },

        validateStep1() {
            let valid = true;
            this.step1CityError = '';
            this.step1StateError = '';
            this.step1CourtError = '';

            if (!this.stepData[1].city || !this.stepData[1].city.trim()) {
                this.step1CityError = 'City is required.';
                valid = false;
            }
            if (!this.stepData[1].state) {
                this.step1StateError = 'State is required.';
                valid = false;
            }
            if (!this.stepData[1].federal_district_court || !this.stepData[1].federal_district_court.trim()) {
                this.step1CourtError = 'Federal district court is required. Use the Lookup button or enter manually.';
                valid = false;
            }
            if (this.stepData[1].federal_district_court && !this.stepData[1].court_district_confirmed) {
                this.step1CourtError = 'Please confirm the federal district court is correct.';
                valid = false;
            }
            return valid;
        },

        async lookupCourt(force = false) {
            const city = (this.stepData[1].city || '').trim();
            const state = (this.stepData[1].state || '').trim();

            // Clear errors on input change
            if (city) this.step1CityError = '';
            if (state) this.step1StateError = '';

            if (!city || !state) return;
            if (this.stepData[1].use_manual_court) return;
            if (this.courtLookupLoading) return;

            // Skip if we already looked up this exact city+state (unless forced)
            const lookupKey = city.toLowerCase() + '|' + state.toUpperCase();
            if (!force && this._lastCourtLookupKey === lookupKey) return;
            this._lastCourtLookupKey = lookupKey;

            this.courtLookupLoading = true;
            this.courtLookupConfidence = '';
            this.courtLookupMessage = '';

            try {
                const response = await fetch('/documents/lookup-district-court/?city=' + encodeURIComponent(city) + '&state=' + encodeURIComponent(state));
                const data = await response.json();

                if (data.success && data.court_name) {
                    this.stepData[1].federal_district_court = data.court_name;
                    this.courtLookupConfidence = data.confidence || 'medium';
                    const methodNote = data.method === 'gpt_web_search' ? ' (via web search)' : '';
                    this.courtLookupMessage = (data.confidence === 'high' ? 'High confidence match' : 'Best match found') + methodNote;
                    this.step1CourtError = '';
                } else {
                    this.courtLookupConfidence = 'failed';
                    this.courtLookupMessage = 'Could not determine court. Try a nearby city or enter manually.';
                }
            } catch (err) {
                console.error('Court lookup error:', err);
                this.courtLookupConfidence = 'failed';
                this.courtLookupMessage = 'Lookup failed. Please enter court manually.';
            } finally {
                this.courtLookupLoading = false;
            }
        },

        nextStep() {
            if (this.currentStep === 1 && !this.validateStep1()) {
                return;
            }
            this.saveCurrentStep(true);
            if (this.currentStep < 7) this.currentStep++;
        },

        prevStep() {
            if (this.currentStep === 1) {
                this.currentView = 'story';
            } else {
                this.saveCurrentStep(true);
                this.currentStep--;
            }
        },

        toggleViolation(key) {
            const idx = this.stepData[4].selections.indexOf(key);
            if (idx >= 0) this.stepData[4].selections.splice(idx, 1);
            else this.stepData[4].selections.push(key);
        },

        toggleEvidenceType(key) {
            const idx = this.stepData[6].evidence_types.indexOf(key);
            if (idx >= 0) this.stepData[6].evidence_types.splice(idx, 1);
            else this.stepData[6].evidence_types.push(key);
        },

        // Terminal animation
        startTerminal(commands) {
            this.terminalLines = [];
            let idx = 0;
            let phase = 0;

            // Additional lines to cycle through after initial commands
            const processingLines = [
                'scanning narrative for temporal markers...',
                'cross-referencing agency databases...',
                'mapping incident to federal jurisdiction...',
                'analyzing use-of-force indicators...',
                'extracting witness identifiers...',
                'parsing dialogue and quoted statements...',
                'evaluating Fourth Amendment implications...',
                'checking First Amendment protections...',
                'identifying evidence preservation needs...',
                'reviewing Fourteenth Amendment factors...',
                'computing damages assessment...',
                'correlating defendant actions to violations...',
                'building chronological incident timeline...',
                'validating extracted entity relationships...',
                'preparing structured case data...',
                'finalizing extraction results...',
            ];

            this.terminalInterval = setInterval(() => {
                let line;
                if (idx < commands.length) {
                    // Phase 1: Show initial commands
                    line = commands[idx];
                } else {
                    // Phase 2: Cycle through processing lines
                    const pIdx = (idx - commands.length) % processingLines.length;
                    line = processingLines[pIdx];
                }
                this.terminalLines.push({ id: idx, text: line });
                idx++;

                // Keep max 15 lines visible to avoid growing forever
                if (this.terminalLines.length > 15) {
                    this.terminalLines.shift();
                }

                // Auto-scroll
                this.$nextTick(() => {
                    const el = this.$refs.terminal;
                    if (el) el.scrollTop = el.scrollHeight;
                });
            }, 1200);
        },

        stopTerminal() {
            if (this.terminalInterval) {
                clearInterval(this.terminalInterval);
                this.terminalInterval = null;
            }
        },

        // API calls
        async submitStory() {
            if (this.story.length < 50) return;
            this.isProcessing = true;

            this.startTerminal([
                'parse-narrative --input=story.txt',
                'extract-entities --type=persons,locations,dates',
                'identify-defendants --source=narrative',
                'classify-violations --usc=42-1983',
                'analyze-damages --categories=physical,emotional,financial',
                'lookup-witnesses --from=narrative',
                'map-evidence --types=video,document,photo',
                'compute-timeline --sort=chronological',
                'validate-jurisdiction --federal-court',
                'generate-suggestions --confidence=high',
            ]);

            try {
                const response = await fetch(`/api/v1/wizard/${this.documentSlug}/start/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({ story: this.story }),
                });

                const data = await response.json();
                if (data.session_slug) {
                    this.sessionSlug = data.session_slug;
                    this.hasSession = true;
                    this.pollForExtraction();
                }
            } catch (err) {
                this.stopTerminal();
                this.isProcessing = false;
                alert('Error submitting story. Please try again.');
            }
        },

        async pollForExtraction() {
            const poll = async () => {
                try {
                    const response = await fetch(`/api/v1/wizard/${this.sessionSlug}/status/`, {
                        headers: { 'X-CSRFToken': getCookie('csrftoken') },
                    });
                    const data = await response.json();

                    if (data.ai_extracted && Object.keys(data.ai_extracted).length > 0) {
                        this.stopTerminal();
                        this.isProcessing = false;
                        this.aiExtracted = data.ai_extracted;
                        this.prefillFromAI();
                        this.currentView = 'steps';
                        this.currentStep = 1;
                        return;
                    }

                    // Keep polling
                    setTimeout(poll, 3000);
                } catch (err) {
                    setTimeout(poll, 3000);
                }
            };
            poll();
        },

        async saveCurrentStep(silent = false) {
            if (!this.sessionSlug) return;
            if (!silent) this.isSaving = true;

            try {
                await fetch(`/api/v1/wizard/${this.sessionSlug}/step/${this.currentStep}/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify(this.stepData[this.currentStep]),
                });
            } catch (err) {
                console.error('Error saving step:', err);
            }

            if (!silent) {
                this.isSaving = false;
            }
        },

        async analyzeCase() {
            // Save current step first
            await this.saveCurrentStep(true);

            this.isAnalyzing = true;
            this.currentView = 'analysis';

            this.startTerminal([
                'compile-case-data --all-steps',
                'analyze-constitutional-violations --depth=full',
                'assess-violation-strength --scale=3',
                this.stepData[7].use_case_law ? 'search-case-law --database=scotus,circuit' : 'skip-case-law --user-preference',
                'evaluate-damages --comprehensive',
                'draft-complaint-preview --format=section1983',
                'recommend-relief --based-on=violations,damages',
                'finalize-analysis --output=json',
            ]);

            try {
                const response = await fetch(`/api/v1/wizard/${this.sessionSlug}/analyze/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                });

                if (response.ok) {
                    this.pollForAnalysis();
                } else {
                    const data = await response.json();
                    this.stopTerminal();
                    this.isAnalyzing = false;
                    alert(data.error || 'Error starting analysis.');
                }
            } catch (err) {
                this.stopTerminal();
                this.isAnalyzing = false;
                alert('Error starting analysis. Please try again.');
            }
        },

        async pollForAnalysis() {
            const poll = async () => {
                try {
                    const response = await fetch(`/api/v1/wizard/${this.sessionSlug}/analysis/`, {
                        headers: { 'X-CSRFToken': getCookie('csrftoken') },
                    });
                    const data = await response.json();

                    if (data.status === 'completed') {
                        this.stopTerminal();
                        this.isAnalyzing = false;
                        this.analysisData = data.analysis;
                        this.initAnalysisDefaults();
                        return;
                    } else if (data.status === 'failed') {
                        this.stopTerminal();
                        this.isAnalyzing = false;
                        alert('Analysis failed: ' + (data.error || 'Unknown error'));
                        return;
                    }

                    setTimeout(poll, 3000);
                } catch (err) {
                    setTimeout(poll, 3000);
                }
            };
            poll();
        },

        async completeWizard() {
            this.isCompleting = true;
            try {
                // Save ALL step data before completing to ensure nothing is lost
                for (let step = 1; step <= 7; step++) {
                    await fetch(`/api/v1/wizard/${this.sessionSlug}/step/${step}/`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken'),
                        },
                        body: JSON.stringify(this.stepData[step]),
                    });
                }

                // Save analysis selections (included/excluded violations and case law)
                await this.saveAnalysisSelections();

                const response = await fetch(`/api/v1/wizard/${this.sessionSlug}/complete/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                });
                const data = await response.json();
                if (data.success || data.already_completed) {
                    window.location.href = `/documents/${data.document_slug}/`;
                } else {
                    alert('Error building complaint: ' + (data.error || 'Unknown error'));
                    this.isCompleting = false;
                }
            } catch (err) {
                alert('Error building complaint. Please try again.');
                this.isCompleting = false;
            }
        },

        // --- Analysis selection methods ---

        initAnalysisDefaults() {
            // Set default included state based on strength: strong/moderate = included, weak/worth_including = excluded
            if (this.analysisData.violations) {
                for (const v of this.analysisData.violations) {
                    if (v.included === undefined) {
                        v.included = (v.strength === 'strong' || v.strength === 'moderate');
                    }
                }
            }
            if (this.analysisData.case_law) {
                for (const c of this.analysisData.case_law) {
                    if (c.included === undefined) {
                        c.included = true;
                    }
                }
            }
        },

        async saveAnalysisSelections() {
            if (!this.sessionSlug) return;
            try {
                await fetch(`/api/v1/wizard/${this.sessionSlug}/analysis-selections/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({
                        violations: (this.analysisData.violations || []).map((v, i) => ({ index: i, included: v.included !== false })),
                        case_law: (this.analysisData.case_law || []).map((c, i) => ({ index: i, included: c.included !== false })),
                    }),
                });
            } catch (err) {
                console.error('Error saving analysis selections:', err);
            }
        },

        // Violation explanation data
        violationExplanations: {
            'Fourth Amendment': {
                'Excessive Force': {
                    title: 'Excessive Force',
                    amendment: 'Fourth Amendment',
                    explanation: 'The Fourth Amendment protects against unreasonable seizures, which includes the use of excessive force by law enforcement during an arrest, investigatory stop, or other seizure of a person. Force is "excessive" when it is objectively unreasonable given the totality of the circumstances.',
                    elements: [
                        'A seizure occurred (arrest, stop, or physical restraint)',
                        'The officer used force during the seizure',
                        'The force was objectively unreasonable under the circumstances',
                        'The force caused injury or harm',
                    ],
                    significance: 'Excessive force is one of the most common Section 1983 claims. Courts use the "objective reasonableness" standard from Graham v. Connor, considering the severity of the crime, whether the suspect posed a threat, and whether the suspect was resisting.',
                },
                'Unreasonable Search': {
                    title: 'Unreasonable Search',
                    amendment: 'Fourth Amendment',
                    explanation: 'The Fourth Amendment protects against unreasonable searches of your person, home, vehicle, and belongings. Generally, police need a warrant based on probable cause to conduct a search, though several exceptions exist (consent, plain view, search incident to arrest, exigent circumstances).',
                    elements: [
                        'A search occurred (of your person, property, vehicle, or home)',
                        'The search was conducted by a government actor',
                        'No valid warrant was obtained, and no exception to the warrant requirement applied',
                        'You had a reasonable expectation of privacy in the area searched',
                    ],
                    significance: 'Warrantless searches are presumptively unreasonable. The burden falls on the government to prove an exception applies. Evidence obtained through an illegal search may also be suppressed in related criminal proceedings.',
                },
                'False Arrest': {
                    title: 'False Arrest / Arrest Without Probable Cause',
                    amendment: 'Fourth Amendment',
                    explanation: 'The Fourth Amendment requires that arrests be supported by probable cause â€” a reasonable belief, based on facts, that a person has committed or is committing a crime. An arrest without probable cause violates the Constitution.',
                    elements: [
                        'You were arrested or detained against your will',
                        'The arresting officer lacked probable cause',
                        'The arrest was not supported by a valid warrant',
                        'You suffered harm as a result (loss of liberty, emotional distress, etc.)',
                    ],
                    significance: 'False arrest claims are evaluated based on what the officer knew at the time of the arrest. If no reasonable officer would have believed probable cause existed, the arrest violates the Fourth Amendment.',
                },
                'Unreasonable Seizure': {
                    title: 'Unreasonable Seizure of Property',
                    amendment: 'Fourth Amendment',
                    explanation: 'The Fourth Amendment protects against unreasonable seizure of your property. This includes taking your phone, vehicle, money, or other possessions without legal justification.',
                    elements: [
                        'Your property was seized by a government actor',
                        'The seizure was without a warrant or legal justification',
                        'You had a possessory interest in the property',
                        'The seizure was unreasonable under the circumstances',
                    ],
                    significance: 'Property seizures without proper legal process can form the basis of a Section 1983 claim. This is especially relevant when police confiscate recording devices or other personal property.',
                },
            },
            'First Amendment': {
                'Freedom of Speech': {
                    title: 'Retaliation for Speech / Expression',
                    amendment: 'First Amendment',
                    explanation: 'The First Amendment protects your right to free speech and expression, including the right to criticize government officials. Officers cannot arrest, detain, or retaliate against you for exercising your right to speak.',
                    elements: [
                        'You engaged in constitutionally protected speech or expression',
                        'The government official took adverse action against you',
                        'Your protected speech was a substantial or motivating factor in the adverse action',
                        'The action would chill a person of ordinary firmness from continuing to engage in that activity',
                    ],
                    significance: 'First Amendment retaliation claims are powerful in Section 1983 cases. Even if an arrest was technically supported by probable cause, you may still have a claim if the true motivation was to punish you for your speech.',
                },
                'Freedom of Press': {
                    title: 'Right to Record / Freedom of Press',
                    amendment: 'First Amendment',
                    explanation: 'The First Amendment protects your right to record police officers performing their duties in public. Multiple federal courts have recognized this as a clearly established right. Officers cannot order you to stop recording, seize your device, or arrest you for filming.',
                    elements: [
                        'You were recording police activity in a public place',
                        'You were not interfering with police operations',
                        'An officer ordered you to stop, seized your device, or arrested you for recording',
                        'The officer\'s actions were motivated by your recording activity',
                    ],
                    significance: 'The right to record police is increasingly well-established across federal circuits. Courts recognize that recording officers is a form of speech and press activity that serves the public interest in government accountability.',
                },
                'Freedom of Assembly': {
                    title: 'Freedom of Assembly',
                    amendment: 'First Amendment',
                    explanation: 'The First Amendment protects your right to peacefully assemble, including the right to protest, demonstrate, and gather in public spaces. Government officials cannot disperse, arrest, or use force against peaceful assemblies without lawful justification.',
                    elements: [
                        'You were engaged in a peaceful assembly or protest',
                        'Government officials interfered with the assembly',
                        'The interference was not justified by a compelling government interest',
                        'The interference was not narrowly tailored to serve that interest',
                    ],
                    significance: 'Peaceful protest is among the most protected forms of First Amendment activity. Mass arrests of protesters, use of force to disperse peaceful demonstrations, and imposing unconstitutional conditions on assembly permits are common Section 1983 claims.',
                },
                'Right to Petition': {
                    title: 'Retaliation for Filing Complaints',
                    amendment: 'First Amendment',
                    explanation: 'The First Amendment\'s Petition Clause protects your right to file complaints against government officials, sue the government, or seek redress for grievances without fear of retaliation.',
                    elements: [
                        'You filed a complaint, lawsuit, or grievance against a government official',
                        'A government official took adverse action against you',
                        'The adverse action was motivated by your complaint or petition',
                        'The action would deter a reasonable person from exercising their right to petition',
                    ],
                    significance: 'Retaliation for filing complaints is a serious constitutional violation. If officers harass, arrest, or target you because you filed an internal affairs complaint or lawsuit, that itself is a separate Section 1983 claim.',
                },
            },
            'Fifth Amendment': {
                'Self-Incrimination': {
                    title: 'Coerced Self-Incrimination',
                    amendment: 'Fifth Amendment',
                    explanation: 'The Fifth Amendment protects your right against compelled self-incrimination. This includes the right to remain silent during police interrogation and the requirement that officers provide Miranda warnings before custodial interrogation.',
                    elements: [
                        'You were in custody or otherwise deprived of freedom in a significant way',
                        'You were subjected to interrogation',
                        'You were not advised of your Miranda rights (or your invocation of rights was not honored)',
                        'Statements were coerced through physical or psychological pressure',
                    ],
                    significance: 'While Miranda violations alone may not support a Section 1983 claim for damages, coerced confessions and the use of compelled statements against you in court proceedings can form the basis of a civil rights action.',
                },
                'Due Process': {
                    title: 'Due Process Violation (Fifth Amendment)',
                    amendment: 'Fifth Amendment',
                    explanation: 'The Fifth Amendment\'s Due Process Clause prohibits the federal government from depriving you of life, liberty, or property without due process of law. This includes both procedural protections (notice, hearing) and substantive protections against arbitrary government action.',
                    elements: [
                        'The government deprived you of life, liberty, or property',
                        'The deprivation was without adequate legal process',
                        'The government action was arbitrary or conscience-shocking',
                    ],
                    significance: 'Fifth Amendment due process applies to federal actors. For state and local officials, the Fourteenth Amendment\'s Due Process Clause provides equivalent protection and is more commonly invoked in Section 1983 cases.',
                },
            },
            'Fourteenth Amendment': {
                'Equal Protection': {
                    title: 'Discrimination / Equal Protection Violation',
                    amendment: 'Fourteenth Amendment',
                    explanation: 'The Fourteenth Amendment\'s Equal Protection Clause requires that government officials treat similarly situated people equally. Discrimination based on race, ethnicity, gender, religion, or other protected characteristics violates equal protection.',
                    elements: [
                        'You were treated differently from others who are similarly situated',
                        'The differential treatment was based on a protected characteristic (race, gender, etc.)',
                        'The government actor intended to discriminate',
                        'You suffered harm as a result of the discriminatory treatment',
                    ],
                    significance: 'Equal protection claims in Section 1983 cases often involve racial profiling, selective enforcement, and discriminatory policing practices. Statistical evidence of disparate treatment can help establish discriminatory intent.',
                },
                'Due Process': {
                    title: 'Due Process Violation (Fourteenth Amendment)',
                    amendment: 'Fourteenth Amendment',
                    explanation: 'The Fourteenth Amendment\'s Due Process Clause prohibits state and local officials from depriving you of life, liberty, or property without due process. This covers both procedural due process (fair procedures) and substantive due process (protection against arbitrary government action).',
                    elements: [
                        'A state or local government actor deprived you of life, liberty, or property',
                        'The deprivation was without adequate legal process (procedural), OR',
                        'The government conduct was so egregious it "shocks the conscience" (substantive)',
                    ],
                    significance: 'Substantive due process protects against government conduct that is arbitrary, conscience-shocking, or oppressive. This is often invoked for claims of deliberate indifference to serious medical needs, conditions of confinement, and abuse of government power.',
                },
                'Deliberate Indifference': {
                    title: 'Deliberate Indifference to Medical Needs',
                    amendment: 'Fourteenth Amendment',
                    explanation: 'When a person is in government custody (jail, prison, or police detention), officials have a constitutional duty to provide adequate medical care. Deliberately ignoring a serious medical need violates the Constitution.',
                    elements: [
                        'You were in government custody or control',
                        'You had a serious medical need',
                        'The official knew of and disregarded the serious medical need',
                        'The official\'s response was unreasonable given the circumstances',
                    ],
                    significance: 'Deliberate indifference claims require more than negligence â€” the official must have known of a substantial risk of serious harm and failed to act. This standard applies to pretrial detainees under the Fourteenth Amendment and convicted prisoners under the Eighth Amendment.',
                },
            },
        },

        showViolationExplanation(violation) {
            const amendment = violation.amendment || '';
            const violationType = violation.violation_type || '';

            // Try to find a matching explanation
            const amendmentData = this.violationExplanations[amendment];
            if (amendmentData) {
                // Try exact match first, then partial match
                let match = amendmentData[violationType];
                if (!match) {
                    // Search for partial keyword match
                    const typeWords = violationType.toLowerCase();
                    for (const [key, data] of Object.entries(amendmentData)) {
                        if (typeWords.includes(key.toLowerCase().split(' ')[0]) ||
                            key.toLowerCase().includes(typeWords.split(' ')[0])) {
                            match = data;
                            break;
                        }
                    }
                }
                if (!match) {
                    // Use first entry as fallback for the amendment
                    match = Object.values(amendmentData)[0];
                }
                if (match) {
                    this.violationModalData = match;
                    this.showingViolationModal = true;
                    return;
                }
            }

            // Generic fallback
            this.violationModalData = {
                title: violationType || 'Constitutional Violation',
                amendment: amendment,
                explanation: violation.description || 'This violation involves a potential breach of your constitutional rights under ' + amendment + '.',
                elements: ['The government actor violated your constitutional rights', 'You suffered harm as a result', 'The violation was committed under color of state law'],
                significance: 'Section 1983 allows individuals to sue state and local officials who violate their constitutional rights while acting under color of law. This applies to police officers, corrections officers, and other government employees.',
            };
            this.showingViolationModal = true;
        },

        // Voice input
        toggleVoiceInput(target) {
            if (this.isRecording) {
                this.recognition.stop();
                this.isRecording = false;
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return;

            this.recognition = new SpeechRecognition();
            this.recognition.continuous = true;
            this.recognition.interimResults = true;
            this.recognition.lang = 'en-US';

            this.recognition.onresult = (event) => {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }
                if (target === 'story') {
                    this.story = this.story + ' ' + transcript;
                }
            };

            this.recognition.onend = () => { this.isRecording = false; };
            this.recognition.start();
            this.isRecording = true;
        },
    };
}
</script>
{% endblock %}
